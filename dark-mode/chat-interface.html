<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#040d01">
  <meta name="description" content="AirAI - Advanced AI Chat Platform with Multiple Models">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="apple-touch-icon" href="../icons/icon-192x192.svg">
  <link rel="manifest" href="../manifest.json">
  <title>AirAI - Enhanced AI Chat Platform</title>
  
<style>
/* ========================================
   SECTION 1: CORE STYLES & ANIMATIONS
   ======================================== */

/* Reset & Base Styles */
html, body {
  margin: 0 !important;
  padding: 0 !important;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background-color: #040d01;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  font-size: 13px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Smooth Transitions */
* {
  transition-property: background-color, border-color, color, transform, opacity, box-shadow;
  transition-duration: 0.15s;
  transition-timing-function: ease-out;
}

/* Keyframe Animations */
@keyframes slideIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes blink {
  0%, 49% { opacity: 1; }
  50%, 100% { opacity: 0; }
}

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
  30% { transform: translateY(-6px); opacity: 1; }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes glow {
  0%, 100% { box-shadow: 0 6px 20px rgba(42, 74, 42, 0.4); }
  50% { box-shadow: 0 6px 30px rgba(42, 74, 42, 0.8); }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  75% { transform: translateX(6px); }
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

@keyframes highlightPulse {
  0%, 100% { background: rgba(168, 213, 168, 0.3); }
  50% { background: rgba(168, 213, 168, 0.5); }
}

@keyframes logSlideIn {
  from { opacity: 0; transform: translateX(-6px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes float {
  0%, 100% {
    transform: translateY(0) translateX(0) scale(1);
    opacity: 0;
  }
  10% { opacity: 0.3; }
  90% { opacity: 0.3; }
  100% {
    transform: translateY(-100vh) translateX(40px) scale(0.5);
    opacity: 0;
  }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes bounceIn {
  0% { opacity: 0; transform: scale(0.3); }
  50% { opacity: 1; transform: scale(1.05); }
  70% { transform: scale(0.9); }
  100% { transform: scale(1); }
}

@keyframes slideRight {
  from { opacity: 0; transform: translateX(-12px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes slideLeft {
  from { opacity: 0; transform: translateX(12px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

@keyframes scaleUp {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

@keyframes wiggle {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(-3deg); }
  75% { transform: rotate(3deg); }
}

/* Animated Background Particles */
.particles {
  position: absolute;
  width: 100%;
  height: 100%;
  overflow: hidden;
  z-index: 0;
}

.particle {
  position: absolute;
  background: rgba(168, 213, 168, 0.1);
  border-radius: 50%;
  animation: float 20s infinite;
}

/* Theme Variables */
:root {
  --bg-primary: #040d01;
  --bg-secondary: #0a0a0a;
  --bg-tertiary: #0f0f0f;
  --bg-chat: rgba(0, 0, 0, 0.3);
  --border-primary: #1a2e1a;
  --border-secondary: #2a4a2a;
  --border-accent: #3a5a3a;
  --text-primary: #b8d5b8;
  --text-secondary: #8ab88a;
  --text-accent: #a8d5a8;
  --text-muted: #6a8a6a;
  --accent-green: #2a4a2a;
  --accent-light: #c5e8c5;
  --error-bg: rgba(90, 48, 48, 0.3);
  --error-border: #5a3030;
  --error-text: #ffb3b3;
  --success-bg: rgba(48, 90, 48, 0.3);
  --success-border: #305a30;
  --success-text: #b3ffb3;
  --warning-bg: rgba(90, 78, 48, 0.3);
  --warning-border: #5a4e30;
  --warning-text: #ffcc88;
}

/* Light Theme */
body.light-theme {
  --bg-primary: #f5f7f5;
  --bg-secondary: #ffffff;
  --bg-tertiary: #eaf0ea;
  --bg-chat: rgba(255, 255, 255, 0.9);
  --border-primary: #d0ddd0;
  --border-secondary: #b0c8b0;
  --border-accent: #90a890;
  --text-primary: #1a2e1a;
  --text-secondary: #3a5a3a;
  --text-accent: #2a4a2a;
  --text-muted: #6a8a6a;
  --accent-green: #3a6a3a;
  --accent-light: #1a2e1a;
  --error-bg: rgba(220, 80, 80, 0.1);
  --error-border: #e0a0a0;
  --error-text: #c03030;
  --success-bg: rgba(48, 160, 48, 0.1);
  --success-border: #a0d0a0;
  --success-text: #208020;
  --warning-bg: rgba(200, 160, 40, 0.1);
  --warning-border: #d0c090;
  --warning-text: #906010;
}

body.light-theme .chat-header {
  background: rgba(245, 247, 245, 0.85);
  border-bottom-color: rgba(176, 200, 176, 0.4);
}

body.light-theme .chat-input-container {
  background: rgba(245, 247, 245, 0.85);
  border-top-color: rgba(176, 200, 176, 0.4);
}

body.light-theme .enhanced-chat-input {
  background: rgba(255, 255, 255, 0.8);
  border-color: rgba(176, 200, 176, 0.5);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

body.light-theme .enhanced-chat-input:focus-within {
  border-color: rgba(58, 106, 58, 0.5);
  box-shadow: 0 4px 16px rgba(58, 106, 58, 0.1);
}

body.light-theme .message.user .message-content {
  background-color: rgba(58, 106, 58, 0.12);
  color: #1a2e1a;
  border-color: rgba(58, 106, 58, 0.2);
}

body.light-theme .message.assistant .message-content {
  background-color: #ffffff;
  color: #2a3a2a;
  border-color: #d0ddd0;
}

body.light-theme .message.system .message-content {
  background: rgba(42, 74, 90, 0.08);
  color: #2a4a5a;
  border-color: #b0c8d8;
}

body.light-theme .auth-card {
  background: rgba(255, 255, 255, 0.97);
  border-color: #d0ddd0;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
}

body.light-theme .auth-input {
  background: #f5f7f5;
  border-color: #d0ddd0;
}

body.light-theme .auth-input:focus {
  background: #ffffff;
}

body.light-theme .sidebar {
  background: #ffffff;
  box-shadow: 4px 0 24px rgba(0, 0, 0, 0.08);
}

body.light-theme .sidebar-header {
  background: linear-gradient(135deg, #eaf0ea 0%, #f5f7f5 100%);
}

body.light-theme .history-item {
  background: #f5f7f5;
  border-color: #d0ddd0;
}

body.light-theme .history-item:hover {
  background: #eaf0ea;
}

body.light-theme .modal-content {
  background: #ffffff;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

body.light-theme .modal-overlay {
  background: rgba(0, 0, 0, 0.3);
}

body.light-theme pre {
  background: #f0f4f0;
  border-color: #d0ddd0;
}

body.light-theme code {
  background: rgba(58, 106, 58, 0.08);
  border-color: #d0ddd0;
}

body.light-theme .code-header {
  background: #eaf0ea;
}

body.light-theme .toolbar-btn {
  background: rgba(255, 255, 255, 0.6);
  border-color: #d0ddd0;
}

body.light-theme .toolbar-btn:hover {
  background: #eaf0ea;
}

body.light-theme .toggle-sidebar-btn,
body.light-theme .theme-toggle {
  background: linear-gradient(135deg, #3a6a3a 0%, #2a4a2a 100%);
  color: #e0f0e0;
  box-shadow: 0 4px 12px rgba(58, 106, 58, 0.25);
}

body.light-theme .send-button-enhanced {
  background: linear-gradient(135deg, #3a6a3a 0%, #2a4a2a 100%);
  color: #e0f0e0;
}

body.light-theme .scroll-to-bottom {
  background: rgba(255, 255, 255, 0.9);
  border-color: rgba(176, 200, 176, 0.5);
  color: #2a4a2a;
}

body.light-theme .chat-messages::-webkit-scrollbar-thumb {
  background: rgba(58, 106, 58, 0.2);
}

body.light-theme .chat-messages::-webkit-scrollbar-thumb:hover {
  background: rgba(58, 106, 58, 0.35);
}

body.light-theme .date-separator-text {
  background: rgba(255, 255, 255, 0.8);
  border-color: rgba(176, 200, 176, 0.4);
}

body.light-theme .date-separator-line {
  background: rgba(176, 200, 176, 0.5);
}

body.light-theme .typing-indicator {
  background-color: rgba(255, 255, 255, 0.7);
  border-color: rgba(176, 200, 176, 0.4);
}

body.light-theme .toast {
  background: #ffffff;
  box-shadow: 0 8px 28px rgba(0, 0, 0, 0.1);
}

body.light-theme .message-actions {
  background: #ffffff;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

body.light-theme .debug-console {
  background: #ffffff;
}

body.light-theme .debug-console-content {
  background: #f5f7f5;
}

body.light-theme .filter-chip {
  background: #f5f7f5;
}

body.light-theme .command-select {
  background: #ffffff;
}

body.light-theme .particle {
  background: rgba(58, 106, 58, 0.06);
}

body.light-theme .reaction {
  background: #f5f7f5;
}

/* ========================================
   COLOR THEMES
   ======================================== */

/* Blue Theme */
body.theme-blue {
  --bg-primary: #010a14;
  --bg-secondary: #0a0a12;
  --bg-tertiary: #0f0f18;
  --bg-chat: rgba(0, 0, 20, 0.3);
  --border-primary: #1a2040;
  --border-secondary: #2a3a60;
  --border-accent: #3a4a70;
  --text-primary: #b8c8e0;
  --text-secondary: #8aa0c8;
  --text-accent: #a0c0e8;
  --text-muted: #6080a0;
  --accent-green: #1a3060;
  --accent-light: #c0d8f0;
}

body.light-theme.theme-blue {
  --bg-primary: #f0f4fa;
  --bg-secondary: #ffffff;
  --bg-tertiary: #e8eef6;
  --border-primary: #c0d0e8;
  --border-secondary: #a0b8d8;
  --border-accent: #80a0c8;
  --text-primary: #1a2040;
  --text-secondary: #2a4070;
  --text-accent: #1a3060;
  --text-muted: #6080a0;
  --accent-green: #2a4580;
  --accent-light: #1a2040;
}

/* Purple Theme */
body.theme-purple {
  --bg-primary: #0a0410;
  --bg-secondary: #0c0a12;
  --bg-tertiary: #120f18;
  --bg-chat: rgba(10, 0, 20, 0.3);
  --border-primary: #2a1a40;
  --border-secondary: #3a2a5a;
  --border-accent: #4a3a6a;
  --text-primary: #d0b8e0;
  --text-secondary: #b08ac8;
  --text-accent: #c0a0e0;
  --text-muted: #8060a0;
  --accent-green: #2a1a50;
  --accent-light: #e0c8f0;
}

body.light-theme.theme-purple {
  --bg-primary: #f6f0fa;
  --bg-secondary: #ffffff;
  --bg-tertiary: #eee8f4;
  --border-primary: #d0c0e0;
  --border-secondary: #b8a0d0;
  --border-accent: #a088c0;
  --text-primary: #2a1a40;
  --text-secondary: #4a2a6a;
  --text-accent: #3a2050;
  --text-muted: #8060a0;
  --accent-green: #4a2a70;
  --accent-light: #2a1a40;
}

/* Rose Theme */
body.theme-rose {
  --bg-primary: #140108;
  --bg-secondary: #120a0c;
  --bg-tertiary: #180f12;
  --bg-chat: rgba(20, 0, 10, 0.3);
  --border-primary: #401a28;
  --border-secondary: #5a2a3a;
  --border-accent: #6a3a4a;
  --text-primary: #e0b8c8;
  --text-secondary: #c88aa0;
  --text-accent: #e0a0b8;
  --text-muted: #a06080;
  --accent-green: #501a30;
  --accent-light: #f0c8d8;
}

body.light-theme.theme-rose {
  --bg-primary: #faf0f4;
  --bg-secondary: #ffffff;
  --bg-tertiary: #f4e8ee;
  --border-primary: #e0c0d0;
  --border-secondary: #d0a0b8;
  --border-accent: #c088a0;
  --text-primary: #401a28;
  --text-secondary: #6a2a40;
  --text-accent: #501a30;
  --text-muted: #a06080;
  --accent-green: #702a45;
  --accent-light: #401a28;
}

/* Amber Theme */
body.theme-amber {
  --bg-primary: #140a01;
  --bg-secondary: #120c0a;
  --bg-tertiary: #181210;
  --bg-chat: rgba(20, 10, 0, 0.3);
  --border-primary: #402a1a;
  --border-secondary: #5a3a2a;
  --border-accent: #6a4a3a;
  --text-primary: #e0d0b8;
  --text-secondary: #c8a888;
  --text-accent: #e0c8a0;
  --text-muted: #a08860;
  --accent-green: #503a1a;
  --accent-light: #f0e0c8;
}

body.light-theme.theme-amber {
  --bg-primary: #faf6f0;
  --bg-secondary: #ffffff;
  --bg-tertiary: #f4eee8;
  --border-primary: #e0d0c0;
  --border-secondary: #d0b8a0;
  --border-accent: #c0a088;
  --text-primary: #402a1a;
  --text-secondary: #6a4a2a;
  --text-accent: #503a20;
  --text-muted: #a08860;
  --accent-green: #705020;
  --accent-light: #402a1a;
}

/* Teal Theme */
body.theme-teal {
  --bg-primary: #010e0e;
  --bg-secondary: #0a0e0e;
  --bg-tertiary: #0f1414;
  --bg-chat: rgba(0, 15, 15, 0.3);
  --border-primary: #1a3838;
  --border-secondary: #2a5050;
  --border-accent: #3a6060;
  --text-primary: #b8e0e0;
  --text-secondary: #80c0c0;
  --text-accent: #a0d8d8;
  --text-muted: #608888;
  --accent-green: #1a4848;
  --accent-light: #c8f0f0;
}

body.light-theme.theme-teal {
  --bg-primary: #f0fafa;
  --bg-secondary: #ffffff;
  --bg-tertiary: #e8f4f4;
  --border-primary: #c0e0e0;
  --border-secondary: #a0d0d0;
  --border-accent: #88c0c0;
  --text-primary: #1a3838;
  --text-secondary: #2a5050;
  --text-accent: #1a4040;
  --text-muted: #608888;
  --accent-green: #2a6060;
  --accent-light: #1a3838;
}

/* Color theme overrides for light-theme specific elements */
body.light-theme.theme-blue .toggle-sidebar-btn,
body.light-theme.theme-blue .theme-toggle,
body.light-theme.theme-blue .send-button-enhanced {
  background: linear-gradient(135deg, #2a4580 0%, #1a3060 100%);
  color: #d0e0f8;
}

body.light-theme.theme-purple .toggle-sidebar-btn,
body.light-theme.theme-purple .theme-toggle,
body.light-theme.theme-purple .send-button-enhanced {
  background: linear-gradient(135deg, #4a2a70 0%, #3a2050 100%);
  color: #e0d0f0;
}

body.light-theme.theme-rose .toggle-sidebar-btn,
body.light-theme.theme-rose .theme-toggle,
body.light-theme.theme-rose .send-button-enhanced {
  background: linear-gradient(135deg, #702a45 0%, #501a30 100%);
  color: #f0d0e0;
}

body.light-theme.theme-amber .toggle-sidebar-btn,
body.light-theme.theme-amber .theme-toggle,
body.light-theme.theme-amber .send-button-enhanced {
  background: linear-gradient(135deg, #705020 0%, #503a1a 100%);
  color: #f0e8d0;
}

body.light-theme.theme-teal .toggle-sidebar-btn,
body.light-theme.theme-teal .theme-toggle,
body.light-theme.theme-teal .send-button-enhanced {
  background: linear-gradient(135deg, #2a6060 0%, #1a4848 100%);
  color: #d0f0f0;
}

/* Light theme message bubble overrides for color themes */
body.light-theme.theme-blue .message.user .message-content {
  background-color: rgba(42, 69, 128, 0.1);
  border-color: rgba(42, 69, 128, 0.2);
}

body.light-theme.theme-purple .message.user .message-content {
  background-color: rgba(74, 42, 112, 0.1);
  border-color: rgba(74, 42, 112, 0.2);
}

body.light-theme.theme-rose .message.user .message-content {
  background-color: rgba(112, 42, 69, 0.1);
  border-color: rgba(112, 42, 69, 0.2);
}

body.light-theme.theme-amber .message.user .message-content {
  background-color: rgba(112, 80, 32, 0.1);
  border-color: rgba(112, 80, 32, 0.2);
}

body.light-theme.theme-teal .message.user .message-content {
  background-color: rgba(42, 96, 96, 0.1);
  border-color: rgba(42, 96, 96, 0.2);
}

/* Color theme swatch picker styles */
.color-theme-picker {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.color-swatch {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  border: 2.5px solid transparent;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.color-swatch:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.color-swatch.active {
  border-color: var(--text-accent);
  box-shadow: 0 0 0 3px rgba(168, 213, 168, 0.25);
}

.color-swatch.active::after {
  content: 'âœ“';
  color: white;
  font-size: 16px;
  font-weight: 700;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
}

.color-swatch-green { background: linear-gradient(135deg, #2a4a2a, #1a2e1a); }
.color-swatch-blue { background: linear-gradient(135deg, #2a3a60, #1a2040); }
.color-swatch-purple { background: linear-gradient(135deg, #3a2a5a, #2a1a40); }
.color-swatch-rose { background: linear-gradient(135deg, #5a2a3a, #401a28); }
.color-swatch-amber { background: linear-gradient(135deg, #5a3a2a, #402a1a); }
.color-swatch-teal { background: linear-gradient(135deg, #2a5050, #1a3838); }
.member-key-overlay,
.auth-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--bg-primary);
  z-index: 5000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.member-key-overlay.hidden,
.auth-overlay.hidden {
  display: none;
}

.modern-auth-container {
  position: relative;
  z-index: 10;
  width: 100%;
  max-width: 480px;
  padding: 20px;
}

.auth-card {
  background: rgba(15, 15, 15, 0.95);
  backdrop-filter: blur(20px);
  border: 1.5px solid var(--border-primary);
  border-radius: 24px;
  padding: 44px 38px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 80px rgba(42, 74, 42, 0.1);
  animation: slideUp 0.6s ease-out;
}

/* Logo */
.logo {
  text-align: center;
  margin-bottom: 35px;
}

.logo-icon {
  width: 70px;
  height: 70px;
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--border-primary) 100%);
  border-radius: 18px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 18px;
  box-shadow: 0 8px 30px rgba(42, 74, 42, 0.4);
  animation: glow 3s ease-in-out infinite;
}

.logo-icon svg {
  width: 38px;
  height: 38px;
  color: var(--text-accent);
}

.auth-title {
  font-size: 32px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--text-accent) 0%, var(--text-secondary) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
}

.auth-subtitle {
  color: var(--text-secondary);
  font-size: 14px;
  margin-bottom: 30px;
}

/* Auth Tabs */
.auth-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 25px;
  background: rgba(26, 46, 26, 0.3);
  padding: 6px;
  border-radius: 12px;
}

.auth-tab {
  flex: 1;
  padding: 12px;
  background: transparent;
  border: none;
  border-radius: 10px;
  color: var(--text-secondary);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.auth-tab.active {
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--border-primary) 100%);
  color: var(--text-accent);
  box-shadow: 0 4px 12px rgba(42, 74, 42, 0.3);
}

/* Auth Forms */
.auth-form {
  display: none;
}

.auth-form.active {
  display: block;
  animation: fadeIn 0.4s ease;
}

.input-group {
  margin-bottom: 18px;
  position: relative;
}

.input-label {
  display: block;
  color: var(--text-accent);
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.input-wrapper {
  position: relative;
}

.input-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  width: 18px;
  height: 18px;
  color: var(--text-muted);
  pointer-events: none;
}

.auth-input {
  width: 100%;
  padding: 13px 16px 13px 42px;
  background: rgba(10, 10, 10, 0.6);
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 14px;
  outline: none;
  transition: all 0.3s;
}

.auth-input:focus {
  border-color: var(--border-secondary);
  background: rgba(10, 10, 10, 0.9);
  box-shadow: 0 0 0 3px rgba(42, 74, 42, 0.1);
}

.auth-input::placeholder {
  color: var(--text-muted);
}

/* Auth Buttons */
.auth-button {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--border-primary) 100%);
  border: none;
  border-radius: 12px;
  color: var(--text-accent);
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.3s;
  box-shadow: 0 4px 16px rgba(42, 74, 42, 0.3);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.auth-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(42, 74, 42, 0.5);
  background: linear-gradient(135deg, var(--border-secondary) 0%, var(--accent-green) 100%);
}

.auth-button:active:not(:disabled) {
  transform: translateY(0);
}

.auth-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Divider */
.divider {
  display: flex;
  align-items: center;
  margin: 25px 0;
  gap: 14px;
}

.divider-line {
  flex: 1;
  height: 1px;
  background: var(--border-primary);
}

.divider-text {
  color: var(--text-muted);
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

/* Guest Button */
.guest-button {
  width: 100%;
  padding: 13px;
  background: transparent;
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.guest-button:hover {
  border-color: var(--border-secondary);
  background: rgba(42, 74, 42, 0.1);
  color: var(--text-accent);
}

.guest-button svg {
  width: 18px;
  height: 18px;
}

/* Error & Success Messages */
.error-message, .success-message, .info-message {
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 18px;
  font-size: 13px;
  display: none;
  animation: shake 0.5s;
}

.error-message {
  background: var(--error-bg);
  border: 2px solid var(--error-border);
  color: var(--error-text);
}

.success-message {
  background: var(--success-bg);
  border: 2px solid var(--success-border);
  color: var(--success-text);
}

.info-message {
  background: rgba(42, 74, 90, 0.3);
  border: 2px solid #2a4a5a;
  color: #b3d9ff;
}

.error-message.show, .success-message.show, .info-message.show {
  display: block;
}

/* Features List */
.features {
  margin-top: 25px;
  padding-top: 25px;
  border-top: 2px solid var(--border-primary);
}

.feature-item {
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--text-secondary);
  font-size: 13px;
  margin-bottom: 12px;
}

.feature-icon {
  width: 26px;
  height: 26px;
  background: rgba(42, 74, 42, 0.2);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-accent);
  flex-shrink: 0;
}

.feature-icon svg {
  width: 14px;
  height: 14px;
}
/* Chat Container */
.chat-container {
  width: 100%;
  max-width: 100%;
  height: 100vh;
  background-image: url("https://i0.wp.com/picjumbo.com/wp-content/uploads/green-natural-background-with-wooden-surface-free-image.jpeg?w=2210&quality=90");
  background-size: 120%;
  background-position: center;
  background-repeat: no-repeat;
  background-color: rgba(0, 0, 0, 0.4);
  background-blend-mode: darken;
  border-radius: 0;
  box-shadow: none;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}

body.light-theme .chat-container {
  background-color: rgba(255, 255, 255, 0.7);
  background-blend-mode: lighten;
}

/* Network Status Indicator */
.network-status {
  position: fixed;
  top: 8px;
  right: 8px;
  padding: 6px 12px;
  background: var(--error-bg);
  border: 2px solid var(--error-border);
  border-radius: 8px;
  color: var(--error-text);
  font-size: 11px;
  z-index: 9999;
  display: none;
  align-items: center;
  gap: 6px;
  animation: slideDown 0.3s ease;
}

.network-status.online {
  background: var(--success-bg);
  border-color: var(--success-border);
  color: var(--success-text);
}

.network-status.show {
  display: flex;
}

.network-status-icon {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: currentColor;
  animation: pulse 2s infinite;
}

/* Header */
.chat-header {
  background: rgba(4, 13, 1, 0.6);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  color: var(--text-accent);
  padding: 14px 20px;
  text-align: center;
  position: relative;
  border-bottom: 1px solid rgba(26, 46, 26, 0.3);
}

.header-title {
  font-size: 16px;
  font-weight: 600;
  margin: 0;
  letter-spacing: 0.3px;
}

.header-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 14px;
  flex-wrap: wrap;
}

/* Theme Toggle */
.theme-toggle {
  position: fixed;
  top: 18px;
  right: 70px;
  width: 42px;
  height: 42px;
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--border-secondary) 100%);
  border: none;
  border-radius: 10px;
  color: var(--text-accent);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  z-index: 1500;
  transition: all 0.3s;
}

.theme-toggle:hover {
  transform: scale(1.05) rotate(12deg);
}

/* AI Selector */
.ai-selector {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.ai-selector label {
  font-size: 15px;
  color: var(--text-secondary);
}

.ai-select {
  padding: 8px 16px;
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  background: var(--bg-tertiary);
  color: var(--text-accent);
  font-size: 14px;
  cursor: pointer;
  outline: none;
  transition: all 0.3s;
}

.ai-select:hover {
  border-color: var(--border-secondary);
  background: var(--bg-secondary);
}

.ai-select:focus {
  border-color: var(--border-secondary);
  box-shadow: 0 0 0 3px rgba(42, 74, 42, 0.2);
}

/* Messages Area */
.chat-messages {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 28px 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: transparent;
  scroll-behavior: smooth;
}

.chat-messages::-webkit-scrollbar {
  width: 8px;
}

.chat-messages::-webkit-scrollbar-track {
  background: transparent;
  border-radius: 4px;
  margin: 8px;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: rgba(42, 74, 42, 0.3);
  border-radius: 4px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: rgba(42, 74, 42, 0.5);
}

/* Scroll to Bottom Button */
.scroll-to-bottom {
  position: fixed;
  bottom: 105px;
  right: 28px;
  width: 38px;
  height: 38px;
  background: rgba(15, 15, 15, 0.85);
  backdrop-filter: blur(8px);
  border: 1.5px solid rgba(42, 74, 42, 0.4);
  border-radius: 50%;
  color: var(--text-accent);
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  transition: all 0.3s;
  animation: bounceIn 0.5s ease;
}

.scroll-to-bottom.show {
  display: flex;
}

.scroll-to-bottom:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 24px rgba(42, 74, 42, 0.4);
  background: rgba(42, 74, 42, 0.5);
}

.scroll-to-bottom svg {
  width: 18px;
  height: 18px;
}

/* Date Separator */
.date-separator {
  display: flex;
  align-items: center;
  gap: 16px;
  margin: 20px 0;
}

.date-separator-line {
  flex: 1;
  height: 1px;
  background: rgba(26, 46, 26, 0.3);
}

.date-separator-text {
  color: var(--text-muted);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  padding: 4px 14px;
  background: rgba(15, 15, 15, 0.6);
  border-radius: 20px;
  border: 1px solid rgba(26, 46, 26, 0.3);
  letter-spacing: 0.5px;
}
/* Messages */
.message {
  display: flex;
  gap: 10px;
  margin: 4px 0;
  animation: slideIn 0.3s ease;
  position: relative;
  transition: all 0.2s ease;
  max-width: 80%;
}

.message:hover {
  transform: translateX(2px);
}

.message.user {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.message.user:hover {
  transform: translateX(-2px);
}

.message.system {
  align-self: center;
  max-width: 70%;
  opacity: 0.8;
}

.message.pinned {
  background: rgba(168, 213, 168, 0.05);
  padding: 8px;
  border-radius: 14px;
  border: 2px solid var(--border-primary);
}

.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  flex-shrink: 0;
  font-size: 12px;
  margin-top: 2px;
  position: relative;
}

.message.user .message-avatar {
  background: linear-gradient(135deg, var(--border-primary) 0%, var(--bg-tertiary) 100%);
  color: var(--text-accent);
}

.message.assistant .message-avatar {
  background: linear-gradient(135deg, #243824 0%, #1a2e1a 100%);
  color: #a8d5a8;
}

.message.system .message-avatar {
  background: linear-gradient(135deg, #2a4a5a 0%, #1a3a4a 100%);
  color: #b3d9ff;
}

/* Avatar Status Indicator */
.avatar-status {
  position: absolute;
  bottom: 0px;
  right: 0px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #4a7c4a;
  border: 2px solid var(--bg-primary);
  animation: pulse 2s infinite;
}

.message-content {
  padding: 12px 16px;
  border-radius: 18px;
  line-height: 1.65;
  word-wrap: break-word;
  font-size: var(--chat-font-size, 14.5px);
  white-space: pre-wrap;
}

.message.user .message-content {
  background-color: rgba(15, 40, 15, 0.7);
  color: var(--accent-light);
  border-radius: 16px 16px 4px 16px;
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(50, 80, 50, 0.25);
}

.message.assistant .message-content {
  background-color: rgba(0, 0, 0, 0.3);
  color: #b8d5b8;
  border: 2px solid rgba(0, 0, 0, 0.2);
  border-radius: 18px 18px 18px 4px;
}

.message.system .message-content {
  background: rgba(42, 74, 90, 0.2);
  color: #b3d9ff;
  border: 1px solid #2a4a5a;
  text-align: center;
  font-style: italic;
  border-radius: 12px;
}

/* Message Timestamp */
.message-timestamp {
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 3px;
  display: none;
  opacity: 0.7;
}

/* Message Edited Indicator */
.message-edited {
  font-size: 10px;
  color: var(--text-muted);
  font-style: italic;
  margin-left: 6px;
}

/* Typing Indicator */
.cursor-blink {
  display: inline-block;
  width: 2px;
  height: 1em;
  background-color: #4a7c4a;
  margin-left: 2px;
  animation: blink 0.8s infinite;
  vertical-align: text-bottom;
}

.typing-indicator {
  display: none;
  padding: 12px 16px;
  background-color: rgba(0, 0, 0, 0.25);
  border-radius: 18px 18px 18px 4px;
  gap: 7px;
  border: 1.5px solid rgba(26, 46, 26, 0.3);
  margin-left: 42px;
  align-items: center;
  width: fit-content;
}

.typing-indicator.active {
  display: flex;
  animation: slideIn 0.3s ease;
}

.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #4a7c4a;
  animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
  animation-delay: 0.4s;
}

/* Loading Skeleton */
.message-skeleton {
  display: flex;
  gap: 16px;
  max-width: 85%;
  animation: slideIn 0.3s ease;
}

.skeleton-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: linear-gradient(90deg, var(--border-primary) 25%, var(--border-secondary) 50%, var(--border-primary) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}

.skeleton-content {
  flex: 1;
  padding: 16px 18px;
  border-radius: 18px 18px 18px 4px;
  background: var(--bg-chat);
  border: 2px solid rgba(0, 0, 0, 0.2);
}

.skeleton-line {
  height: 12px;
  background: linear-gradient(90deg, var(--border-primary) 25%, var(--border-secondary) 50%, var(--border-primary) 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 4px;
  margin-bottom: 10px;
}

.skeleton-line:last-child {
  width: 60%;
  margin-bottom: 0;
}

/* Search Highlight */
.search-highlight {
  background: rgba(168, 213, 168, 0.3);
  padding: 2px 4px;
  border-radius: 3px;
  animation: highlightPulse 0.5s ease;
}

/* Message Pin Indicator */
.pin-indicator {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 20px;
  height: 20px;
  background: #ffaa44;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 6px rgba(255, 170, 68, 0.4);
}

.pin-indicator svg {
  width: 12px;
  height: 12px;
  color: #ffffff;
}

/* Message Thread Indicator */
.thread-indicator {
  margin-top: 6px;
  padding: 6px 10px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 8px;
  font-size: 11px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.thread-indicator:hover {
  background: var(--border-primary);
  color: var(--text-accent);
}

.thread-indicator svg {
  width: 12px;
  height: 12px;
}
/* Message Actions */
.message-actions {
  position: absolute;
  top: -14px;
  right: 18px;
  display: none;
  gap: 4px;
  background: var(--bg-tertiary);
  border: 1.5px solid var(--border-primary);
  border-radius: 10px;
  padding: 4px 6px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.35);
  z-index: 10;
  animation: slideDown 0.2s ease;
}

.message:hover .message-actions {
  display: flex;
}

.msg-action {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: transparent;
  border: none;
  border-radius: 6px;
  color: var(--text-secondary);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.msg-action:hover {
  background: var(--border-primary);
  color: var(--text-accent);
}

.msg-action svg {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

.msg-action.active {
  color: var(--text-accent);
  background: var(--border-primary);
}

.msg-action.pinned {
  color: #ffaa44;
}

/* Message Reactions */
.message-reactions {
  display: flex;
  gap: 5px;
  margin-top: 6px;
  flex-wrap: wrap;
}

.reaction {
  display: flex;
  align-items: center;
  gap: 3px;
  padding: 3px 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 10px;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
}

.reaction:hover {
  background: var(--border-primary);
  transform: scale(1.05);
}

.reaction.active {
  background: var(--border-secondary);
  border-color: var(--border-accent);
}

.reaction-emoji {
  font-size: 13px;
}

.reaction-count {
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 10px;
}

.add-reaction {
  padding: 3px 6px;
  background: transparent;
  border: 1px dashed var(--border-primary);
  color: var(--text-muted);
}

/* Reaction Picker */
.reaction-picker {
  position: absolute;
  bottom: 100%;
  left: 0;
  margin-bottom: 8px;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  padding: 10px;
  display: none;
  gap: 6px;
  flex-wrap: wrap;
  max-width: 250px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  animation: bounceIn 0.3s ease;
}

.reaction-picker.show {
  display: flex;
}

.reaction-option {
  font-size: 20px;
  padding: 6px;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
  background: transparent;
  border: none;
}

.reaction-option:hover {
  background: var(--border-primary);
  transform: scale(1.2);
}

/* Message Edit Mode */
.message-edit-mode {
  position: relative;
}

.message-edit-input {
  width: 100%;
  min-height: 60px;
  padding: 12px;
  background: var(--bg-secondary);
  border: 2px solid var(--border-secondary);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 14px;
  font-family: inherit;
  resize: vertical;
  outline: none;
}

.message-edit-input:focus {
  border-color: var(--border-accent);
  box-shadow: 0 0 0 3px rgba(42, 74, 42, 0.2);
}

.message-edit-actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  justify-content: flex-end;
}

.edit-action-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.edit-save {
  background: var(--border-secondary);
  color: var(--text-accent);
}

.edit-save:hover {
  background: var(--border-accent);
  transform: translateY(-2px);
}

.edit-cancel {
  background: var(--bg-secondary);
  color: var(--text-secondary);
  border: 1px solid var(--border-primary);
}

.edit-cancel:hover {
  background: var(--bg-tertiary);
}

/* Message Version History */
.message-versions {
  margin-top: 10px;
  padding: 10px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 8px;
  font-size: 11px;
}

.version-item {
  padding: 6px;
  border-bottom: 1px solid var(--border-primary);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.version-item:last-child {
  border-bottom: none;
}

.version-item:hover {
  background: var(--bg-tertiary);
  color: var(--text-accent);
}

.version-time {
  font-size: 10px;
  color: var(--text-muted);
}

/* Token Counter in Message */
.message-tokens {
  position: absolute;
  bottom: 6px;
  right: 6px;
  font-size: 9px;
  color: var(--text-muted);
  background: var(--bg-secondary);
  padding: 3px 6px;
  border-radius: 4px;
  border: 1px solid var(--border-primary);
  opacity: 0;
  transition: opacity 0.2s;
}

.message:hover .message-tokens {
  opacity: 1;
}

/* Message Metadata */
.message-metadata {
  display: none;
  gap: 10px;
  align-items: center;
  margin-top: 6px;
  font-size: 10px;
  color: var(--text-muted);
}

.metadata-item {
  display: flex;
  align-items: center;
  gap: 3px;
}

.metadata-item svg {
  width: 12px;
  height: 12px;
}

/* Model Badge */
.model-badge {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  padding: 3px 6px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 6px;
  font-size: 9px;
  font-weight: 600;
  color: var(--text-accent);
  text-transform: uppercase;
}

.model-badge svg {
  width: 10px;
  height: 10px;
}

/* Response Time Indicator */
.response-time {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  color: var(--text-muted);
  font-size: 9px;
}

.response-time.fast {
  color: var(--success-text);
}

.response-time.slow {
  color: var(--warning-text);
}

/* Message Context Menu */
.message-context-menu {
  position: absolute;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 10px;
  padding: 6px;
  min-width: 150px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: none;
  animation: bounceIn 0.2s ease;
}

.message-context-menu.show {
  display: block;
}

.context-menu-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border-radius: 6px;
  color: var(--text-secondary);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  background: transparent;
  width: 100%;
  text-align: left;
}

.context-menu-item:hover {
  background: var(--border-primary);
  color: var(--text-accent);
}

.context-menu-item svg {
  width: 13px;
  height: 13px;
}

.context-menu-divider {
  height: 1px;
  background: var(--border-primary);
  margin: 4px 0;
}
/* Chat Input Container */
.chat-input-container {
  padding: 16px 20px 20px;
  background: rgba(4, 13, 1, 0.6);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  position: relative;
  border-top: 1px solid rgba(26, 46, 26, 0.3);
}

.enhanced-input-wrapper {
  max-width: 1000px;
  margin: 0 auto;
  position: relative;
}

.enhanced-chat-input {
  display: flex;
  flex-direction: column;
  background: rgba(15, 15, 15, 0.6);
  border: 1.5px solid rgba(26, 46, 26, 0.4);
  border-radius: 18px;
  transition: all 0.3s;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
}

.enhanced-chat-input:hover,
.enhanced-chat-input:focus-within {
  border-color: rgba(42, 74, 42, 0.5);
  box-shadow: 0 4px 20px rgba(42, 74, 42, 0.12);
}

.input-content-area {
  padding: 16px 20px;
  position: relative;
}

.editable-input {
  max-height: 200px;
  width: 100%;
  overflow-y: auto;
  font-size: 15px;
  line-height: 1.5;
  color: var(--text-primary);
  outline: none;
  min-height: 24px;
  background: transparent;
}

.tiptap {
  outline: none !important;
}

[data-placeholder]:empty:before {
  content: attr(data-placeholder);
  color: var(--text-muted);
  pointer-events: none;
}

.font-large {
  font-size: 16px;
}

/* File Preview Container */
.file-preview-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 12px 16px;
  background: rgba(10, 10, 10, 0.3);
  border-bottom: 1px solid rgba(26, 46, 26, 0.2);
}

.file-preview {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 8px;
  padding: 8px 12px;
  max-width: 200px;
  animation: slideIn 0.3s ease;
}

.file-preview-icon {
  width: 22px;
  height: 22px;
  color: var(--text-secondary);
  flex-shrink: 0;
}

.file-preview-info {
  flex: 1;
  min-width: 0;
}

.file-preview-name {
  font-size: 12px;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.file-preview-size {
  font-size: 10px;
  color: var(--text-muted);
}

.file-preview-remove {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: all 0.2s;
}

.file-preview-remove:hover {
  background: var(--border-primary);
  color: var(--error-text);
}

.file-preview-remove svg {
  width: 14px;
  height: 14px;
}

/* Character Counter */
.char-counter {
  position: absolute;
  bottom: 8px;
  right: 16px;
  font-size: 10px;
  color: var(--text-muted);
  background: rgba(10, 10, 10, 0.7);
  padding: 3px 8px;
  border-radius: 6px;
  border: 1px solid var(--border-primary);
  pointer-events: none;
}

/* Markdown Toolbar */
.markdown-toolbar {
  display: flex;
  gap: 3px;
  padding: 6px 10px;
  background: rgba(10, 10, 10, 0.3);
  border-bottom: 1px solid rgba(26, 46, 26, 0.2);
}

.md-btn {
  width: 28px;
  height: 28px;
  border: none;
  border-radius: 5px;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  font-weight: 600;
  font-size: 12px;
}

.md-btn:hover {
  background: var(--border-primary);
  color: var(--text-accent);
}

.md-btn.active {
  background: var(--border-secondary);
  color: var(--text-accent);
}

.md-btn svg {
  width: 13px;
  height: 13px;
}

/* Draft Save Indicator */
.draft-indicator {
  position: absolute;
  top: -8px;
  left: 50%;
  transform: translateX(-50%);
  padding: 3px 10px;
  background: var(--success-bg);
  border: 1px solid var(--success-border);
  color: var(--success-text);
  font-size: 10px;
  border-radius: 6px;
  display: none;
  animation: slideDown 0.3s ease;
}

.draft-indicator.show {
  display: block;
}

/* Prompt Suggestions */
.prompt-suggestions {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 0;
  right: 0;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  padding: 10px;
  display: none;
  flex-direction: column;
  gap: 6px;
  max-height: 250px;
  overflow-y: auto;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
  z-index: 100;
  animation: slideUp 0.3s ease;
}

.prompt-suggestions.show {
  display: flex;
}

.suggestion-item {
  padding: 10px 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 8px;
  color: var(--text-primary);
  cursor: pointer;
  transition: all 0.2s;
  font-size: 13px;
}

.suggestion-item:hover {
  background: var(--border-primary);
  color: var(--text-accent);
  transform: translateX(4px);
}

.suggestion-category {
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  font-weight: 600;
  margin-top: 6px;
  margin-bottom: 3px;
}
/* Input Toolbar */
.input-toolbar {
  display: flex;
  gap: 10px;
  padding: 10px 16px 12px;
  align-items: center;
  position: relative;
  background: transparent;
  border-top: 1px solid rgba(26, 46, 26, 0.15);
}

.toolbar-left {
  flex: 1;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.toolbar-right {
  display: flex;
  gap: 8px;
  align-items: center;
}

/* Toolbar Buttons */
.toolbar-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 8px 12px;
  border: 2px solid var(--border-primary);
  border-radius: 10px;
  background: rgba(10, 10, 10, 0.5);
  color: var(--text-secondary);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.toolbar-btn:hover {
  background: var(--border-primary);
  color: var(--text-accent);
  border-color: var(--border-secondary);
}

.toolbar-btn svg {
  width: 14px;
  height: 14px;
}

.toolbar-btn.active {
  background: var(--border-secondary);
  color: var(--text-accent);
  border-color: var(--border-accent);
}

/* Command Select */
.command-select {
  padding: 8px 14px;
  border: 2px solid var(--border-primary);
  border-radius: 10px;
  background: rgba(10, 10, 10, 0.9);
  color: var(--text-secondary);
  font-size: 13px;
  cursor: pointer;
  outline: none;
  transition: all 0.2s;
}

.command-select:hover {
  background: var(--bg-secondary);
  border-color: var(--border-secondary);
}

.command-select:focus {
  border-color: var(--border-accent);
  box-shadow: 0 0 0 3px rgba(42, 74, 42, 0.2);
}

/* Send Button */
.send-button-enhanced {
  width: 42px;
  height: 42px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--border-primary) 100%);
  color: var(--text-accent);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.send-button-enhanced svg {
  width: 16px;
  height: 16px;
}

.send-button-enhanced:hover:not(:disabled) {
  transform: scale(1.05);
  background: linear-gradient(135deg, #2f552f 0%, #1f381f 100%);
  box-shadow: 0 4px 12px rgba(42, 74, 42, 0.4);
}

.send-button-enhanced:active:not(:disabled) {
  transform: scale(0.95);
}

.send-button-enhanced:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* Voice Input Button */
.voice-input-btn {
  width: 40px;
  height: 40px;
  border: 2px solid var(--border-primary);
  border-radius: 10px;
  background: rgba(10, 10, 10, 0.5);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.voice-input-btn:hover {
  background: var(--border-primary);
  color: var(--text-accent);
}

.voice-input-btn.recording {
  background: var(--error-bg);
  border-color: var(--error-border);
  color: var(--error-text);
  animation: pulse 1.5s infinite;
}

.voice-input-btn svg {
  width: 16px;
  height: 16px;
}

/* File Upload Button */
.file-upload-btn {
  width: 38px;
  height: 38px;
  border: 2px solid var(--border-primary);
  border-radius: 10px;
  background: rgba(10, 10, 10, 0.5);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.file-upload-btn:hover {
  background: var(--border-primary);
  color: var(--text-accent);
}

.file-upload-btn input[type="file"] {
  position: absolute;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.file-upload-btn svg {
  width: 16px;
  height: 16px;
}

/* Token Counter */
.token-counter {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  color: var(--text-muted);
  padding: 5px 10px;
  background: rgba(10, 10, 10, 0.5);
  border-radius: 8px;
  border: 1px solid var(--border-primary);
}
/* Model Control Panel Styles */
.model-control-panel {
  max-height: 600px;
  overflow-y: auto;
}

.control-section {
  margin-bottom: 20px;
}

.control-section-header h3 {
  color: var(--text-accent);
  font-size: 16px;
  margin-bottom: 5px;
}

.control-section-header p {
  color: var(--text-secondary);
  font-size: 12px;
  margin-bottom: 15px;
}

.staff-lock-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: var(--warning-bg);
  border: 2px solid var(--warning-border);
  border-radius: 12px;
}

.model-control-grid {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.model-group {
  margin-bottom: 20px;
}

.model-group h4 {
  color: var(--text-accent);
  font-size: 14px;
  margin-bottom: 10px;
  padding-bottom: 5px;
  border-bottom: 1px solid var(--border-primary);
}

.model-control-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: var(--bg-secondary);
  border: 2px solid var(--border-primary);
  border-radius: 10px;
  transition: all 0.2s;
}

.model-control-row:hover {
  border-color: var(--border-secondary);
  background: var(--bg-tertiary);
}

.model-control-info {
  flex: 1;
}

.model-control-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 3px;
}

.model-control-id {
  font-size: 11px;
  color: var(--text-muted);
  font-family: monospace;
}

.model-control-toggles {
  display: flex;
  gap: 20px;
  align-items: center;
}

.model-control-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--text-secondary);
}

/* Disabled Model Styles in Select */
.ai-select option.model-disabled {
  color: var(--text-muted) !important;
  font-style: italic;
  opacity: 0.5;
}

.ai-select option.model-staff-only {
  color: var(--warning-text) !important;
  font-weight: 600;
}

/* Light theme adjustments */
body.light-theme .ai-select option.model-disabled {
  opacity: 0.4;
}
.token-counter svg {
  width: 12px;
  height: 12px;
}

.token-counter.warning {
  color: var(--warning-text);
  border-color: var(--warning-border);
}

.token-counter.error {
  color: var(--error-text);
  border-color: var(--error-border);
  animation: pulse 2s infinite;
}

/* Slash Command Menu */
.slash-command-menu {
  position: absolute;
  bottom: 100%;
  left: 0;
  margin-bottom: 8px;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  padding: 8px;
  min-width: 200px;
  max-height: 300px;
  overflow-y: auto;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: none;
}

.slash-command-menu.active {
  display: block;
  animation: slideUp 0.2s ease;
}

.slash-command {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.slash-command:hover,
.slash-command.selected {
  background: var(--border-primary);
}

.slash-command-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-accent);
}

.slash-command-desc {
  font-size: 11px;
  color: var(--text-secondary);
}
/* Sidebar */
.sidebar {
  position: fixed;
  left: -350px;
  top: 0;
  width: 350px;
  height: 100vh;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border-primary);
  transition: left 0.3s ease;
  z-index: 2000;
  display: flex;
  flex-direction: column;
  box-shadow: 4px 0 24px rgba(0, 0, 0, 0.4);
}

.sidebar.open {
  left: 0;
}

.sidebar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1999;
  display: none;
  backdrop-filter: blur(2px);
}

.sidebar-overlay.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

/* Sidebar Header */
.sidebar-header {
  padding: 24px;
  border-bottom: 2px solid var(--border-primary);
  background: linear-gradient(135deg, var(--border-primary) 0%, var(--bg-tertiary) 100%);
}

.sidebar-title {
  color: var(--text-accent);
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-title svg {
  width: 22px;
  height: 22px;
}

.sidebar-user {
  color: var(--text-secondary);
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.user-avatar-small {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--border-secondary) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 600;
  color: var(--text-accent);
}

/* Sidebar Search */
.sidebar-search {
  padding: 16px;
  border-bottom: 2px solid var(--border-primary);
}

.search-input {
  width: 100%;
  padding: 10px 14px 10px 36px;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 13px;
  outline: none;
  transition: all 0.2s;
}

.search-input:focus {
  border-color: var(--border-secondary);
  box-shadow: 0 0 0 3px rgba(42, 74, 42, 0.1);
}

.search-input-wrapper {
  position: relative;
}

.search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 14px;
  height: 14px;
  color: var(--text-muted);
  pointer-events: none;
}

/* Sidebar Filters */
.sidebar-filters {
  display: flex;
  gap: 6px;
  padding: 12px 16px;
  border-bottom: 2px solid var(--border-primary);
  overflow-x: auto;
}

.filter-chip {
  padding: 6px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-primary);
  border-radius: 16px;
  color: var(--text-secondary);
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 5px;
}

.filter-chip:hover {
  background: var(--border-primary);
  color: var(--text-accent);
}

.filter-chip.active {
  background: var(--border-secondary);
  color: var(--text-accent);
  border-color: var(--border-accent);
}

.filter-chip svg {
  width: 12px;
  height: 12px;
}

/* Sidebar Content */
.sidebar-content {
  flex: 1;
  overflow-y: auto;
  padding: 16px 18px;
}

.sidebar-content::-webkit-scrollbar {
  width: 6px;
}

.sidebar-content::-webkit-scrollbar-track {
  background: var(--bg-tertiary);
}

.sidebar-content::-webkit-scrollbar-thumb {
  background: var(--border-primary);
  border-radius: 3px;
}

.sidebar-content::-webkit-scrollbar-thumb:hover {
  background: var(--border-secondary);
}

/* Sidebar Section */
.sidebar-section {
  margin-bottom: 20px;
}

.sidebar-section-title {
  color: var(--text-muted);
  font-size: 11px;
  text-transform: uppercase;
  font-weight: 600;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
  padding: 0 3px;
}

/* Toggle Sidebar Button */
.toggle-sidebar-btn {
  position: fixed;
  left: 18px;
  top: 18px;
  width: 42px;
  height: 42px;
  border: none;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--border-primary) 100%);
  color: var(--text-accent);
  cursor: pointer;
  transition: all 0.2s;
  z-index: 1500;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

.toggle-sidebar-btn:hover {
  background: linear-gradient(135deg, #2f552f 0%, #1f381f 100%);
  transform: scale(1.05);
}

/* No History Message */
.no-history {
  text-align: center;
  color: var(--text-muted);
  font-size: 14px;
  padding: 40px 20px;
}

.no-history svg {
  width: 48px;
  height: 48px;
  margin-bottom: 12px;
  opacity: 0.5;
}
/* History Item */
.history-item {
  background: var(--bg-tertiary);
  border: 1.5px solid var(--border-primary);
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  animation: slideIn 0.3s ease;
}

.history-item:hover {
  border-color: var(--border-secondary);
  background: var(--bg-secondary);
  transform: translateX(3px);
}

.history-item.active {
  border-color: var(--border-accent);
  background: var(--border-primary);
}

.history-item-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 6px;
}

.history-item-title {
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 6px;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.history-item-favorite {
  width: 20px;
  height: 20px;
  background: transparent;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}

.history-item-favorite:hover {
  color: #ffaa44;
  transform: scale(1.2);
}

.history-item-favorite.active {
  color: #ffaa44;
}

.history-item-favorite svg {
  width: 14px;
  height: 14px;
}

.history-item-date {
  color: var(--text-muted);
  font-size: 12px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.history-item-date svg {
  width: 11px;
  height: 11px;
}

.history-item-preview {
  color: var(--text-secondary);
  font-size: 11px;
  margin-bottom: 10px;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
  line-height: 1.4;
}

.history-item-meta {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.history-meta-badge {
  padding: 3px 6px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: 5px;
  font-size: 9px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 3px;
}

.history-meta-badge svg {
  width: 10px;
  height: 10px;
}

/* History Item Tags */
.history-item-tags {
  display: flex;
  gap: 5px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.history-tag {
  padding: 3px 8px;
  background: rgba(42, 74, 42, 0.2);
  border: 1px solid var(--border-primary);
  border-radius: 10px;
  font-size: 9px;
  color: var(--text-accent);
  font-weight: 600;
}

/* History Item Actions */
.history-item-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.history-btn {
  padding: 6px 12px;
  border: 2px solid var(--border-primary);
  border-radius: 8px;
  background: var(--bg-secondary);
  color: var(--text-secondary);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
}

.history-btn:hover {
  background: var(--border-primary);
  color: var(--text-accent);
  border-color: var(--border-secondary);
}

.history-btn svg {
  width: 13px;
  height: 13px;
}

.history-btn.delete {
  color: var(--error-text);
  border-color: var(--error-border);
}

.history-btn.delete:hover {
  background: var(--error-bg);
  color: var(--error-text);
}

.history-btn.copy {
  color: #88c8ff;
  border-color: #1f3a5a;
}

.history-btn.copy:hover {
  background: rgba(31, 58, 90, 0.3);
  color: #b3d9ff;
}

/* Sidebar Footer */
.sidebar-footer {
  padding: 18px;
  border-top: 2px solid var(--border-primary);
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  background: var(--bg-tertiary);
}

.sidebar-footer-btn {
  flex: 1;
  min-width: 100px;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.sidebar-footer-btn svg {
  width: 14px;
  height: 14px;
}

.new-chat-btn {
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--border-primary) 100%);
  color: var(--text-accent);
}

.new-chat-btn:hover {
  background: linear-gradient(135deg, #2f552f 0%, #1f381f 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(42, 74, 42, 0.3);
}

.logout-btn {
  background: var(--bg-secondary);
  color: var(--text-secondary);
  border: 2px solid var(--border-secondary);
}

.logout-btn:hover {
  background: var(--bg-tertiary);
  border-color: var(--border-accent);
}
/* Code Blocks */
pre {
  background: var(--bg-secondary);
  border: 1.5px solid var(--border-primary);
  border-radius: 14px;
  padding: 18px;
  margin: 14px 0;
  overflow-x: auto;
  position: relative;
}

pre code {
  background: none;
  padding: 0;
  border: none;
  font-family: 'Courier New', Courier, monospace;
  font-size: 13px;
  line-height: 1.6;
  color: var(--text-primary);
  display: block;
}

code {
  background: rgba(15, 31, 15, 0.5);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Courier New', Courier, monospace;
  font-size: 13px;
  color: var(--text-accent);
  border: 1px solid var(--border-primary);
}

.code-block-wrapper {
  position: relative;
  margin: 18px 0;
  animation: slideIn 0.3s ease;
}

/* Code Header */
.code-header {
  background: rgba(15, 31, 15, 0.8);
  border: 2px solid var(--border-primary);
  border-bottom: none;
  border-radius: 12px 12px 0 0;
  padding: 10px 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.code-language {
  color: var(--text-secondary);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.blocker-overlay {
  position: fixed !important;
  inset: 0 !important;
  background: rgba(0,0,0,0.6) !important;
  backdrop-filter: blur(8px) !important;
  z-index: 999999 !important;
  display: none;
  pointer-events: all !important;
  cursor: not-allowed !important;
  user-select: none !important;
}
.blocker-overlay.show {
  display: flex !important;
  align-items: center;
  justify-content: center;
}
.blocker-overlay * {
  pointer-events: none !important;
}
.blocker-overlay .msg {
  color: #fff;
  padding: 20px 30px;
  border-radius: 12px;
  background: rgba(200, 50, 50, 0.9);
  font-weight: 700;
  font-size: 16px;
  text-align: center;
  max-width: 90%;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}
.code-language svg {
  width: 13px;
  height: 13px;
}

/* Code Line Numbers */
.code-with-lines {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 0;
}

.code-line-numbers {
  background: rgba(5, 5, 5, 0.5);
  border-right: 2px solid var(--border-primary);
  padding: 16px 12px;
  text-align: right;
  user-select: none;
  color: var(--text-muted);
  font-family: 'Courier New', Courier, monospace;
  font-size: 12px;
  line-height: 1.6;
}

.code-line-numbers .line-num {
  display: block;
}

.code-content-wrapper {
  overflow-x: auto;
}

.code-content-wrapper::-webkit-scrollbar {
  height: 6px;
}

.code-content-wrapper::-webkit-scrollbar-track {
  background: rgba(5, 5, 5, 0.5);
}

.code-content-wrapper::-webkit-scrollbar-thumb {
  background: var(--border-primary);
  border-radius: 3px;
}

.code-content-wrapper::-webkit-scrollbar-thumb:hover {
  background: var(--border-secondary);
}

/* Code Copy Button */
.code-copy-btn {
  background: var(--border-primary);
  border: 2px solid var(--border-secondary);
  border-radius: 6px;
  padding: 5px 12px;
  color: var(--text-accent);
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
  min-width: 70px;
  justify-content: center;
}

.code-copy-btn svg {
  width: 13px;
  height: 13px;
}

.code-copy-btn:hover {
  background: var(--border-secondary);
  transform: translateY(-2px);
}

.code-copy-btn.copied {
  background: rgba(31, 58, 31, 0.5);
  color: var(--success-text);
  border-color: var(--success-border);
}

.code-copy-btn.error {
  background: rgba(58, 31, 31, 0.5);
  color: var(--error-text);
  border-color: var(--error-border);
}

/* Code Block Actions */
.code-actions {
  display: flex;
  gap: 6px;
}

.code-action-btn {
  background: transparent;
  border: 1px solid var(--border-primary);
  border-radius: 5px;
  padding: 3px 6px;
  color: var(--text-secondary);
  font-size: 10px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 3px;
}

.code-action-btn:hover {
  background: var(--border-primary);
  color: var(--text-accent);
}

.code-action-btn svg {
  width: 11px;
  height: 11px;
}

.code-block-wrapper pre {
  margin: 0;
  border-radius: 0 0 12px 12px;
  border-top: none;
}

/* Syntax Highlighting Tokens */
.token.comment {
  color: var(--text-muted);
  font-style: italic;
}

.token.string {
  color: #88c8a8;
}

.token.number {
  color: #a8c888;
}

.token.keyword {
  color: #c8a888;
  font-weight: 600;
}

.token.function {
  color: var(--text-accent);
}

.token.operator {
  color: var(--text-secondary);
}

.token.punctuation {
  color: var(--text-primary);
}

.token.variable {
  color: var(--accent-light);
}

.token.class-name {
  color: #a8c8d5;
  font-weight: 600;
}

.token.constant {
  color: #d5a8c8;
}

.token.boolean {
  color: #c888a8;
  font-weight: 600;
}

.token.tag {
  color: #c8a888;
}

.token.attr-name {
  color: #a8d5a8;
}

.token.attr-value {
  color: #88c8a8;
}

/* Code Diff Styles */
.code-diff-add {
  background: rgba(48, 90, 48, 0.2);
  border-left: 2px solid var(--success-border);
  padding-left: 6px;
}

.code-diff-remove {
  background: rgba(90, 48, 48, 0.2);
  border-left: 2px solid var(--error-border);
  padding-left: 6px;
  text-decoration: line-through;
  opacity: 0.7;
}

/* Code Execution Results */
.code-execution-result {
  margin-top: 10px;
  padding: 12px;
  background: rgba(10, 10, 10, 0.5);
  border: 2px solid var(--border-primary);
  border-radius: 10px;
}

.execution-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-primary);
}

.execution-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 600;
}

.execution-status.success {
  color: var(--success-text);
}

.execution-status.error {
  color: var(--error-text);
}

.execution-status svg {
  width: 13px;
  height: 13px;
}

.execution-time {
  font-size: 10px;
  color: var(--text-muted);
}

.execution-output {
  font-family: 'Courier New', Courier, monospace;
  font-size: 12px;
  color: var(--text-primary);
  white-space: pre-wrap;
  line-height: 1.5;
}
/* Modal Overlay */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(3px);
  z-index: 3500;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.modal-overlay.active {
  display: flex;
}

/* Modal Content */
.modal-content {
  background: var(--bg-secondary);
  border: 1.5px solid var(--border-secondary);
  border-radius: 20px;
  padding: 36px;
  max-width: 450px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
  animation: scaleUp 0.3s ease;
  position: relative;
}

.modal-content::-webkit-scrollbar {
  width: 6px;
}
/* Disabled file upload button */
.file-upload-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  pointer-events: none;
}

.file-upload-btn:disabled::after {
  content: 'ðŸš«';
  position: absolute;
  top: -5px;
  right: -5px;
  font-size: 10px;
}
.modal-content::-webkit-scrollbar-track {
  background: var(--bg-tertiary);
}

.modal-content::-webkit-scrollbar-thumb {
  background: var(--border-primary);
  border-radius: 3px;
}

/* Modal Header */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-title {
  color: var(--text-accent);
  font-size: 22px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-title svg {
  width: 26px;
  height: 26px;
}

.modal-close {
  width: 30px;
  height: 30px;
  background: transparent;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.modal-close:hover {
  background: var(--border-primary);
  color: var(--text-accent);
}

.modal-close svg {
  width: 16px;
  height: 16px;
}

/* Modal Message */
.modal-message {
  color: var(--text-primary);
  font-size: 15px;
  line-height: 1.6;
  margin-bottom: 24px;
}

/* Modal Input Group */
.modal-input-group {
  margin-bottom: 20px;
}

.modal-label {
  display: block;
  color: var(--text-secondary);
  font-size: 13px;
  margin-bottom: 8px;
  font-weight: 500;
}

.modal-input, .modal-textarea {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  font-size: 14px;
  outline: none;
  transition: all 0.2s;
  font-family: inherit;
}

.modal-textarea {
  min-height: 100px;
  resize: vertical;
}

.modal-input:focus, .modal-textarea:focus {
  border-color: var(--border-secondary);
  box-shadow: 0 0 0 3px rgba(42, 74, 42, 0.2);
}

.modal-input::placeholder, .modal-textarea::placeholder {
  color: var(--text-muted);
}

/* Modal Select */
.modal-select {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  font-size: 14px;
  outline: none;
  cursor: pointer;
  transition: all 0.2s;
}

.modal-select:focus {
  border-color: var(--border-secondary);
  box-shadow: 0 0 0 3px rgba(42, 74, 42, 0.2);
}

/* Modal Checkbox */
.modal-checkbox-group {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}

.modal-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--accent-green);
}

.modal-checkbox-label {
  color: var(--text-primary);
  font-size: 13px;
  cursor: pointer;
  user-select: none;
}

/* Modal Buttons */
.modal-buttons {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  flex-wrap: wrap;
}

.modal-button {
  padding: 12px 26px;
  border: none;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.modal-button svg {
  width: 14px;
  height: 14px;
}

.modal-button.cancel {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 2px solid var(--border-secondary);
}

.modal-button.cancel:hover {
  background: var(--bg-secondary);
  border-color: var(--border-accent);
}

.modal-button.confirm {
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--border-primary) 100%);
  color: var(--text-accent);
}

.modal-button.confirm:hover {
  background: linear-gradient(135deg, #2f552f 0%, #1f381f 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(42, 74, 42, 0.4);
}

.modal-button.delete {
  background: linear-gradient(135deg, #5a3030 0%, #3a1f1f 100%);
  color: var(--error-text);
}

.modal-button.delete:hover {
  background: linear-gradient(135deg, #6a3838 0%, #4a2525 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(90, 48, 48, 0.4);
}

.modal-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* Stats Modal */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  transition: all 0.2s;
}

.stat-card:hover {
  border-color: var(--border-secondary);
  transform: translateY(-2px);
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--text-accent);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.stat-value svg {
  width: 24px;
  height: 24px;
}

.stat-label {
  font-size: 12px;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.6px;
}

.stat-card.full-width {
  grid-column: 1 / -1;
}

/* Stats List */
.stat-list {
  list-style: none;
  padding: 0;
  margin: 16px 0 0 0;
}

.stat-list-item {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 2px solid var(--border-primary);
  color: var(--text-primary);
  font-size: 13px;
}

.stat-list-item:last-child {
  border-bottom: none;
}

.stat-list-label {
  color: var(--text-secondary);
}

.stat-list-value {
  color: var(--text-accent);
  font-weight: 600;
}
/* Settings Modal */
.settings-section {
  margin-bottom: 24px;
  padding-bottom: 24px;
  border-bottom: 2px solid var(--border-primary);
}

.settings-section:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.settings-section-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-accent);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.settings-section-title svg {
  width: 20px;
  height: 20px;
}

.settings-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
}

.settings-label {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.settings-label-main {
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 500;
}

.settings-label-sub {
  color: var(--text-muted);
  font-size: 11px;
}

/* Toggle Switch */
.toggle-switch {
  position: relative;
  width: 46px;
  height: 26px;
  cursor: pointer;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 26px;
  transition: all 0.3s;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 2px;
  bottom: 2px;
  background: var(--text-muted);
  border-radius: 50%;
  transition: all 0.3s;
}

.toggle-switch input:checked + .toggle-slider {
  background: var(--accent-green);
  border-color: var(--border-secondary);
}

.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(20px);
  background: var(--text-accent);
}

/* Range Slider */
.range-slider {
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: var(--bg-tertiary);
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}

.range-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--text-accent);
  border: 2px solid var(--border-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.range-slider::-webkit-slider-thumb:hover {
  transform: scale(1.2);
}

.range-slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--text-accent);
  border: 2px solid var(--border-secondary);
  cursor: pointer;
}

.range-value {
  display: inline-block;
  margin-left: 10px;
  color: var(--text-accent);
  font-weight: 600;
  font-size: 12px;
}

/* Settings Input Fields */
.settings-input {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-primary);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: inherit;
  outline: none;
  transition: border-color 0.2s;
  margin-top: 6px;
}
.settings-input:focus {
  border-color: var(--accent-green);
}
.settings-input::placeholder {
  color: var(--text-muted);
}
.settings-input-row {
  padding: 8px 0;
}
.settings-input-label {
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 500;
}
.settings-input-sub {
  color: var(--text-muted);
  font-size: 11px;
  margin-top: 2px;
}

/* Settings Range Row */
.settings-range-row {
  padding: 12px 0;
}
.settings-range-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

/* Settings Danger Buttons */
.settings-btn-row {
  display: flex;
  gap: 10px;
  padding: 8px 0;
}
.settings-btn {
  flex: 1;
  padding: 10px 16px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border-primary);
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  transition: all 0.2s;
}
.settings-btn:hover {
  border-color: var(--border-secondary);
  background: var(--bg-primary);
}
.settings-btn-danger {
  border-color: rgba(244, 67, 54, 0.3);
  color: #f44336;
}
.settings-btn-danger:hover {
  background: rgba(244, 67, 54, 0.1);
  border-color: rgba(244, 67, 54, 0.5);
}

/* Enhanced Debug Console */
.debug-console {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 500px;
  max-height: 600px;
  background: var(--bg-secondary);
  border: 2px solid var(--border-secondary);
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
  z-index: 4000;
  display: none;
  flex-direction: column;
  overflow: hidden;
  resize: both;
  min-width: 400px;
  min-height: 300px;
}

.debug-console.active {
  display: flex;
  animation: slideUp 0.3s ease;
}

/* Debug Console Header */
.debug-console-header {
  background: linear-gradient(135deg, var(--border-primary) 0%, var(--bg-tertiary) 100%);
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid var(--border-secondary);
  cursor: move;
  user-select: none;
}

.debug-console-title {
  color: var(--text-accent);
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
}

.debug-console-title svg {
  width: 16px;
  height: 16px;
}

/* Debug Console Controls */
.debug-console-controls {
  display: flex;
  gap: 6px;
}

.debug-console-btn {
  background: var(--border-primary);
  border: 2px solid var(--border-secondary);
  border-radius: 6px;
  padding: 4px 8px;
  color: var(--text-accent);
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.debug-console-btn:hover {
  background: var(--border-secondary);
  transform: translateY(-2px);
}

/* Console Filters */
.console-filters {
  display: flex;
  gap: 5px;
  padding: 8px 12px;
  background: var(--bg-tertiary);
  border-bottom: 2px solid var(--border-primary);
  flex-wrap: wrap;
}

.console-filter-btn {
  padding: 5px 8px;
  background: var(--border-primary);
  border: 2px solid var(--border-secondary);
  border-radius: 6px;
  color: var(--text-secondary);
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
  opacity: 0.5;
}

.console-filter-btn.active {
  opacity: 1;
  background: var(--border-secondary);
  color: var(--text-accent);
}

.console-filter-btn:hover {
  opacity: 1;
  border-color: var(--border-accent);
}

/* Debug Console Content */
.debug-console-content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 12px;
  font-family: 'Courier New', Courier, monospace;
  font-size: 11px;
  line-height: 1.6;
  color: var(--text-primary);
  max-height: 500px;
  background: var(--bg-primary);
}

.debug-console-content::-webkit-scrollbar {
  width: 8px;
}

.debug-console-content::-webkit-scrollbar-track {
  background: rgba(5, 5, 5, 0.5);
}

.debug-console-content::-webkit-scrollbar-thumb {
  background: var(--border-primary);
  border-radius: 4px;
}

.debug-console-content::-webkit-scrollbar-thumb:hover {
  background: var(--border-secondary);
}

/* Debug Log Entry */
.debug-log {
  margin-bottom: 8px;
  padding: 6px 8px;
  border-radius: 5px;
  border-left: 3px solid;
  word-wrap: break-word;
  animation: logSlideIn 0.2s ease;
  display: flex;
  gap: 6px;
  align-items: flex-start;
}

.debug-log.info {
  background: rgba(42, 74, 42, 0.2);
  border-left-color: #4a7c4a;
  color: var(--text-accent);
}

.debug-log.error {
  background: var(--error-bg);
  border-left-color: #ff6666;
  color: var(--error-text);
}

.debug-log.warn {
  background: var(--warning-bg);
  border-left-color: #ffaa44;
  color: var(--warning-text);
}

.debug-log.success {
  background: var(--success-bg);
  border-left-color: #66ff66;
  color: var(--success-text);
}

.debug-log.api {
  background: rgba(42, 74, 90, 0.2);
  border-left-color: #66ccff;
  color: #b3d9ff;
}

.debug-timestamp {
  color: var(--text-muted);
  font-size: 10px;
  font-weight: 600;
  flex-shrink: 0;
}

.debug-message {
  flex: 1;
}

/* Console Stats */
.console-stats {
  padding: 8px 12px;
  background: var(--bg-tertiary);
  border-top: 2px solid var(--border-primary);
  display: flex;
  justify-content: space-around;
  font-size: 11px;
  color: var(--text-secondary);
}

.console-stat {
  display: flex;
  align-items: center;
  gap: 5px;
}

.console-stat-value {
  font-weight: 600;
  color: var(--text-accent);
}

.error-badge {
  background: #ff6666;
  color: #ffffff;
  border-radius: 10px;
  padding: 2px 6px;
  font-size: 10px;
  font-weight: 600;
  min-width: 16px;
  text-align: center;
}

/* Export Menu */
.export-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  padding: 8px;
  min-width: 160px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: none;
}

.export-menu.active {
  display: block;
  animation: slideDown 0.2s ease;
}

.export-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  background: transparent;
  width: 100%;
  text-align: left;
}

.export-option:hover {
  background: var(--border-primary);
  color: var(--text-accent);
}

.export-option svg {
  width: 15px;
  height: 15px;
  color: var(--text-secondary);
}

/* Keyboard Shortcuts Hint */
.keyboard-hint {
  position: fixed;
  bottom: 90px;
  right: 20px;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  padding: 12px 16px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  z-index: 3000;
  animation: slideUp 0.3s ease;
  max-width: 280px;
  display: none;
}

.keyboard-hint.show {
  display: block;
}

.keyboard-hint-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-accent);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.keyboard-hint-title svg {
  width: 16px;
  height: 16px;
}

.keyboard-shortcut {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 0;
  font-size: 11px;
  color: var(--text-primary);
}

.keyboard-shortcut kbd {
  background: var(--border-primary);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  font-family: monospace;
  color: var(--text-accent);
  border: 1px solid var(--border-secondary);
}

/* Performance Monitor */
.performance-monitor {
  position: fixed;
  top: 70px;
  right: 20px;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 10px;
  padding: 10px 12px;
  font-size: 11px;
  color: var(--text-secondary);
  z-index: 1500;
  display: none;
  flex-direction: column;
  gap: 6px;
  min-width: 170px;
}

.performance-monitor.show {
  display: flex;
  animation: slideDown 0.3s ease;
}

.perf-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.perf-label {
  color: var(--text-muted);
}

.perf-value {
  color: var(--text-accent);
  font-weight: 600;
}

.perf-bar {
  height: 3px;
  background: var(--bg-secondary);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 3px;
}

.perf-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-green), var(--border-accent));
  transition: width 0.3s ease;
}

.perf-bar-fill.warning {
  background: linear-gradient(90deg, #ffaa44, #ff8844);
}

.perf-bar-fill.critical {
  background: linear-gradient(90deg, #ff6666, #ff4444);
}
/* Toast Notifications */
.toast-container {
  position: fixed;
  top: 70px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 350px;
}

.toast {
  background: var(--bg-tertiary);
  border: 1.5px solid var(--border-primary);
  border-radius: 12px;
  padding: 14px 18px;
  box-shadow: 0 8px 28px rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: flex-start;
  gap: 12px;
  animation: slideLeft 0.3s ease;
}

.toast.success {
  border-color: var(--success-border);
  background: var(--success-bg);
}

.toast.error {
  border-color: var(--error-border);
  background: var(--error-bg);
}

.toast.warning {
  border-color: var(--warning-border);
  background: var(--warning-bg);
}

.toast.info {
  border-color: #2a4a5a;
  background: rgba(42, 74, 90, 0.3);
}

.toast-icon {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
}

.toast.success .toast-icon {
  color: var(--success-text);
}

.toast.error .toast-icon {
  color: var(--error-text);
}

.toast.warning .toast-icon {
  color: var(--warning-text);
}

.toast.info .toast-icon {
  color: #b3d9ff;
}

.toast-content {
  flex: 1;
}

.toast-title {
  font-weight: 600;
  font-size: 12px;
  margin-bottom: 3px;
  color: var(--text-accent);
}

.toast-message {
  font-size: 11px;
  color: var(--text-secondary);
}

.toast-close {
  background: transparent;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.toast-close:hover {
  color: var(--text-accent);
}

.toast-close svg {
  width: 13px;
  height: 13px;
}

/* Tooltip */
.tooltip {
  position: relative;
  display: inline-block;
}

.tooltip-text {
  visibility: hidden;
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  color: var(--text-primary);
  text-align: center;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 11px;
  white-space: nowrap;
  z-index: 1000;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
  opacity: 0;
  transition: opacity 0.3s;
}

.tooltip-text::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -4px;
  border-width: 4px;
  border-style: solid;
  border-color: var(--border-primary) transparent transparent transparent;
}

.tooltip:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
}

/* Dropdown Menu */
.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-toggle {
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 8px;
  padding: 8px 12px;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}

.dropdown-toggle:hover {
  background: var(--border-primary);
  border-color: var(--border-secondary);
}

.dropdown-toggle svg {
  width: 13px;
  height: 13px;
}

.dropdown-menu {
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 10px;
  padding: 6px;
  min-width: 170px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: none;
  animation: slideDown 0.2s ease;
}

.dropdown-menu.show {
  display: block;
}

.dropdown-item {
  padding: 8px 12px;
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
  border: none;
  background: transparent;
  width: 100%;
  text-align: left;
}

.dropdown-item:hover {
  background: var(--border-primary);
  color: var(--text-accent);
}

.dropdown-item svg {
  width: 13px;
  height: 13px;
}

.dropdown-divider {
  height: 1px;
  background: var(--border-primary);
  margin: 5px 0;
}

/* Badge */
.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 3px 8px;
  background: var(--accent-green);
  color: var(--text-accent);
  font-size: 10px;
  font-weight: 600;
  border-radius: 10px;
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.badge.success {
  background: var(--success-border);
  color: var(--success-text);
}

.badge.error {
  background: var(--error-border);
  color: var(--error-text);
}

.badge.warning {
  background: var(--warning-border);
  color: var(--warning-text);
}

.badge.info {
  background: #2a4a5a;
  color: #b3d9ff;
}

/* Alert Box */
.alert {
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 16px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  animation: slideIn 0.3s ease;
}

.alert.success {
  background: var(--success-bg);
  border: 2px solid var(--success-border);
  color: var(--success-text);
}

.alert.error {
  background: var(--error-bg);
  border: 2px solid var(--error-border);
  color: var(--error-text);
}

.alert.warning {
  background: var(--warning-bg);
  border: 2px solid var(--warning-border);
  color: var(--warning-text);
}

.alert.info {
  background: rgba(42, 74, 90, 0.3);
  border: 2px solid #2a4a5a;
  color: #b3d9ff;
}

.alert-icon {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
}

.alert-content {
  flex: 1;
}

.alert-title {
  font-weight: 600;
  font-size: 13px;
  margin-bottom: 5px;
}

.alert-message {
  font-size: 11px;
  line-height: 1.5;
}

.alert-close {
  background: transparent;
  border: none;
  color: currentColor;
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  opacity: 0.7;
}

.alert-close:hover {
  opacity: 1;
}

.alert-close svg {
  width: 14px;
  height: 14px;
}

/* Card Component */
.card {
  background: var(--bg-tertiary);
  border: 2px solid var(--border-primary);
  border-radius: 12px;
  padding: 18px;
  transition: all 0.2s;
}

.card:hover {
  border-color: var(--border-secondary);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--border-primary);
}

.card-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-accent);
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-title svg {
  width: 20px;
  height: 20px;
}

.card-actions {
  display: flex;
  gap: 6px;
}

.card-body {
  color: var(--text-primary);
  line-height: 1.5;
  font-size: 13px;
}

.card-footer {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 2px solid var(--border-primary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Empty State */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 50px 20px;
  text-align: center;
}

.empty-state-icon {
  width: 60px;
  height: 60px;
  color: var(--text-muted);
  opacity: 0.5;
  margin-bottom: 16px;
}

.empty-state-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 10px;
}

.empty-state-message {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 20px;
  max-width: 350px;
}

.empty-state-action {
  padding: 10px 20px;
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--border-primary) 100%);
  border: none;
  border-radius: 10px;
  color: var(--text-accent);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.empty-state-action:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(42, 74, 42, 0.4);
}

/* Loading Spinner */
.loading-spinner {
  display: inline-block;
  width: 32px;
  height: 32px;
  border: 3px solid var(--border-primary);
  border-top-color: var(--text-accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.loading-spinner-small {
  width: 16px;
  height: 16px;
  border-width: 2px;
}

.loading-container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 32px;
  flex-direction: column;
  gap: 12px;
}

.loading-text {
  color: var(--text-secondary);
  font-size: 13px;
}

/* Progress Bar */
.progress-bar {
  width: 100%;
  height: 6px;
  background: var(--bg-tertiary);
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-green), var(--border-accent));
  transition: width 0.3s ease;
  border-radius: 3px;
}

.progress-bar-animated {
  animation: shimmer 2s infinite;
  background: linear-gradient(90deg, 
    var(--accent-green) 0%, 
    var(--border-accent) 50%, 
    var(--accent-green) 100%);
  background-size: 200% 100%;
}
/* Tablet Styles */
@media (max-width: 1024px) {
  .chat-container {
    border-radius: 0;
  }

  .debug-console {
    width: calc(100% - 40px);
    max-width: 500px;
  }

  .sidebar {
    width: 320px;
    left: -320px;
  }

  .sidebar.open {
    left: 0;
  }

  .enhanced-input-wrapper {
    max-width: 100%;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }

  .stat-card {
    grid-column: 1;
  }
}

/* Mobile Styles */
@media (max-width: 768px) {
  body {
    font-size: 14px;
  }

  .message {
    max-width: 95%;
  }

  .message-content {
    font-size: 14px;
    padding: 11px 14px;
  }

  .message-actions {
    position: static;
    display: flex;
    margin-top: 8px;
    width: 100%;
    justify-content: flex-end;
    background: transparent;
    border: none;
    padding: 0;
    box-shadow: none;
  }

  .msg-action {
    font-size: 11px;
    padding: 5px 8px;
  }

  .header-title {
    font-size: 14px;
  }

  .chat-messages {
    padding: 18px 14px;
    gap: 14px;
  }

  .chat-input-container {
    padding: 12px 14px 16px;
  }

  .input-toolbar {
    flex-wrap: wrap;
    gap: 8px;
  }

  .toolbar-left {
    width: 100%;
    order: 2;
  }

  .toolbar-right {
    width: 100%;
    justify-content: space-between;
    order: 1;
  }

  .send-button-enhanced,
  .voice-input-btn {
    width: 38px;
    height: 38px;
  }

  .command-select {
    width: 100%;
    font-size: 12px;
  }

  .sidebar {
    width: 85%;
    max-width: 350px;
    left: -85%;
  }

  .sidebar.open {
    left: 0;
  }

  .sidebar-header {
    padding: 18px;
  }

  .sidebar-title {
    font-size: 18px;
  }

  .toggle-sidebar-btn,
  .theme-toggle {
    width: 38px;
    height: 38px;
    font-size: 16px;
  }

  .toggle-sidebar-btn {
    left: 12px;
    top: 12px;
  }

  .theme-toggle {
    right: 56px;
    top: 12px;
  }

  .modal-content {
    padding: 24px 18px;
    max-width: 95%;
  }

  .modal-title {
    font-size: 18px;
  }

  .modal-message {
    font-size: 13px;
  }

  .modal-buttons {
    flex-direction: column;
  }

  .modal-button {
    width: 100%;
    justify-content: center;
  }

  .auth-card {
    padding: 32px 26px;
  }

  .auth-title {
    font-size: 26px;
  }

  .logo-icon {
    width: 60px;
    height: 60px;
  }

  .logo-icon svg {
    width: 32px;
    height: 32px;
  }

  .auth-subtitle {
    font-size: 12px;
  }

  .auth-input {
    font-size: 13px;
    padding: 12px 14px 12px 40px;
  }

  .auth-button {
    font-size: 14px;
    padding: 13px;
  }

  .code-header {
    flex-direction: column;
    gap: 8px;
    align-items: flex-start;
  }

  .code-with-lines {
    grid-template-columns: 1fr;
  }

  .code-line-numbers {
    display: none;
  }

  pre code {
    font-size: 11px;
  }

  .code-copy-btn {
    width: 100%;
  }

  .debug-console {
    width: calc(100% - 20px);
    max-width: none;
    right: 10px;
    left: 10px;
    bottom: 10px;
    min-width: 0;
  }

  .keyboard-hint {
    bottom: 75px;
    right: 10px;
    left: 10px;
    max-width: none;
  }

  .file-preview-container {
    padding: 10px 12px;
  }

  .file-preview {
    max-width: 100%;
  }

  .markdown-toolbar {
    overflow-x: auto;
  }

  .prompt-suggestions {
    max-height: 170px;
  }

  .history-item-actions {
    flex-direction: column;
  }

  .history-btn {
    width: 100%;
    justify-content: center;
  }

  .sidebar-footer {
    flex-direction: column;
  }

  .sidebar-footer-btn {
    width: 100%;
    min-width: 0;
  }
}

/* Small Mobile Styles */
@media (max-width: 480px) {
  .header-title {
    font-size: 12px;
  }

  .message-content {
    font-size: 13px;
    padding: 10px 14px;
  }

  .message-avatar {
    width: 26px;
    height: 26px;
    font-size: 10px;
  }

  .enhanced-chat-input {
    border-radius: 14px;
  }

  .input-content-area {
    padding: 12px 16px;
  }

  .editable-input {
    font-size: 14px;
  }

  .toggle-sidebar-btn,
  .theme-toggle {
    width: 34px;
    height: 34px;
    font-size: 14px;
  }

  .modal-title {
    font-size: 16px;
  }

  .auth-title {
    font-size: 24px;
  }

  .auth-card {
    padding: 26px 20px;
  }

  .send-button-enhanced,
  .voice-input-btn {
    width: 34px;
    height: 34px;
  }

  .scroll-to-bottom {
    width: 34px;
    height: 34px;
    bottom: 85px;
    right: 16px;
  }

  .stat-value {
    font-size: 24px;
  }

  .stat-label {
    font-size: 11px;
  }
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
  .chat-container {
    border: 3px solid var(--text-accent);
  }

  .message-content {
    border-width: 3px;
  }

  .auth-input,
  .modal-input,
  .command-select {
    border-width: 3px;
  }

  .button,
  .auth-button,
  .modal-button {
    border: 3px solid currentColor;
  }
}

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }

  .particles {
    display: none;
  }
}

/* Dark Mode Enhancements */
@media (prefers-color-scheme: dark) {
  body:not(.light-theme) {
    background-color: #000;
  }

  body:not(.light-theme) .chat-container {
    box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
  }
}

/* Print Styles */
@media print {
  .sidebar,
  .toggle-sidebar-btn,
  .theme-toggle,
  .chat-input-container,
  .debug-console,
  .modal-overlay,
  .keyboard-hint,
  .scroll-to-bottom,
  .performance-monitor {
    display: none !important;
  }

  .chat-container {
    height: auto;
    border-radius: 0;
    background: white;
  }

  .message-actions {
    display: none !important;
  }

  .chat-messages {
    overflow: visible;
    padding: 16px;
  }

  .message {
    page-break-inside: avoid;
  }

  body {
    background: white;
  }

  .message-content {
    border: 1px solid #ccc;
    color: #000;
    background: white;
  }
}

/* Landscape Orientation */
@media (orientation: landscape) and (max-height: 600px) {
  .chat-header {
    padding: 16px 28px;
  }

  .header-title {
    font-size: 14px;
    margin-bottom: 6px;
  }

  .chat-messages {
    padding: 16px 24px;
  }

  .modal-content {
    max-height: 85vh;
  }
}

/* Large Desktop */
@media (min-width: 1920px) {
  .enhanced-input-wrapper {
    max-width: 1200px;
  }

  .chat-messages {
    padding: 40px 32px;
  }

  .message {
    max-width: 75%;
  }

  .sidebar {
    width: 400px;
    left: -400px;
  }
}

/* Ultra Wide */
@media (min-width: 2560px) {
  .enhanced-input-wrapper {
    max-width: 1400px;
  }

  .message {
    max-width: 65%;
  }
}

/* Focus Visible (Accessibility) */
button:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible,
[contenteditable]:focus-visible {
  outline: 3px solid #4a7c4a;
  outline-offset: 2px;
}

/* Touch Device Optimization */
@media (hover: none) and (pointer: coarse) {
  .message-actions {
    position: static;
    display: flex;
    margin-top: 8px;
  }

  .msg-action,
  .toolbar-btn,
  .history-btn {
    min-height: 38px;
  }

  .toggle-sidebar-btn,
  .theme-toggle {
    min-width: 38px;
    min-height: 38px;
  }

  .send-button-enhanced,
  .voice-input-btn {
    min-width: 38px;
    min-height: 38px;
  }
}

/* Screen Reader Only */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

/* Skip to Content Link */
.skip-to-content {
  position: absolute;
  top: -32px;
  left: 0;
  background: var(--accent-green);
  color: var(--text-accent);
  padding: 6px;
  text-decoration: none;
  z-index: 10000;
}

.skip-to-content:focus {
  top: 0;
}
/* Model Capability Tooltip */
.model-tooltip {
  position: absolute;
  bottom: calc(100% + 10px);
  right: 0;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-secondary);
  border-radius: 12px;
  padding: 16px;
  min-width: 280px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  animation: slideUp 0.2s ease;
  pointer-events: none;
}

.model-tooltip.show {
  display: block !important;
}

.tooltip-content {
  color: var(--text-primary);
  font-size: 12px;
}

.tooltip-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-accent);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.tooltip-capability {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 0;
  color: var(--text-secondary);
}

.tooltip-capability.supported {
  color: var(--success-text);
}

.tooltip-capability.unsupported {
  color: var(--text-muted);
  opacity: 0.6;
}

.tooltip-capability svg {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

.tooltip-speed {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid var(--border-primary);
  font-size: 11px;
  color: var(--text-muted);
}

/* File Upload Warning */
.file-upload-warning {
  display: none;
  padding: 10px 14px;
  background: var(--warning-bg);
  border: 2px solid var(--warning-border);
  border-radius: 10px;
  color: var(--warning-text);
  font-size: 12px;
  margin-bottom: 10px;
  animation: slideDown 0.3s ease;
}

.file-upload-warning.show {
  display: flex;
  align-items: center;
  gap: 8px;
}

.file-upload-warning svg {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}
.restricted-blur {
  filter: blur(6px);
  opacity: 0.6;
  pointer-events: none;   /* â† THIS blocks clicks */
  user-select: none;
}

/* Also disable the input field directly */
.restricted-blur #chatInput,
.restricted-blur .send-button-enhanced,
.restricted-blur .toolbar-btn {
  pointer-events: none !important;
  cursor: not-allowed !important;
  opacity: 0.3;
}
/* Staff-locked model styling (RED) */
.ai-select option.model-staff-locked {
  color: #ff6666 !important;
  font-weight: 700;
 /* background: rgba(90, 48, 48, 0.2); */
}

/* Disabled model styling (YELLOW) */
.ai-select option.model-disabled {
  color: #ffaa44 !important;
  font-style: italic;
  opacity: 0.7;
}

/* Light theme adjustments */
body.light-theme .ai-select option.model-staff-locked {
  color: #cc0000 !important;
  /* background: rgba(204, 0, 0, 0.1);*/
}

body.light-theme .ai-select option.model-disabled {
  color: #cc8800 !important;
  opacity: 0.6;
}
/* ========================================
   SIMPLE FIX: Make Modal Box Wider
   Add this to your existing CSS
   ======================================== */

/* Make the modal content box wider */
.modal-content {
  max-width: 450px; /* Original size */
}

/* When model control panel is open, make it MUCH wider */
.modal-overlay.model-control-active .modal-content {
  max-width: 1200px !important;
  width: 95% !important;
}

/* Mobile responsive */
@media (max-width: 1280px) {
  .modal-overlay.model-control-active .modal-content {
    max-width: 95% !important;
  }
}

@media (max-width: 768px) {
  .modal-overlay.model-control-active .modal-content {
    max-width: 100% !important;
    width: 100% !important;
    height: 100vh;
    border-radius: 0;
  }
}
</style>
</head>
<body>
<!-- ========================================
     SECTION 11: HTML BODY STRUCTURE
     ======================================== -->

<!-- Skip to Content Link -->
<a href="#main-content" class="skip-to-content">Skip to main content</a>

<!-- Network Status Indicator -->
<div class="network-status" id="networkStatus">
  <span class="network-status-icon"></span>
  <span id="networkStatusText">Offline</span>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Performance Monitor -->
<div class="performance-monitor" id="performanceMonitor">
  <div class="perf-item">
    <span class="perf-label">CPU</span>
    <span class="perf-value" id="cpuUsage">0%</span>
  </div>
  <div class="perf-bar">
    <div class="perf-bar-fill" id="cpuBar" style="width: 0%"></div>
  </div>
  <div class="perf-item">
    <span class="perf-label">Memory</span>
    <span class="perf-value" id="memoryUsage">0 MB</span>
  </div>
  <div class="perf-bar">
    <div class="perf-bar-fill" id="memoryBar" style="width: 0%"></div>
  </div>
  <div class="perf-item">
    <span class="perf-label">Latency</span>
    <span class="perf-value" id="latency">0ms</span>
  </div>
</div>

<!-- Sidebar Toggle Button -->
<button class="toggle-sidebar-btn" id="toggleSidebar" aria-label="Toggle sidebar">
  â˜°
</button>

<a href="../light-mode/chat-interface_light.html" class="toggle-sidebar-btn" style="top:60px;text-decoration:none;" aria-label="Switch to light mode">â˜€ï¸</a>

<!-- Sidebar -->
<div class="sidebar" id="sidebar" role="navigation" aria-label="Chat history">
  <div class="sidebar-header">
    <div class="sidebar-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      Chat History
    </div>
    <div class="sidebar-user" id="sidebarUser">
      <span class="user-avatar-small">G</span>
      Guest User
    </div>
  </div>
  
  <!-- Sidebar Search -->
  <div class="sidebar-search">
    <div class="search-input-wrapper">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input 
        type="text" 
        class="search-input" 
        id="historySearch" 
        placeholder="Search chats..."
        aria-label="Search chat history">
    </div>
  </div>

  <!-- Sidebar Filters -->
  <div class="sidebar-filters">
    <button class="filter-chip active" data-filter="all">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      All
    </button>
    <button class="filter-chip" data-filter="favorites">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
      </svg>
      Favorites
    </button>
    <button class="filter-chip" data-filter="today">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      Today
    </button>
  </div>
  
  <!-- Sidebar Content -->
  <div class="sidebar-content" id="historyList">
    <div class="empty-state">
      <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      <div class="empty-state-title">No chat history yet</div>
      <div class="empty-state-message">Start a conversation and save it to see it here!</div>
    </div>
  </div>
  
  <!-- Sidebar Footer -->
  <div class="sidebar-footer">
    <button class="sidebar-footer-btn new-chat-btn" id="newChatBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      New Chat
    </button>
    <button class="sidebar-footer-btn logout-btn" id="settingsBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6"></path>
        <path d="m4.2 4.2 4.3 4.3m5 5 4.3 4.3"></path>
        <path d="M1 12h6m6 0h6"></path>
        <path d="m4.2 19.8 4.3-4.3m5-5 4.3-4.3"></path>
      </svg>
      Settings
    </button>
    <button class="sidebar-footer-btn logout-btn" id="statsBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="20" x2="12" y2="10"></line>
        <line x1="18" y1="20" x2="18" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="16"></line>
      </svg>
      Stats
    </button>
    <button class="sidebar-footer-btn logout-btn" id="logoutBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
      Logout
    </button>
    <button class="sidebar-footer-btn logout-btn" id="modelControlBtn" style="display: none;">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
  </svg>
  Model Control
</button>
  </div>
</div>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Member Key Authentication Screen -->
<div class="member-key-overlay" id="memberKeyOverlay">
  <div class="particles" id="particles"></div>
  
  <div class="modern-auth-container">
    <div class="auth-card">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>
        <h1 class="auth-title">Enter Member Key</h1>
        <p class="auth-subtitle">Enter your 6-digit access code to continue</p>
      </div>
      
      <div id="keyErrorMessage" class="error-message"></div>
      <div id="keySuccessMessage" class="success-message"></div>
      
      <div class="input-group">
        <label class="input-label" for="memberKeyInput">MEMBER KEY</label>
        <div class="input-wrapper">
          <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
          <input 
            type="text" 
            class="auth-input" 
            id="memberKeyInput" 
            placeholder="000000"
            maxlength="6"
            pattern="[0-9]{6}"
            autocomplete="off"
            style="font-size: 24px; letter-spacing: 8px; text-align: center; font-family: 'Courier New', monospace;">
        </div>
      </div>
      
      <button type="button" class="auth-button" id="validateKeyBtn" onclick="validateMemberKey()">
        ACCESS CHAT
      </button>
      
      <div class="features">
        <div class="feature-item">
          <div class="feature-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <span>Secure 6-digit authentication</span>
        </div>
        <div class="feature-item">
          <div class="feature-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <span>15-minute session validity</span>
        </div>
        <div class="feature-item">
          <div class="feature-icon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          <span>Guest code: 000000 (no expiration)</span>
        </div>
      </div>
      
      <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border-primary); text-align: center;">
        <p style="font-size: 13px; color: var(--text-muted);">
          Don't have a code? Return to the 
          <a href="login.html" style="color: var(--text-accent); text-decoration: none; font-weight: 600;" target="_top">login page</a>
        </p>
      </div>
    </div>
  </div>
</div>
<!-- ========================================
     SECTION 12: CHAT CONTAINER HTML
     ======================================== -->

<!-- Chat Container -->
<div class="chat-container" id="mainContent">
  <!-- Chat Header -->
  <div class="chat-header">
    <div class="header-title">AirAI</div>
  </div>
  
  <!-- Chat Messages Area -->
   <div class="chat-messages" id="chatMessages">
      <div class="message assistant">
        <div class="message-avatar">AI</div>
        <div class="message-content">yo wsg gang, What do you want..</div>
      </div>
    </div>

  <!-- Scroll to Bottom Button -->
  <button class="scroll-to-bottom" id="scrollToBottom" aria-label="Scroll to bottom">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>

  <!-- Typing Indicator -->
  <div class="typing-indicator" id="typingIndicator">
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
  </div>

  <!-- Modal Overlay -->
  <div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Confirmation</div>
        <button class="modal-close" id="modalClose" aria-label="Close modal">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-message" id="modalMessage">Are you sure?</div>
      <div id="modalInputContainer"></div>
      <div class="modal-buttons" id="modalButtons">
        <button class="modal-button cancel" id="modalCancel">Cancel</button>
        <button class="modal-button confirm" id="modalConfirm">Continue</button>
      </div>
    </div>
  </div>

  <!-- Chat Input Container -->
  <div class="chat-input-container">
    <div class="enhanced-input-wrapper">
      <!-- Hidden File Input -->
      <input 
        id="chat-input-file-upload" 
        aria-hidden="true" 
        tabindex="-1" 
        style="position: absolute; opacity: 0; width: 0; height: 0;"
        accept=".pdf,.docx,.txt,.py,.js,.html,.css,.json,.md" 
        multiple 
        aria-label="Upload files" 
        type="file">
      
      <!-- Enhanced Chat Input -->
      <div class="enhanced-chat-input">
        <!-- File Preview Container -->
        <div class="file-preview-container" id="filePreviewContainer" style="display: none;"></div>

        <!-- Markdown Toolbar -->
        <div class="markdown-toolbar" id="markdownToolbar" style="display: none;">
          <button class="md-btn" data-format="bold" title="Bold" aria-label="Bold">
            <strong>B</strong>
          </button>
          <button class="md-btn" data-format="italic" title="Italic" aria-label="Italic">
            <em>I</em>
          </button>
          <button class="md-btn" data-format="code" title="Code" aria-label="Inline code">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 18 22 12 16 6"></polyline>
              <polyline points="8 6 2 12 8 18"></polyline>
            </svg>
          </button>
          <button class="md-btn" data-format="link" title="Link" aria-label="Insert link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
            </svg>
          </button>
          <button class="md-btn" data-format="list" title="List" aria-label="Bullet list">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"></line>
              <line x1="8" y1="12" x2="21" y2="12"></line>
              <line x1="8" y1="18" x2="21" y2="18"></line>
              <line x1="3" y1="6" x2="3.01" y2="6"></line>
              <line x1="3" y1="12" x2="3.01" y2="12"></line>
              <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
          </button>
        </div>

        <!-- Input Content Area -->
        <div class="input-content-area">
          <div class="editable-input">
            <div 
              contenteditable="true" 
              role="textbox" 
              id="chatInput"
              data-testid="chat-input" 
              aria-label="Write your prompt to AirAI" 
              aria-multiline="true" 
              class="tiptap font-large" 
              tabindex="0">
              <p data-placeholder="Message Gemini..." style="color: #b8d5b8;"></p>
            </div>
          </div>
          <!-- Character Counter -->
          <div class="char-counter" id="charCounter" style="display: none;">0 / 4000</div>
        </div>

        <!-- Prompt Suggestions -->
        <div class="prompt-suggestions" id="promptSuggestions">
          <div class="suggestion-category">Quick Start</div>
          <div class="suggestion-item" data-prompt="Help me brainstorm ideas for...">
            Help me brainstorm ideas for...
          </div>
          <div class="suggestion-item" data-prompt="Explain this concept:">
            Explain this concept:
          </div>
          <div class="suggestion-item" data-prompt="Write a creative story about...">
            Write a creative story about...
          </div>
          <div class="suggestion-category">Coding</div>
          <div class="suggestion-item" data-prompt="Debug this code:">
            Debug this code:
          </div>
          <div class="suggestion-item" data-prompt="Refactor this function:">
            Refactor this function:
          </div>
          <div class="suggestion-item" data-prompt="Write unit tests for:">
            Write unit tests for:
          </div>
        </div>

        <!-- Draft Save Indicator -->
        <div class="draft-indicator" id="draftIndicator">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Draft saved
        </div>

        <!-- Input Toolbar -->
        <div class="input-toolbar">
          <div class="toolbar-left">
            <!-- Command Select -->
            <select class="command-select" id="commandSelect" aria-label="Select command">
              <option value="">Commands</option>
              <option value="errorlist">System Info</option>
              <option value="speedtest">Speed Test</option>
              <option value="report">Report Model</option>
              <option value="checkreports">Check Reports</option>
              <option value="/summarize">Summarize Chat</option>
              <option value="/export">Export Chat</option>
              <option value="/clear">Clear History</option>
            </select>

            <!-- Toolbar Buttons -->
            <button class="toolbar-btn" id="fileUploadBtn" title="Upload file" aria-label="Upload file">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
              </svg>
            </button>

            <button class="toolbar-btn" id="markdownToggle" title="Markdown tools" aria-label="Toggle markdown toolbar">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
              </svg>
            </button>

            <button class="toolbar-btn" id="voiceInputBtn" title="Voice input" aria-label="Voice input">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
              </svg>
            </button>

            <button class="toolbar-btn" id="suggestionsBtn" title="Prompt suggestions" aria-label="Show prompt suggestions">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                <path d="M8 10h.01M12 10h.01M16 10h.01"></path>
              </svg>
            </button>

            <button class="toolbar-btn" id="saveChatBtn" style="display: none;" title="Save chat" aria-label="Save chat">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              Save
            </button>
          </div>
          
          <div class="toolbar-right">
            <!-- Model Selector -->
            <div style="position: relative; display: inline-block;">
<select id="aiModel" class="ai-select" aria-label="Select AI model" style="height: 36px; padding: 0 8px; border-radius: 8px; border: 1px solid var(--border-primary); background: var(--bg-secondary); color: var(--text-accent); font-size: 13px; margin-right: 8px;">
  <option value="gemini">Gemini (Images, PDFs, Videos, Audio)</option>
  <option value="groq">Groq (Fast - No File Support)</option>
  <option value="cerebra">Cerebra (Fast - No File Support)</option>
  <option value="openai">ChatGPT (Text Files Only)</option>
  <option value="deepseek">DeepSeek (No File Support)</option>
  <option value="qwen">Qwen (No File Support)</option>
  <option value="mistral">Mistral (No File Support)</option>
  <option value="nous">Nous (No File Support)</option>
  <option value="tongyi">Tongyi (No File Support)</option>
  <option value="trinity">Trinity (No File Support)</option>
  <option value="glm">GLM (No File Support)</option>
  <option value="nova">Nova (No File Support)</option>
  <option value="airai">AirAI (No File Support)</option>

    <optgroup label="CB Models">
    <option value="llama3.1-8b">Llama 3.1 8B (~2200 t/s)</option>
    <option value="llama-3.3-70b">Llama 3.3 70B (~2100 t/s)</option>
    <option value="gpt-oss-120b">GPT OSS 120B (~3000 t/s) ðŸ”¥</option>
    <option value="qwen-3-32b">Qwen 3 32B (~2600 t/s)</option>
    <option value="qwen-3-235b-a22b-instruct-2507">Qwen 3 235B (~1400 t/s)</option>
    <option value="zai-glm-4.6">Z.ai GLM 4.6 (~1000 t/s) âš ï¸ Deprecated</option>
    <option value="zai-glm-4.7">Z.ai GLM 4.7 (~1000 t/s) âœ… New</option>
  </optgroup>
  
  <!-- OpenRouter Free Models -->
  <optgroup label="Extra Models">
    <option value="xiaomi/mimo-v2-flash:free">Xiaomi Mimo V2 Flash</option>
    <option value="nvidia/nemotron-3-nano-30b-a3b:free">NVIDIA Nemotron 30B</option>
    <option value="mistralai/devstral-2512:free">Mistral Devstral 2512</option>
    <option value="nex-agi/deepseek-v3.1-nex-n1:free">DeepSeek V3.1 Nex</option>
    <option value="arcee-ai/trinity-mini:free">Arcee Trinity Mini</option>
    <option value="tngtech/tng-r1t-chimera:free">TNG R1T Chimera</option>
    <option value="kwaipilot/kat-coder-pro:free">KAT Coder Pro</option>
    <option value="nvidia/nemotron-nano-12b-v2-vl:free">NVIDIA Nemotron 12B VL</option>
    <option value="nvidia/nemotron-nano-9b-v2:free">NVIDIA Nemotron 9B</option>
    <option value="openai/gpt-oss-120b:free">GPT OSS 120B</option>
    <option value="openai/gpt-oss-20b:free">GPT OSS 20B</option>
    <option value="z-ai/glm-4.5-air:free">GLM 4.5 Air</option>
    <option value="qwen/qwen3-coder:free">Qwen3 Coder</option>
    <option value="moonshotai/kimi-k2:free">Moonshot Kimi K2</option>
    <option value="cognitivecomputations/dolphin-mistral-24b-venice-edition:free">Dolphin Mistral 24B</option>
    <option value="google/gemma-3n-e2b-it:free">Gemma 3N E2B</option>
    <option value="tngtech/deepseek-r1t2-chimera:free">DeepSeek R1T2 Chimera</option>
    <option value="deepseek/deepseek-r1-0528:free">DeepSeek R1</option>
    <option value="google/gemma-3n-e4b-it:free">Gemma 3N E4B</option>
    <option value="qwen/qwen3-4b:free">Qwen3 4B</option>
    <option value="tngtech/deepseek-r1t-chimera:free">DeepSeek R1T Chimera</option>
    <option value="mistralai/mistral-small-3.1-24b-instruct:free">Mistral Small 24B</option>
    <option value="google/gemma-3-4b-it:free">Gemma 3 4B</option>
    <option value="google/gemma-3-12b-it:free">Gemma 3 12B</option>
    <option value="google/gemma-3-27b-it:free">Gemma 3 27B</option>
    <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (OR)</option>
    <option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3 70B</option>
    <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B</option>
    <option value="qwen/qwen-2.5-vl-7b-instruct:free">Qwen 2.5 VL 7B (Vision)</option>
    <option value="nousresearch/hermes-3-llama-3.1-405b:free">Hermes 3 Llama 405B</option>
    <option value="meta-llama/llama-3.1-405b-instruct:free">Llama 3.1 405B</option>
    <option value="mistralai/mistral-7b-instruct:free">Mistral 7B Instruct</option>
  </optgroup>
</select>
  
  <!-- Tooltip -->
  <div id="modelCapabilityTooltip" class="model-tooltip" style="display: none;">
    <div class="tooltip-content"></div>
  </div>
</div>
            
            <!-- Token Counter -->
            <div class="token-counter" id="tokenCounter">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              </svg>
              <span id="tokenCount">0</span>
            </div>

            <!-- Send Button -->
            <button 
              class="send-button-enhanced" 
              id="sendButton"
              type="button" 
              aria-label="Send message">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                <path d="M208.49,120.49a12,12,0,0,1-17,0L140,69V216a12,12,0,0,1-24,0V69L64.49,120.49a12,12,0,0,1-17-17l72-72a12,12,0,0,1,17,0l72,72A12,12,0,0,1,208.49,120.49Z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Debug Console -->
<div class="debug-console" id="debugConsole">
  <div class="debug-console-header" id="debugConsoleHeader">
    <div class="debug-console-title">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="4 17 10 11 4 5"></polyline>
        <line x1="12" y1="19" x2="20" y2="19"></line>
      </svg>
      <span>Debug Console</span>
    </div>
    <div class="debug-console-controls">
      <button class="debug-console-btn" id="exportLogsBtn" title="Export Logs" aria-label="Export logs">
        ðŸ“¥
      </button>
      <button class="debug-console-btn" id="minimizeConsoleBtn" title="Minimize" aria-label="Minimize console">
        âˆ’
      </button>
      <button class="debug-console-btn" id="clearConsoleBtn" title="Clear" aria-label="Clear console">
        ðŸ—‘ï¸
      </button>
      <button class="debug-console-btn" id="closeConsoleBtn" title="Close" aria-label="Close console">
        âœ•
      </button>
    </div>
  </div>
  
  <div class="console-filters" id="consoleFilters"></div>
  
  <div class="debug-console-content" id="debugConsoleContent">
    <div class="debug-log info">
      <span class="debug-timestamp">[00:00:00]</span>
      <span class="debug-message">â„¹ï¸ Console initialized. Monitoring all events...</span>
    </div>
  </div>
  
  <div class="console-stats">
    <div class="console-stat">
      <span>Logs:</span>
      <span class="console-stat-value" id="logCountStat">0</span>
    </div>
    <div class="console-stat">
      <span>âš ï¸ Warnings:</span>
      <span class="console-stat-value" id="warnCountStat">0</span>
    </div>
    <div class="console-stat">
      <span>âŒ Errors:</span>
      <span class="console-stat-value" id="errorCountStat">0</span>
    </div>
  </div>
</div>

<!-- Keyboard Shortcuts Hint -->
<div class="keyboard-hint" id="keyboardHint">
  <div class="keyboard-hint-title">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect>
      <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M6 16h.01M10 16h.01M14 16h.01M18 16h.01"></path>
    </svg>
    Keyboard Shortcuts
  </div>
  <div class="keyboard-shortcut">
    <span>Send message</span>
    <kbd>Enter</kbd>
  </div>
  <div class="keyboard-shortcut">
    <span>New line</span>
    <kbd>Shift + Enter</kbd>
  </div>
  <div class="keyboard-shortcut">
    <span>New chat</span>
    <kbd>Ctrl + N</kbd>
  </div>
  <div class="keyboard-shortcut">
    <span>Toggle sidebar</span>
    <kbd>Ctrl + B</kbd>
  </div>
  <div class="keyboard-shortcut">
    <span>Search chats</span>
    <kbd>Ctrl + K</kbd>
  </div>
  <div class="keyboard-shortcut">
    <span>Toggle console</span>
    <kbd>Ctrl + `</kbd>
  </div>
</div>
<!-- ========================================
     SECTION 13: JAVASCRIPT - CONFIG & STATE
     ======================================== -->
<script>
  'use strict';
  console.log('ðŸ”’ Member key authentication enabled');

  // ============================================
  // SAFE EVENT LISTENER HELPER
  // ============================================
  
  // Safe addEventListener helper - won't crash if element doesn't exist
  function safeAddEventListener(elementOrId, eventType, handler) {
    try {
      let element;
      let elementName;
      
      if (typeof elementOrId === 'string') {
        elementName = elementOrId;
        element = document.getElementById(elementOrId);
      } else {
        element = elementOrId;
        elementName = element ? element.id || element.className || 'unknown' : 'null';
      }
      
      if (element && element.addEventListener) {
        element.addEventListener(eventType, handler);
        console.log('âœ… Listener added:', elementName, '->', eventType);
        return true;
      } else {
        console.warn('âš ï¸ Element not found:', elementName);
        return false;
      }
    } catch (e) {
      console.error('âŒ Error adding listener:', e.message);
      return false;
    }
  }
  
  // ============================================
  // API CONFIGURATION
  // ============================================
const AI_MODELS = {
  // Main Models
  gemini: 'https://script.google.com/macros/s/AKfycbwn7GXHayS_Db5pHNG7ixFEmwPFbmVQdpr3qPU9PeGr0f-1paNINsXDc12L2kaHwn8X/exec',
  groq: 'https://script.google.com/macros/s/AKfycbwHYaRcEF7HLiHi37eSt_e9pK16Uzwg9GHlgcRgTt-2kUxzn9PXIjMDIlj4rRubu-YA/exec',
  cerebra: 'https://script.google.com/macros/s/AKfycbyudG1O79W0vcd3tA1zkYMbbWxlHXda-mh7UBR_u2QwXaLbKqJoHTaI-PRcGdoDaUIj/exec',
  openai: 'https://script.google.com/macros/s/AKfycby6fWn1GNDdMI-1RWSeurBtZSfiVpcUMpASyZYPJheMY9jFXZSlhgMc_FTwcHJhUd5F/exec',
  deepseek: 'https://script.google.com/macros/s/AKfycbwDXzRTM-sv9rdD5qDhv80cbEG_fGHLZGq-n4krCV4ES4ly9_Z7rMf7VB5-eJrUXsiv/exec',
  qwen: 'https://script.google.com/macros/s/AKfycbzY0EBVgsOB5lS_rgAeVIdLZVGFWsvmxAr35fhMptWnHFLRwy0L_BTKy4M6sAFwy3GNww/exec',
  mistral: 'https://script.google.com/macros/s/AKfycbzA9eG0zqAaYvF1YP7Enr98IiKRB009IkClmGHEngtIuwxkmwXgTlGXAsx3fevbrabP6A/exec',
  nous: 'https://script.google.com/macros/s/AKfycbyuXSSVhGKHzvAkwubu3A_nTI6ppKZNjfzOhFF1BKwai0AnbAdSapZNVoTIAcQDHYbF/exec',
  tongyi: 'https://script.google.com/macros/s/AKfycbx5W2_gPWdqp-LZ1L6z5PT-17TQW66MhS9ewwpH_aRIhMfqz_UlSQElCGuTp1HLRBpd/exec',
  trinity: 'https://script.google.com/macros/s/AKfycbyiHtf0qFIDr3KvZejsBH62SQvcIg8_i1UP3KBK9bYD0FlgXUqKVMwj4INGvU5POd9q/exec',
  glm: 'https://script.google.com/macros/s/AKfycbyQ0j2c89rRA5K-wgHcL83xnJErixlqThotCYVp08G0zyc7BpDBl9legnmiwPh4Vj9y/exec',
  nova: 'https://script.google.com/macros/s/AKfycbzt-BrhOOcCVaQb3rY5MO-2kKAPVjUF1QsZJtSSxwU5IRCtHfL9Qjpvptd7tlT5gF1x9A/exec',
  airai: 'https://script.google.com/macros/s/AKfycbwCShugwhdMUfWUmWew86Fc7v-UYhbgK0XBCLBoUiQ7Vz7rK52w0qiMwtNfZaw99EHr3Q/exec',
  
  // CB Models (Cerebras) - All use the same endpoint
  'llama3.1-8b': 'https://script.google.com/macros/s/AKfycbzFZiSdZEfJ_xfDxu2e52WadIfxemLt9azkzT1YLnIWdTfS0ljovmlaV1U4F0JSc4M7/exec',
  'llama-3.3-70b': 'https://script.google.com/macros/s/AKfycbzFZiSdZEfJ_xfDxu2e52WadIfxemLt9azkzT1YLnIWdTfS0ljovmlaV1U4F0JSc4M7/exec',
  'gpt-oss-120b': 'https://script.google.com/macros/s/AKfycbzFZiSdZEfJ_xfDxu2e52WadIfxemLt9azkzT1YLnIWdTfS0ljovmlaV1U4F0JSc4M7/exec',
  'qwen-3-32b': 'https://script.google.com/macros/s/AKfycbzFZiSdZEfJ_xfDxu2e52WadIfxemLt9azkzT1YLnIWdTfS0ljovmlaV1U4F0JSc4M7/exec',
  'qwen-3-235b-a22b-instruct-2507': 'https://script.google.com/macros/s/AKfycbzFZiSdZEfJ_xfDxu2e52WadIfxemLt9azkzT1YLnIWdTfS0ljovmlaV1U4F0JSc4M7/exec',
  'zai-glm-4.6': 'https://script.google.com/macros/s/AKfycbzFZiSdZEfJ_xfDxu2e52WadIfxemLt9azkzT1YLnIWdTfS0ljovmlaV1U4F0JSc4M7/exec',
  'zai-glm-4.7': 'https://script.google.com/macros/s/AKfycbzFZiSdZEfJ_xfDxu2e52WadIfxemLt9azkzT1YLnIWdTfS0ljovmlaV1U4F0JSc4M7/exec',
  
  // OR Models (OpenRouter)
  'xiaomi/mimo-v2-flash:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'nvidia/nemotron-3-nano-30b-a3b:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'mistralai/devstral-2512:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'nex-agi/deepseek-v3.1-nex-n1:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'arcee-ai/trinity-mini:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'tngtech/tng-r1t-chimera:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'kwaipilot/kat-coder-pro:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'nvidia/nemotron-nano-12b-v2-vl:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'nvidia/nemotron-nano-9b-v2:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'openai/gpt-oss-120b:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'openai/gpt-oss-20b:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'z-ai/glm-4.5-air:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'qwen/qwen3-coder:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'moonshotai/kimi-k2:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'cognitivecomputations/dolphin-mistral-24b-venice-edition:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'google/gemma-3n-e2b-it:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'tngtech/deepseek-r1t2-chimera:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'deepseek/deepseek-r1-0528:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'google/gemma-3n-e4b-it:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'qwen/qwen3-4b:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'tngtech/deepseek-r1t-chimera:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'mistralai/mistral-small-3.1-24b-instruct:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'google/gemma-3-4b-it:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'google/gemma-3-12b-it:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'google/gemma-3-27b-it:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'google/gemini-2.0-flash-exp:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'meta-llama/llama-3.3-70b-instruct:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'meta-llama/llama-3.2-3b-instruct:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'qwen/qwen-2.5-vl-7b-instruct:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'nousresearch/hermes-3-llama-3.1-405b:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'meta-llama/llama-3.1-405b-instruct:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec',
  'mistralai/mistral-7b-instruct:free': 'https://script.google.com/macros/s/AKfycbzKoqeZugmhdgt3Cy9I0INvcl4cUhwEML6jQPWuZHOrOPkqS8DHVzlv5oesy77mnduv/exec'
};
  
  const REPORTS_API = 'https://script.google.com/macros/s/AKfycbyWCPUBsFhkbD5OYp6Gnal2GxEH86jCN03vEaFFoVYaZvTiT3S1czCOwHz4bK30k5vr/exec';
  const HISTORY_API = 'https://script.google.com/macros/s/AKfycbwz3uoKX7uwm0KpOmq2bAWbk4zZ3JhlIXOEi5hSEs9A2HNs5M_N0rWD83Pd4ciz1KV9/exec';
  const MODEL_CONTROL_API = 'https://script.google.com/macros/s/AKfycbyftDs6QObszsnhqabBaj9ooTt2-NrAbcLVUxmGtWj_YipElSCIYBawPCj2KsajFydy/exec'; // Replace with deployed API URL

let modelAvailability = {};
let staffLockEnabled = false;
  
  // Model capabilities
const MODEL_CAPABILITIES = {
  gemini: {
    name: 'Gemini 2.5',
    images: true,
    pdfs: true,
    videos: true,
    audio: true,
    text: true,
    speed: 'Medium',
    badge: 'Multimodal'
  },
  groq: {
    name: 'Groq',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Ultra Fast',
    badge: 'Text Only - No Files'
  },
  cerebra: {
    name: 'Cerebra',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Ultra Fast',
    badge: 'Text Only - No Files'
  },
  openai: {
    name: 'ChatGPT',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: true,
    speed: 'Medium',
    badge: 'Text Files Only'
  },
  deepseek: {
    name: 'DeepSeek',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Medium',
    badge: 'Text Only - No Files'
  },
  qwen: {
    name: 'Qwen',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Medium',
    badge: 'Text Only - No Files'
  },
  mistral: {
    name: 'Mistral',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Fast',
    badge: 'Text Only - No Files'
  },
  nous: {
    name: 'Nous',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Medium',
    badge: 'Text Only - No Files'
  },
  tongyi: {
    name: 'Tongyi',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Medium',
    badge: 'Text Only - No Files'
  },
  trinity: {
    name: 'Trinity',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Medium',
    badge: 'Text Only - No Files'
  },
  glm: {
    name: 'GLM',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Medium',
    badge: 'Text Only - No Files'
  },
  nova: {
    name: 'Nova',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Fast',
    badge: 'Text Only - No Files'
  },
    airai: {  // ADD THIS ENTIRE BLOCK
    name: 'AirAI',
    images: false,      // Set to true if your model supports images
    pdfs: false,        // Set to true if your model supports PDFs
    videos: false,      // Set to true if your model supports videos
    audio: false,       // Set to true if your model supports audio
    text: false,        // Set to true if your model supports text files
    speed: 'Medium',    // Can be 'Ultra Fast', 'Fast', or 'Medium'
    badge: 'Text Only - No Files'  // Change based on what files it supports
  },
  'llama3.1-8b': {
    name: 'Llama 3.1 8B',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Ultra Fast',
    badge: 'Text Only - No Files'
  },
  'llama-3.3-70b': {
    name: 'Llama 3.3 70B',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Ultra Fast',
    badge: 'Text Only - No Files'
  },
  'gpt-oss-120b': {
    name: 'GPT OSS 120B',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Ultra Fast',
    badge: 'Text Only - No Files'
  },
  'qwen-3-32b': {
    name: 'Qwen 3 32B',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Ultra Fast',
    badge: 'Text Only - No Files'
  },
  'qwen-3-235b-a22b-instruct-2507': {
    name: 'Qwen 3 235B',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Fast',
    badge: 'Text Only - No Files'
  },
  'zai-glm-4.6': {
    name: 'Z.ai GLM 4.6',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Medium',
    badge: 'Text Only - No Files'
  },
  'zai-glm-4.7': {
    name: 'Z.ai GLM 4.7',
    images: false,
    pdfs: false,
    videos: false,
    audio: false,
    text: false,
    speed: 'Medium',
    badge: 'Text Only - No Files'
  }
};
  // ============================================
  // STAFF-ONLY & GUEST RESTRICTIONS
  // ============================================
  const STAFF_ONLY_MODELS = ['openai', 'nova'];
  const GUEST_ALLOWED_MODELS = ['cerebra', 'groq'];
  
  // ============================================
  // DOM ELEMENTS
  // ============================================
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendButton = document.getElementById('sendButton');
  const aiModelSelect = document.getElementById('aiModel');
  const modalOverlay = document.getElementById('modalOverlay');
  const modalTitle = document.getElementById('modalTitle');
  const modalMessage = document.getElementById('modalMessage');
  const modalButtons = document.getElementById('modalButtons');
  const modalInputContainer = document.getElementById('modalInputContainer');
  const authOverlay = document.getElementById('memberKeyOverlay');
  const scrollToBottom = document.getElementById('scrollToBottom');
  const themeToggle = document.getElementById('themeToggle');
  
  // ============================================
  // STATE VARIABLES
  // ============================================
  let conversationHistory = [];
  let callbackCounter = 0;
  let currentModel = 'gemini';
  let pendingModel = null;
  let totalMessagesSent = 0;
  let currentUser = null;
  let chatHistory = [];
  let isAuthenticated = false;
  let pendingDeleteChatId = null;
  let pendingRenameChatId = null;
  let pendingAction = null;
  let userRole = 'user';
  let currentTypingTimeout = null;
  let draftSaveTimeout = null;
  let uploadedFiles = [];
  let pinnedMessages = [];
  let favoriteChats = [];
  let messageVersions = new Map();
  let isVoiceRecording = false;
  let mediaRecorder = null;
  let audioChunks = [];
  let currentTheme = 'dark';
  let autoSaveDrafts = true;
  let streamingEnabled = false;
  let enterToSend = true;
  let chatFontSize = 14.5;
  let lastScrollPosition = 0;
  let isScrolledToBottom = true;
  
  // ============================================
  // PERFORMANCE MONITORING
  // ============================================
  const performanceMetrics = {
    apiCalls: 0,
    totalLatency: 0,
    averageLatency: 0,
    errors: 0,
    startTime: Date.now()
  };
  
  // ============================================
  // UTILITY FUNCTIONS
  // ============================================
  
  /**
   * Update placeholder text based on selected model
   */
  function updatePlaceholder() {
    const modelName = aiModelSelect.options[aiModelSelect.selectedIndex].text;
    const placeholder = chatInput.querySelector('p[data-placeholder]');
    if (placeholder) {
      placeholder.setAttribute('data-placeholder', `Message ${modelName}...`);
    }
  }
  
  /**
   * Get input text from contenteditable div
   */
  function getInputText() {
    return chatInput.textContent.trim();
  }
  
  /**
   * Clear input and reset to default state
   */
  function clearInput() {
    const modelName = aiModelSelect.options[aiModelSelect.selectedIndex].text;
    chatInput.innerHTML = `<p data-placeholder="Message ${modelName}..." style="color: #b8d5b8;"></p>`;
    uploadedFiles = [];
    updateFilePreview();
    updateCharCounter();
    updateTokenCounter();
  }
  
  /**
   * Get current script URL for selected model
   */
  function getCurrentScriptUrl() {
    return AI_MODELS[currentModel];
  }
  
  /**
   * Format timestamp for display
   */
  function formatTimestamp(date = new Date()) {
    return date.toLocaleTimeString('en-US', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  }
  
  /**
   * Format date for display
   */
  function formatDate(date = new Date()) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) {
      return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
      return 'Yesterday';
    } else {
      return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
      });
    }
  }
  
  /**
   * Generate unique ID
   */
  function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }
  
  /**
   * Estimate token count (rough approximation)
   */
  function estimateTokens(text) {
    return Math.ceil(text.length / 4);
  }
  
  /**
   * Update character counter
   */
  function updateCharCounter() {
    const charCounter = document.getElementById('charCounter');
    const text = getInputText();
    const maxChars = 4000;
    
    if (charCounter) {
      charCounter.textContent = `${text.length} / ${maxChars}`;
      charCounter.style.display = text.length > 0 ? 'block' : 'none';
      
      if (text.length > maxChars * 0.9) {
        charCounter.classList.add('warning');
      } else {
        charCounter.classList.remove('warning');
      }
      
      if (text.length > maxChars) {
        charCounter.classList.add('error');
      } else {
        charCounter.classList.remove('error');
      }
    }
  }
  
  /**
   * Update token counter
   */
  function updateTokenCounter() {
    const tokenCounter = document.getElementById('tokenCounter');
    const tokenCount = document.getElementById('tokenCount');
    const text = getInputText();
    const tokens = estimateTokens(text);
    const maxTokens = 2000;
    
    if (tokenCount) {
      tokenCount.textContent = tokens;
    }
    
    if (tokenCounter) {
      tokenCounter.classList.remove('warning', 'error');
      
      if (tokens > maxTokens * 0.8) {
        tokenCounter.classList.add('warning');
      }
      
      if (tokens > maxTokens) {
        tokenCounter.classList.add('error');
      }
    }
  }
  
  /**
   * Show error message
   */
  function showError(message) {
    showToast('Error', message, 'error');
    debugConsole.log(message, 'error');
  }
  
  /**
   * Show success message
   */
  function showSuccess(message) {
    showToast('Success', message, 'success');
    debugConsole.log(message, 'success');
  }
  
  /**
   * Show info message
   */
  function showInfo(message) {
    showToast('Info', message, 'info');
    debugConsole.log(message, 'info');
  }
  
  /**
   * Show warning message
   */
  function showWarning(message) {
    showToast('Warning', message, 'warning');
    debugConsole.log(message, 'warn');
  }
  
  /**
   * Show auth error
   */
  function showAuthError(message) {
    const errorDiv = document.getElementById('authErrorMessage');
    errorDiv.textContent = message;
    errorDiv.classList.add('show');
    setTimeout(() => {
      errorDiv.classList.remove('show');
    }, 4000);
  }
  
  /**
   * Show auth success
   */
  function showAuthSuccess(message) {
    const successDiv = document.getElementById('authSuccessMessage');
    successDiv.textContent = message;
    successDiv.classList.add('show');
    setTimeout(() => {
      successDiv.classList.remove('show');
    }, 3000);
  }
  
  /**
   * Hide auth overlay
   */
  function hideAuth() {
    authOverlay.classList.add('hidden');
  }
  
  /**
   * Show auth overlay
   */
  function showAuth() {
    authOverlay.classList.remove('hidden');
  }
  
  /**
   * Update sidebar user info
   */
function updateSidebarUser() {
  const sidebarUser = document.getElementById('sidebarUser');
  const saveChatBtn = document.getElementById('saveChatBtn');
  const modelControlBtn = document.getElementById('modelControlBtn');
  const userAvatar = sidebarUser?.querySelector('.user-avatar-small');
  
  if (isAuthenticated && currentUser) {
    const roleLabel = userRole === 'staff' ? ' (Staff)' : '';
    if (sidebarUser) {
      sidebarUser.innerHTML = `
        <span class="user-avatar-small">${currentUser.charAt(0).toUpperCase()}</span>
        ${currentUser}${roleLabel}
      `;
    }
    if (saveChatBtn) saveChatBtn.style.display = 'inline-flex';
    
    // Show model control for staff
    if (userRole === 'staff' && modelControlBtn) {
      modelControlBtn.style.display = 'inline-flex';
    }
  } else {
    if (sidebarUser) {
      sidebarUser.innerHTML = `
        <span class="user-avatar-small">G</span>
        Guest User (Cerebra & Groq Only)
      `;
    }
    if (saveChatBtn) saveChatBtn.style.display = 'none';
    if (modelControlBtn) modelControlBtn.style.display = 'none';
  }
}
  
  /**
   * Filter AI models based on user role
   */
  function filterAIModels() {
    const allOptions = aiModelSelect.querySelectorAll('option');
    
    allOptions.forEach(option => {
      const modelValue = option.value;
      
      // Staff-only restrictions
      if (userRole !== 'staff' && STAFF_ONLY_MODELS.includes(modelValue)) {
        option.style.display = 'none';
        option.disabled = true;
      }
      // Guest restrictions - only allow Cerebra and Groq
      else if (!isAuthenticated && !GUEST_ALLOWED_MODELS.includes(modelValue)) {
        option.style.display = 'none';
        option.disabled = true;
      }
      // Show for authenticated users (non-staff)
      else {
        option.style.display = '';
        option.disabled = false;
      }
    });
    
    // If current model is now disabled, switch to an allowed model
    const currentOption = aiModelSelect.querySelector(`option[value="${currentModel}"]`);
    if (currentOption && currentOption.disabled) {
      // For guests, default to cerebra
      if (!isAuthenticated) {
        currentModel = 'cerebra';
        aiModelSelect.value = 'cerebra';
      } else {
        currentModel = 'gemini';
        aiModelSelect.value = 'gemini';
      }
      updatePlaceholder();
    }
  }
  
  /**
   * Check network status
   */
  function checkNetworkStatus() {
    const networkStatus = document.getElementById('networkStatus');
    const networkStatusText = document.getElementById('networkStatusText');
    
    if (navigator.onLine) {
      if (networkStatus) {
        networkStatus.classList.add('online');
        networkStatus.classList.remove('show');
        if (networkStatusText) networkStatusText.textContent = 'Online';
      }
    } else {
      if (networkStatus) {
        networkStatus.classList.remove('online');
        networkStatus.classList.add('show');
        if (networkStatusText) networkStatusText.textContent = 'Offline';
      }
    }
  }
  
  // Initialize
  window.addEventListener('online', checkNetworkStatus);
  window.addEventListener('offline', checkNetworkStatus);
  checkNetworkStatus();
  // ============================================
  // SECTION 14: TOAST NOTIFICATIONS & UI UTILS
  // ============================================
  
  /**
   * Show toast notification
   */
  function showToast(title, message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
      success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>',
      error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
      warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
      info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
    };
    
    toast.innerHTML = `
      <div class="toast-icon">${icons[type]}</div>
      <div class="toast-content">
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
      </div>
      <button class="toast-close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Close button handler
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.addEventListener('click', () => {
      toast.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    });
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (toast.parentElement) {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }
    }, 5000);
  }
  
  /**
   * Update file preview display
   */
  function updateFilePreview() {
    const container = document.getElementById('filePreviewContainer');
    if (!container) return;
    
    if (uploadedFiles.length === 0) {
      container.style.display = 'none';
      container.innerHTML = '';
      return;
    }
    
    container.style.display = 'flex';
    container.innerHTML = '';
    
    uploadedFiles.forEach((file, index) => {
      const preview = document.createElement('div');
      preview.className = 'file-preview';
      
      const icon = getFileIcon(file.type);
      const size = formatFileSize(file.size);
      
      preview.innerHTML = `
        <svg class="file-preview-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          ${icon}
        </svg>
        <div class="file-preview-info">
          <div class="file-preview-name">${file.name}</div>
          <div class="file-preview-size">${size}</div>
        </div>
        <button class="file-preview-remove" data-index="${index}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      `;
      
      container.appendChild(preview);
    });
    
    // Add remove handlers
    container.querySelectorAll('.file-preview-remove').forEach(btn => {
      btn.addEventListener('click', () => {
        const index = parseInt(btn.dataset.index);
        uploadedFiles.splice(index, 1);
        updateFilePreview();
        showInfo('File removed');
      });
    });
  }
  
  /**
   * Get file icon SVG path
   */
  function getFileIcon(type) {
    if (type.includes('pdf')) {
      return '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline>';
    } else if (type.includes('word') || type.includes('document')) {
      return '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line>';
    } else if (type.includes('image')) {
      return '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline>';
    } else if (type.includes('code') || type.includes('text')) {
      return '<polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline>';
    }
    return '<path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>';
  }
  
  /**
   * Format file size
   */
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }
  /**
 * Get current model capabilities
 */
function getCurrentModelCapabilities() {
  return MODEL_CAPABILITIES[currentModel] || MODEL_CAPABILITIES.gemini;
}

/**
 * Check if file type is supported by current model
 */
function isFileTypeSupported(file) {
  const caps = getCurrentModelCapabilities();
  const type = file.type;
  
  if (type.startsWith('image/')) return caps.images;
  if (type === 'application/pdf') return caps.pdfs;
  if (type.startsWith('video/')) return caps.videos;
  if (type.startsWith('audio/')) return caps.audio;
  
  // Text files are supported by all models
  if (type.startsWith('text/') || 
      type === 'application/json' ||
      file.name.match(/\.(js|html|css|xml|csv|md|txt|py|java|cpp|c|go|rs|rb|php|sql|sh|yml|yaml)$/i)) {
    return caps.text;
  }
  
  return false;
}

/**
 * Show model capability tooltip
 */
function showModelTooltip() {
  const tooltip = document.getElementById('modelCapabilityTooltip');
  const tooltipContent = tooltip.querySelector('.tooltip-content');
  const caps = getCurrentModelCapabilities();
  
  const checkIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
  const crossIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
  
  // Check if model supports any files
  const hasFileSupport = caps.text || caps.images || caps.pdfs || caps.videos || caps.audio;
  
  if (!hasFileSupport) {
    tooltipContent.innerHTML = `
      <div class="tooltip-title">${caps.name}</div>
      <div class="tooltip-capability unsupported" style="color: var(--error-text); font-weight: 600;">
        ${crossIcon}
        No File Upload Support
      </div>
      <div style="margin-top: 8px; padding: 8px; background: var(--error-bg); border-radius: 6px; font-size: 11px; color: var(--error-text);">
        This model only accepts text messages. Use <strong>Gemini</strong> for files.
      </div>
      <div class="tooltip-speed">
        Speed: ${caps.speed} | Type: ${caps.badge}
      </div>
    `;
  } else {
    tooltipContent.innerHTML = `
      <div class="tooltip-title">${caps.name}</div>
      <div class="tooltip-capability ${caps.images ? 'supported' : 'unsupported'}">
        ${caps.images ? checkIcon : crossIcon}
        Images ${caps.images ? '(Supported)' : '(Not Supported)'}
      </div>
      <div class="tooltip-capability ${caps.pdfs ? 'supported' : 'unsupported'}">
        ${caps.pdfs ? checkIcon : crossIcon}
        PDFs ${caps.pdfs ? '(Supported)' : '(Not Supported)'}
      </div>
      <div class="tooltip-capability ${caps.videos ? 'supported' : 'unsupported'}">
        ${caps.videos ? checkIcon : crossIcon}
        Videos ${caps.videos ? '(Supported)' : '(Not Supported)'}
      </div>
      <div class="tooltip-capability ${caps.audio ? 'supported' : 'unsupported'}">
        ${caps.audio ? checkIcon : crossIcon}
        Audio ${caps.audio ? '(Supported)' : '(Not Supported)'}
      </div>
      <div class="tooltip-capability ${caps.text ? 'supported' : 'unsupported'}">
        ${caps.text ? checkIcon : crossIcon}
        Text/Code Files ${caps.text ? '(Supported)' : '(Not Supported)'}
      </div>
      <div class="tooltip-speed">
        Speed: ${caps.speed} | Type: ${caps.badge}
      </div>
    `;
  }
  
  tooltip.classList.add('show');
}

/**
 * Hide model capability tooltip
 */
function hideModelTooltip() {
  const tooltip = document.getElementById('modelCapabilityTooltip');
  tooltip.classList.remove('show');
}

/**
 * Show file compatibility warning
 */
function showFileWarning() {
  const caps = getCurrentModelCapabilities();
  const hasUnsupportedFiles = uploadedFiles.some(file => !isFileTypeSupported(file));
  
  if (!hasUnsupportedFiles) return;
  
  const incompatibleTypes = [];
  uploadedFiles.forEach(file => {
    if (!isFileTypeSupported(file)) {
      if (file.type.startsWith('image/')) incompatibleTypes.push('images');
      else if (file.type === 'application/pdf') incompatibleTypes.push('PDFs');
      else if (file.type.startsWith('video/')) incompatibleTypes.push('videos');
      else if (file.type.startsWith('audio/')) incompatibleTypes.push('audio');
    }
  });
  
  const uniqueTypes = [...new Set(incompatibleTypes)];
  
  if (uniqueTypes.length > 0) {
    showWarning(`Warning: ${caps.name} cannot analyze ${uniqueTypes.join(', ')}. Switch to Gemini for multimodal support.`);
  }
}

/**
 * Update file upload button with capabilities
 */
/**
 * Update file upload button with capabilities
 */
function updateFileUploadButton() {
  const btn = document.getElementById('fileUploadBtn');
  const fileInput = document.getElementById('chat-input-file-upload');
  const caps = getCurrentModelCapabilities();
  
  // No file support - disable button
  if (!caps.text && !caps.images && !caps.pdfs && !caps.videos && !caps.audio) {
    btn.disabled = true;
    btn.style.opacity = '0.3';
    btn.style.cursor = 'not-allowed';
    btn.title = 'This model does not support file uploads';
    fileInput.accept = '';
    return;
  }
  
  // Enable button
  btn.disabled = false;
  btn.style.opacity = '1';
  btn.style.cursor = 'pointer';
  
  // Set accepted file types based on capabilities
  let acceptTypes = [];
  
  // Text files
  if (caps.text) {
    acceptTypes.push(
      '.txt', '.md', '.csv', '.log', '.json', '.xml',
      '.js', '.jsx', '.ts', '.tsx', '.py', '.java', '.cpp', '.c', '.h',
      '.go', '.rs', '.rb', '.php', '.sql', '.sh', '.bash',
      '.html', '.css', '.scss', '.sass', '.less',
      '.yml', '.yaml', '.toml', '.ini', '.env', '.conf'
    );
  }
  
  // Images
  if (caps.images) {
    acceptTypes.push('image/*');
  }
  
  // PDFs
  if (caps.pdfs) {
    acceptTypes.push('.pdf', 'application/pdf');
  }
  
  // Videos
  if (caps.videos) {
    acceptTypes.push('video/*');
  }
  
  // Audio
  if (caps.audio) {
    acceptTypes.push('audio/*');
  }
  
  // Set accept attribute
  fileInput.accept = acceptTypes.join(',');
  
  // Update tooltip
  if (caps.images && caps.pdfs && caps.videos && caps.audio) {
    btn.title = 'Upload any file (images, PDFs, videos, audio, text/code)';
  } else if (caps.text && !caps.images && !caps.pdfs) {
    btn.title = 'Upload text/code files only (.txt, .js, .py, .html, etc.)';
  } else {
    btn.title = 'Upload supported files';
  }
}
  /**
   * Toggle theme
   */
  function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.body.classList.toggle('light-theme');
    
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.textContent = currentTheme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
    }
    
    // Update meta theme-color for the current color theme
    var savedColorTheme = localStorage.getItem('colorTheme') || 'green';
    applyColorTheme(savedColorTheme);
    
    // Save preference
    localStorage.setItem('theme', currentTheme);
    showInfo(`Switched to ${currentTheme} theme`);
    debugConsole.log(`Theme changed to ${currentTheme}`, 'info');
  }
  
  /**
   * Apply chat font size to all message content elements
   */
  function applyChatFontSize(size) {
    document.querySelectorAll('.message-content').forEach(function(el) {
      el.style.fontSize = size + 'px';
    });
    // Store for new messages via CSS custom property
    document.documentElement.style.setProperty('--chat-font-size', size + 'px');
  }

  /**
   * Apply a color theme
   */
  function applyColorTheme(theme) {
    // Remove all color theme classes
    document.body.classList.remove('theme-blue', 'theme-purple', 'theme-rose', 'theme-amber', 'theme-teal');
    
    // Apply the new theme (green is default, no class needed)
    if (theme && theme !== 'green') {
      document.body.classList.add('theme-' + theme);
    }
    
    // Update meta theme-color
    var themeColors = {
      green: currentTheme === 'light' ? '#f5f7f5' : '#040d01',
      blue: currentTheme === 'light' ? '#f0f4fa' : '#010a14',
      purple: currentTheme === 'light' ? '#f6f0fa' : '#0a0410',
      rose: currentTheme === 'light' ? '#faf0f4' : '#140108',
      amber: currentTheme === 'light' ? '#faf6f0' : '#140a01',
      teal: currentTheme === 'light' ? '#f0fafa' : '#010e0e'
    };
    var metaThemeColor = document.querySelector('meta[name="theme-color"]');
    if (metaThemeColor) {
      metaThemeColor.setAttribute('content', themeColors[theme] || themeColors.green);
    }
    
    // Save preference
    localStorage.setItem('colorTheme', theme);
    debugConsole.log('Color theme changed to ' + theme, 'info');
  }
  
  /**
   * Load color theme preference
   */
  function loadColorThemePreference() {
    var savedColorTheme = localStorage.getItem('colorTheme');
    if (savedColorTheme && savedColorTheme !== 'green') {
      applyColorTheme(savedColorTheme);
    }
  }

  /**
   * Load theme preference
   */
  function loadThemePreference() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme && savedTheme !== currentTheme) {
      toggleTheme();
    }
    loadColorThemePreference();
  }
  
  /**
   * Hide modal
   */
  function hideModal() {
    modalOverlay.classList.remove('active');
    modalInputContainer.innerHTML = '';
    pendingModel = null;
    pendingDeleteChatId = null;
    pendingRenameChatId = null;
    pendingAction = null;
  }
  
  /**
   * Get modal input value
   */
  function getModalInputValue() {
    const input = document.getElementById('modalNameInput');
    return input ? input.value.trim() : '';
  }
  
  /**
   * Show modal
   */
  function showModal(title, message, buttons, showInput = false, inputPlaceholder = '', inputValue = '') {
    modalTitle.textContent = title;
    modalMessage.innerHTML = message;
    modalButtons.innerHTML = '';
    modalInputContainer.innerHTML = '';
    
    if (showInput) {
      const inputGroup = document.createElement('div');
      inputGroup.className = 'modal-input-group';
      inputGroup.innerHTML = `
        <label class="modal-label">${inputPlaceholder}</label>
        <input type="text" class="modal-input" id="modalNameInput" value="${inputValue}" placeholder="Enter value...">
      `;
      modalInputContainer.appendChild(inputGroup);
      
      setTimeout(() => {
        const input = document.getElementById('modalNameInput');
        if (input) {
          input.focus();
          input.select();
        }
      }, 100);
    }
    
    buttons.forEach(btn => {
      const button = document.createElement('button');
      button.className = `modal-button ${btn.type}`;
      
      if (btn.icon) {
        button.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            ${btn.icon}
          </svg>
          ${btn.text}
        `;
      } else {
        button.textContent = btn.text;
      }
      
      button.onclick = btn.action;
      modalButtons.appendChild(button);
    });
    
    modalOverlay.classList.add('active');
  }
  
  /**
   * Show loading state
   */
  function showLoading(message = 'Loading...') {
    const loading = document.createElement('div');
    loading.className = 'loading-container';
    loading.id = 'globalLoading';
    loading.innerHTML = `
      <div class="loading-spinner"></div>
      <div class="loading-text">${message}</div>
    `;
    document.body.appendChild(loading);
  }
  
  /**
   * Hide loading state
   */
  function hideLoading() {
    const loading = document.getElementById('globalLoading');
    if (loading) loading.remove();
  }
  
  /**
   * Debounce function
   */
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  /**
   * Throttle function
   */
  function throttle(func, limit) {
    let inThrottle;
    return function(...args) {
      if (!inThrottle) {
        func.apply(this, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    };
  }
  
  /**
   * Copy to clipboard with fallback
   */
  function copyToClipboard(text) {
    if (navigator.clipboard && window.isSecureContext) {
      return navigator.clipboard.writeText(text)
        .then(() => true)
        .catch(() => fallbackCopyToClipboard(text));
    } else {
      return fallbackCopyToClipboard(text);
    }
  }
  
  /**
   * Fallback copy method
   */
  function fallbackCopyToClipboard(text) {
    return new Promise((resolve, reject) => {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.left = '-999999px';
      textarea.style.top = '-999999px';
      document.body.appendChild(textarea);
      
      textarea.focus();
      textarea.select();
      
      try {
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (successful) {
          resolve(true);
        } else {
          reject(new Error('execCommand failed'));
        }
      } catch (err) {
        document.body.removeChild(textarea);
        reject(err);
      }
    });
  }
  
  /**
   * Save draft to localStorage
   */
  function saveDraft() {
    if (!autoSaveDrafts) return;
    
    const text = getInputText();
    if (text.length > 0) {
      localStorage.setItem('chatDraft', text);
      
      const draftIndicator = document.getElementById('draftIndicator');
      if (draftIndicator) {
        draftIndicator.classList.add('show');
        setTimeout(() => {
          draftIndicator.classList.remove('show');
        }, 2000);
      }
    } else {
      localStorage.removeItem('chatDraft');
    }
  }
  
  /**
   * Load draft from localStorage
   */
  function loadDraft() {
    const draft = localStorage.getItem('chatDraft');
    if (draft && conversationHistory.length === 0) {
      chatInput.textContent = draft;
      updateCharCounter();
      updateTokenCounter();
      showInfo('Draft restored');
    }
  }
  
  /**
   * Clear draft
   */
  function clearDraft() {
    localStorage.removeItem('chatDraft');
  }
  
  /**
   * Scroll to bottom of chat
   */
  function scrollToBottomSmooth() {
    chatMessages.scrollTo({
      top: chatMessages.scrollHeight,
      behavior: 'smooth'
    });
    isScrolledToBottom = true;
    scrollToBottom.classList.remove('show');
  }
  
  /**
   * Check if scrolled to bottom
   */
  function checkScrollPosition() {
    const threshold = 100;
    const isAtBottom = chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < threshold;
    
    isScrolledToBottom = isAtBottom;
    
    if (isAtBottom) {
      scrollToBottom.classList.remove('show');
    } else {
      scrollToBottom.classList.add('show');
    }
  }
  
  /**
   * Sanitize HTML to prevent XSS
   */
  function sanitizeHTML(html) {
    const temp = document.createElement('div');
    temp.textContent = html;
    return temp.innerHTML;
  }
  
  /**
   * Format duration in milliseconds
   */
  function formatDuration(ms) {
    if (ms < 1000) return `${ms}ms`;
    if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
    return `${Math.floor(ms / 60000)}m ${Math.floor((ms % 60000) / 1000)}s`;
  }
  
  /**
   * Get relative time string
   */
  function getRelativeTime(date) {
    const now = new Date();
    const diff = now - date;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (seconds < 60) return 'just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
  }
  
  // Debounced save draft
  const debouncedSaveDraft = debounce(saveDraft, 1000);
  
  // Throttled scroll check
  const throttledScrollCheck = throttle(checkScrollPosition, 100);
  // ============================================
  // SECTION 15: MARKDOWN PARSER & SYNTAX
  // ============================================
  
  /**
   * Detect programming language from code
   */
  function detectLanguage(code) {
    code = code.trim();
    
    // HTML detection
    if (code.startsWith('<!DOCTYPE') || code.startsWith('<html') || /<[a-z][\s\S]*>/i.test(code)) {
      return 'html';
    }
    
    // CSS detection
    if (/^[\s]*[\w-]+\s*{[\s\S]*}/.test(code) || code.includes('@media') || code.includes('@import') || code.includes('@keyframes')) {
      return 'css';
    }
    
    // JSON detection
    if ((code.startsWith('{') && code.endsWith('}')) || (code.startsWith('[') && code.endsWith(']'))) {
      try {
        JSON.parse(code);
        return 'json';
      } catch (e) {}
    }
    
    // JavaScript/TypeScript detection
    if (/\b(function|const|let|var|=>|console\.|document\.|window\.|import\s|export\s|async\s|await\s)\b/.test(code)) {
      return 'javascript';
    }
    
    // Python detection
    if (/\b(def|import|from|class|print|if __name__|elif|lambda|yield)\b/.test(code) || /^\s*def\s+\w+\s*\(/.test(code)) {
      return 'python';
    }
    
    // Java detection
    if (/\b(public|private|class|void|static|System\.out|new\s+\w+\()\b/.test(code)) {
      return 'java';
    }
    
    // C/C++ detection
    if (/#include|int main\(|printf\(|std::|cout\s*<</.test(code)) {
      return 'cpp';
    }
    
    // PHP detection
    if (code.startsWith('<?php') || /\$\w+/.test(code)) {
      return 'php';
    }
    
    // SQL detection
    if (/\b(SELECT|INSERT|UPDATE|DELETE|CREATE|TABLE|FROM|WHERE|JOIN)\b/i.test(code)) {
      return 'sql';
    }
    
    // Bash/Shell detection
    if (code.startsWith('#!') || /\b(echo|cd|ls|mkdir|chmod|grep|awk|sed)\b/.test(code)) {
      return 'bash';
    }
    
    // Ruby detection
    if (/\b(def|end|puts|require|class)\b/.test(code) && !code.includes('function')) {
      return 'ruby';
    }
    
    // Go detection
    if (/\b(package|func|import|fmt\.|var\s+\w+\s+\w+)\b/.test(code)) {
      return 'go';
    }
    
    // Rust detection
    if (/\b(fn|let mut|impl|use|pub|struct)\b/.test(code)) {
      return 'rust';
    }
    
    // Swift detection
    if (/\b(func|var|let|import|class|struct|enum)\b/.test(code) && code.includes(':')) {
      return 'swift';
    }
    
    return 'code';
  }
  
  /**
   * Apply syntax highlighting to code
   */
  function highlightSyntax(code, language) {
    code = code.replace(/&/g, '&amp;')
               .replace(/</g, '&lt;')
               .replace(/>/g, '&gt;');
    
    if (language === 'javascript' || language === 'js') {
      code = code.replace(/\b(function|const|let|var|if|else|for|while|return|import|export|class|extends|async|await|try|catch|throw|new|this|typeof|instanceof)\b/g, 
        '<span class="token keyword">$1</span>');
      code = code.replace(/(['"`])(?:(?=(\\?))\2.)*?\1/g, 
        '<span class="token string">$&</span>');
      code = code.replace(/\b(\d+\.?\d*)\b/g, 
        '<span class="token number">$1</span>');
      code = code.replace(/\b([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\(/g, 
        '<span class="token function">$1</span>(');
      code = code.replace(/(\/\/.*$)/gm, 
        '<span class="token comment">$1</span>');
      code = code.replace(/(\/\*[\s\S]*?\*\/)/g, 
        '<span class="token comment">$1</span>');
    }
    else if (language === 'python') {
      code = code.replace(/\b(def|class|if|elif|else|for|while|return|import|from|as|try|except|finally|with|lambda|yield|pass|break|continue|raise|assert|global|nonlocal)\b/g, 
        '<span class="token keyword">$1</span>');
      code = code.replace(/(['"])(?:(?=(\\?))\2.)*?\1/g, 
        '<span class="token string">$&</span>');
      code = code.replace(/\b(\d+\.?\d*)\b/g, 
        '<span class="token number">$1</span>');
      code = code.replace(/\bdef\s+([a-zA-Z_][a-zA-Z0-9_]*)/g, 
        'def <span class="token function">$1</span>');
      code = code.replace(/(#.*$)/gm, 
        '<span class="token comment">$1</span>');
    }
    else if (language === 'html') {
      code = code.replace(/(&lt;\/?[a-zA-Z][a-zA-Z0-9]*)/g, 
        '<span class="token keyword">$1</span>');
      code = code.replace(/(&gt;)/g, 
        '<span class="token keyword">$1</span>');
      code = code.replace(/\b([a-zA-Z-]+)=/g, 
        '<span class="token variable">$1</span>=');
      code = code.replace(/=(['"])([^'"]*)\1/g, 
        '=<span class="token string">$1$2$1</span>');
    }
    else if (language === 'css') {
      code = code.replace(/^([.#]?[a-zA-Z][a-zA-Z0-9_-]*)/gm, 
        '<span class="token class-name">$1</span>');
      code = code.replace(/([a-zA-Z-]+):/g, 
        '<span class="token variable">$1</span>:');
      code = code.replace(/:\s*([^;{]+)/g, 
        ': <span class="token string">$1</span>');
      code = code.replace(/\b(\d+(?:px|em|rem|%|vh|vw))\b/g, 
        '<span class="token number">$1</span>');
    }
    else if (language === 'json') {
      code = code.replace(/"([^"]+)":/g, 
        '<span class="token variable">"$1"</span>:');
      code = code.replace(/:\s*"([^"]*)"/g, 
        ': <span class="token string">"$1"</span>');
      code = code.replace(/:\s*(\d+\.?\d*)/g, 
        ': <span class="token number">$1</span>');
      code = code.replace(/\b(true|false|null)\b/g, 
        '<span class="token keyword">$1</span>');
    }
    
    return code;
  }
  
  /**
   * Parse markdown text to HTML
   */
  function parseMarkdown(text) {
    const codeBlocks = [];
    let codeBlockIndex = 0;
    
    // Extract code blocks with language
    text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, lang, code) {
      const detectedLang = lang || detectLanguage(code);
      const placeholder = `___CODE_BLOCK_${codeBlockIndex}___`;
      codeBlocks.push({ code: code.trim(), language: detectedLang });
      codeBlockIndex++;
      return placeholder;
    });
    
    // Extract code blocks without language
    text = text.replace(/```\n?([\s\S]*?)```/g, function(match, code) {
      const detectedLang = detectLanguage(code);
      const placeholder = `___CODE_BLOCK_${codeBlockIndex}___`;
      codeBlocks.push({ code: code.trim(), language: detectedLang });
      codeBlockIndex++;
      return placeholder;
    });
    
    // Escape HTML
    text = text.replace(/&/g, '&amp;')
               .replace(/</g, '&lt;')
               .replace(/>/g, '&gt;');
    
    // Remove markdown heading symbols and convert to styled text
    text = text.replace(/(^|\n)(#{1,6})\s+(.+?)(?=\n|$)/g, function(match, lineStart, hashes, content) {
      const level = hashes.length;
      const sizes = { 1: '22px', 2: '20px', 3: '18px', 4: '16px', 5: '15px', 6: '14px' };
      const margins = { 1: '18px 0 14px 0', 2: '16px 0 12px 0', 3: '14px 0 10px 0', 4: '12px 0 8px 0', 5: '10px 0 6px 0', 6: '8px 0 4px 0' };
      return `${lineStart}<div style="color: #a8d5a8; font-size: ${sizes[level]}; font-weight: 600; margin: ${margins[level]};">${content.trim()}</div>`;
    });
    
    // Handle inline code - skip placeholders
    text = text.replace(/`([^`]+)`/g, function(match, code) {
      if (code.startsWith('___CODE_BLOCK_')) return match;
      return '<code>' + code + '</code>';
    });
    
    // Remove stray quotes
    text = text.replace(/''''/g, '');
    text = text.replace(/'''/g, '');
    
    // Bold and italic
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/__(.+?)__/g, '<strong>$1</strong>');
    text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
    text = text.replace(/_(.+?)_/g, '<em>$1</em>');
    
    // Links
    text = text.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank" style="color: #a8d5a8; text-decoration: underline;">$1</a>');
    
    // Lists
    text = text.replace(/(^|\n)([-*+])\s+(.+?)(?=\n|$)/g, function(match, lineStart, marker, content) {
      return `${lineStart}<li style="margin-left: 20px; color: #b8d5b8;">${content}</li>`;
    });
    text = text.replace(/(^|\n)(\d+)\.\s+(.+?)(?=\n|$)/g, function(match, lineStart, num, content) {
      return `${lineStart}<li style="margin-left: 20px; color: #b8d5b8; list-style-type: decimal;">${content}</li>`;
    });
    
    // Blockquotes
    text = text.replace(/(^|\n)>\s+(.+?)(?=\n|$)/g, function(match, lineStart, content) {
      return `${lineStart}<blockquote style="border-left: 3px solid #2a4a2a; padding-left: 12px; margin: 8px 0; color: #8ab88a; font-style: italic;">${content}</blockquote>`;
    });
    
    // Horizontal rules
    text = text.replace(/(^|\n)([-*_]){3,}(?=\n|$)/g, '$1<hr style="border: none; border-top: 1px solid #2a4a2a; margin: 16px 0;">');
    
    // Line breaks
    text = text.replace(/\n/g, '<br>');
    
    // Replace code block placeholders
    text = text.replace(/___CODE_BLOCK_(\d+)___/g, function(match, index) {
      const block = codeBlocks[parseInt(index)];
      if (!block) return match;
      
      const lines = block.code.split('\n');
      const lineNumbers = lines.map((_, i) => `<span class="line-num">${i + 1}</span>`).join('');
      const highlightedCode = highlightSyntax(block.code, block.language);
      const languageLabel = block.language.toUpperCase();
      
      return `
        <div class="code-block-wrapper">
          <div class="code-header">
            <span class="code-language">${languageLabel}</span>
            <button class="code-copy-btn" onclick="copyCodeEnhanced(this, \`${block.code.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              Copy
            </button>
          </div>
          <div class="code-with-lines">
            <div class="code-line-numbers">${lineNumbers}</div>
            <div class="code-content-wrapper">
              <pre><code>${highlightedCode}</code></pre>
            </div>
          </div>
        </div>
      `;
    });
    
    return text;
  }
  
  /**
   * Copy code with enhanced feedback
   */
  function copyCodeEnhanced(button, code) {
    const decodedCode = code.replace(/\\`/g, '`').replace(/\\\$/g, '$');
    
    copyToClipboard(decodedCode).then(() => {
      const originalHTML = button.innerHTML;
      button.classList.add('copied');
      button.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Copied!
      `;
      
      setTimeout(() => {
        button.classList.remove('copied');
        button.innerHTML = originalHTML;
      }, 2000);
    }).catch(err => {
      debugConsole.log('Failed to copy code: ' + err.message, 'error');
      button.classList.add('error');
      button.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
        Failed
      `;
      
      setTimeout(() => {
        button.classList.remove('error');
        button.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copy
        `;
      }, 2000);
    });
  }
  
  /**
   * Copy message content
   */
  function copyMessageContent(button) {
    const actionsDiv = button.closest('.message-actions');
    const content = actionsDiv.dataset.content;
    
    const plainText = content.replace(/\*\*(.*?)\*\*/g, '$1')
                            .replace(/\*(.*?)\*/g, '$1')
                            .replace(/`(.*?)`/g, '$1')
                            .replace(/\[(.*?)\]\(.*?\)/g, '$1');
    
    copyToClipboard(plainText).then(() => {
      const originalHTML = button.innerHTML;
      button.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Copied!
      `;
      button.classList.add('active');
      
      setTimeout(() => {
        button.innerHTML = originalHTML;
        button.classList.remove('active');
      }, 2000);
    }).catch(err => {
      debugConsole.log('Failed to copy: ' + err.message, 'error');
      showError('Failed to copy message');
    });
  }
  // ============================================
  // SECTION 16: MESSAGE DISPLAY & ACTIONS
  // ============================================
  
  /**
   * Type message character by character
   */
  function typeMessage(text, contentDiv, callback) {
    let index = 0;
    const cursor = document.createElement('span');
    cursor.className = 'cursor-blink';
    contentDiv.appendChild(cursor);
    
    function typeChar() {
      if (index < text.length) {
        const char = text[index];
        const textNode = document.createTextNode(char);
        contentDiv.insertBefore(textNode, cursor);
        index++;
        
        if (index % 50 === 0 || index === text.length) {
          if (isScrolledToBottom) {
            chatMessages.scrollTo({
              top: chatMessages.scrollHeight,
              behavior: 'smooth'
            });
          }
        }
        
        const delay = char === ' ' ? 3 : (Math.random() * 5 + 3);
        currentTypingTimeout = setTimeout(typeChar, delay);
      } else {
        cursor.remove();
        contentDiv.innerHTML = parseMarkdown(text);
        
        if (isScrolledToBottom) {
          chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: 'smooth'
          });
        }
        
        if (callback) callback();
      }
    }
    
    typeChar();
  }
  
  /**
   * Add message to chat
   */
  function addMessage(content, isUser, useTyping = false, metadata = {}) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + (isUser ? 'user' : 'assistant');
    messageDiv.dataset.id = generateId();
    messageDiv.dataset.timestamp = Date.now();
    
    if (metadata.pinned) {
      messageDiv.classList.add('pinned');
    }
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = isUser ? currentUser?.charAt(0).toUpperCase() || 'You' : 'AI';
    
    if (!isUser) {
      const statusIndicator = document.createElement('span');
      statusIndicator.className = 'avatar-status';
      avatar.appendChild(statusIndicator);
    }
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (isUser) {
      contentDiv.textContent = content;
      
      const timestamp = document.createElement('span');
      timestamp.className = 'message-timestamp';
      timestamp.textContent = formatTimestamp();
      contentDiv.appendChild(timestamp);
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);
      chatMessages.appendChild(messageDiv);
      
      if (isScrolledToBottom) {
        chatMessages.scrollTo({
          top: chatMessages.scrollHeight,
          behavior: 'smooth'
        });
      }
    } else {
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(contentDiv);
      chatMessages.appendChild(messageDiv);
      
      if (useTyping) {
        typeMessage(content, contentDiv, () => {
          addMessageActions(messageDiv, isUser, content);
          addMessageMetadata(messageDiv, metadata);
        });
      } else {
        contentDiv.innerHTML = parseMarkdown(content);
        
        if (isScrolledToBottom) {
          chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: 'smooth'
          });
        }
        
        addMessageActions(messageDiv, isUser, content);
        addMessageMetadata(messageDiv, metadata);
      }
    }
    
    return messageDiv;
  }
  
  /**
   * Add message actions
   */
  function addMessageActions(messageDiv, isUser, messageContent) {
    if (isUser) return;
    
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'message-actions';
    actionsDiv.dataset.content = messageContent;
    
    actionsDiv.innerHTML = `
      <button class="msg-action" onclick="copyMessageContent(this)" title="Copy">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        Copy
      </button>
      <button class="msg-action" onclick="regenerateMessage(this)" title="Regenerate">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
        </svg>
        Regenerate
      </button>
      <button class="msg-action" onclick="readAloud(this)" title="Read Aloud">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
          <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
        Read
      </button>
      <button class="msg-action" onclick="pinMessage(this)" title="Pin">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 17v5m-3-2h6m-3-3V9m0 0l4-4H8l4 4z"></path>
        </svg>
        Pin
      </button>
      <button class="msg-action" onclick="editMessage(this)" title="Edit">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
        Edit
      </button>
      <button class="msg-action" onclick="showReactions(this)" title="React">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
          <line x1="9" y1="9" x2="9.01" y2="9"></line>
          <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
        React
      </button>
    `;
    
    messageDiv.appendChild(actionsDiv);
  }
  
  /**
   * Add message metadata
   */
  function addMessageMetadata(messageDiv, metadata) {
    if (!metadata || Object.keys(metadata).length === 0) return;
    
    const metadataDiv = document.createElement('div');
    metadataDiv.className = 'message-metadata';
    
    let html = '';
    
    if (metadata.model) {
      html += `
        <div class="metadata-item">
          <span class="model-badge">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
              <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
            </svg>
            ${metadata.model}
          </span>
        </div>
      `;
    }
    
    if (metadata.responseTime) {
      const timeClass = metadata.responseTime < 2000 ? 'fast' : metadata.responseTime > 5000 ? 'slow' : '';
      html += `
        <div class="metadata-item">
          <span class="response-time ${timeClass}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            ${formatDuration(metadata.responseTime)}
          </span>
        </div>
      `;
    }
    
    if (metadata.tokens) {
      html += `
        <div class="metadata-item">
          <span class="message-tokens">${metadata.tokens} tokens</span>
        </div>
      `;
    }
    
    if (html) {
      metadataDiv.innerHTML = html;
      messageDiv.querySelector('.message-content').appendChild(metadataDiv);
    }
  }
  
  /**
   * Regenerate message
   */
  function regenerateMessage(button) {
    const actionsDiv = button.closest('.message-actions');
    const messageDiv = actionsDiv.closest('.message');
    
    if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'assistant') {
      conversationHistory.pop();
    }
    
    messageDiv.remove();
    
    if (conversationHistory.length > 0) {
      const lastUserMessage = conversationHistory[conversationHistory.length - 1].content;
      sendMessage(lastUserMessage, true);
    }
  }
  
  /**
   * Read message aloud
   */
  let currentUtterance = null;
  
  function readAloud(button) {
    const actionsDiv = button.closest('.message-actions');
    const content = actionsDiv.dataset.content;
    
    if ('speechSynthesis' in window) {
      if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        button.classList.remove('active');
        return;
      }
      
      const textToSpeak = content.replace(/\*\*(.*?)\*\*/g, '$1')
                                .replace(/\*(.*?)\*/g, '$1')
                                .replace(/`(.*?)`/g, '$1')
                                .replace(/\[(.*?)\]\(.*?\)/g, '$1')
                                .replace(/#{1,6}\s/g, '')
                                .replace(/```[\s\S]*?```/g, '[code block]');
      
      currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
      currentUtterance.rate = 1.0;
      currentUtterance.pitch = 1.0;
      currentUtterance.volume = 1.0;
      
      button.classList.add('active');
      
      currentUtterance.onend = () => {
        button.classList.remove('active');
      };
      
      currentUtterance.onerror = () => {
        button.classList.remove('active');
        showError('Speech synthesis failed');
      };
      
      window.speechSynthesis.speak(currentUtterance);
    } else {
      showError('Speech synthesis not supported in this browser');
    }
  }
  
  /**
   * Pin message
   */
  function pinMessage(button) {
    const messageDiv = button.closest('.message');
    const messageId = messageDiv.dataset.id;
    
    if (messageDiv.classList.contains('pinned')) {
      messageDiv.classList.remove('pinned');
      pinnedMessages = pinnedMessages.filter(id => id !== messageId);
      button.classList.remove('active');
      showInfo('Message unpinned');
    } else {
      messageDiv.classList.add('pinned');
      pinnedMessages.push(messageId);
      button.classList.add('active');
      showSuccess('Message pinned');
    }
  }
  
  /**
   * Edit message
   */
  function editMessage(button) {
    const messageDiv = button.closest('.message');
    const contentDiv = messageDiv.querySelector('.message-content');
    const originalContent = button.closest('.message-actions').dataset.content;
    
    messageDiv.classList.add('message-edit-mode');
    
    contentDiv.innerHTML = `
      <textarea class="message-edit-input">${originalContent}</textarea>
      <div class="message-edit-actions">
        <button class="edit-action-btn edit-save">Save</button>
        <button class="edit-action-btn edit-cancel">Cancel</button>
      </div>
    `;
    
    const textarea = contentDiv.querySelector('.message-edit-input');
    const saveBtn = contentDiv.querySelector('.edit-save');
    const cancelBtn = contentDiv.querySelector('.edit-cancel');
    
    textarea.focus();
    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    
    saveBtn.addEventListener('click', () => {
      const newContent = textarea.value.trim();
      if (newContent) {
        contentDiv.innerHTML = parseMarkdown(newContent);
        button.closest('.message-actions').dataset.content = newContent;
        messageDiv.classList.remove('message-edit-mode');
        
        // Store version
        const messageId = messageDiv.dataset.id;
        if (!messageVersions.has(messageId)) {
          messageVersions.set(messageId, [originalContent]);
        }
        messageVersions.get(messageId).push(newContent);
        
        addMessageActions(messageDiv, false, newContent);
        showSuccess('Message updated');
      }
    });
    
    cancelBtn.addEventListener('click', () => {
      contentDiv.innerHTML = parseMarkdown(originalContent);
      messageDiv.classList.remove('message-edit-mode');
      addMessageActions(messageDiv, false, originalContent);
    });
  }
  
  /**
   * Show reaction picker
   */
  function showReactions(button) {
    const messageDiv = button.closest('.message');
    let picker = messageDiv.querySelector('.reaction-picker');
    
    if (picker) {
      picker.classList.toggle('show');
      return;
    }
    
    picker = document.createElement('div');
    picker.className = 'reaction-picker';
    
    const reactions = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸŽ‰', 'ðŸ”¥', 'ðŸ‘'];
    
    reactions.forEach(emoji => {
      const btn = document.createElement('button');
      btn.className = 'reaction-option';
      btn.textContent = emoji;
      btn.addEventListener('click', () => {
        addReaction(messageDiv, emoji);
        picker.classList.remove('show');
      });
      picker.appendChild(btn);
    });
    
    messageDiv.appendChild(picker);
    picker.classList.add('show');
  }
  
  /**
   * Add reaction to message
   */
  function addReaction(messageDiv, emoji) {
    let reactionsDiv = messageDiv.querySelector('.message-reactions');
    
    if (!reactionsDiv) {
      reactionsDiv = document.createElement('div');
      reactionsDiv.className = 'message-reactions';
      messageDiv.querySelector('.message-content').appendChild(reactionsDiv);
    }
    
    // Check if reaction already exists
    const existing = Array.from(reactionsDiv.querySelectorAll('.reaction')).find(r => 
      r.querySelector('.reaction-emoji').textContent === emoji
    );
    
    if (existing) {
      const count = existing.querySelector('.reaction-count');
      count.textContent = parseInt(count.textContent) + 1;
      existing.classList.add('active');
    } else {
      const reaction = document.createElement('div');
      reaction.className = 'reaction active';
      reaction.innerHTML = `
        <span class="reaction-emoji">${emoji}</span>
        <span class="reaction-count">1</span>
      `;
      reactionsDiv.appendChild(reaction);
    }
  }
  // ============================================
  // SECTION 17: SEND MESSAGE & API HANDLING
  // ============================================
  
/**
 * Read file as base64
 */
function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      // Get base64 string without the data URL prefix
      const base64 = e.target.result.split(',')[1];
      resolve(base64);
    };
    
    reader.onerror = function(error) {
      reject(error);
    };
    
    reader.readAsDataURL(file);
  });
}
/**
 * Main send message function
 */
/**
 * Main send message function (COMPLETE VERSION with model check)
 */
/**
 * Main send message function (COMPLETE VERSION with model check)
 */
/**
 * Main send message function (COMPLETE VERSION with model check)
 */
async function sendMessage(messageText = null, isRegenerate = false) {
    // ========================================
    // CRITICAL: BLOCK DISABLED MODELS FIRST
    // ========================================
    const availability = isModelAvailable(currentModel);
    
    // HARD BLOCK for non-staff users
    if (availability === false && userRole !== 'staff') {
      showError('This model is disabled. Please select another model.');
      showBlockerOverlay('This model is disabled for you.');
      setTimeout(hideBlockerOverlay, 2000);
      return; // *** STOP EXECUTION ***
    }
    
    // Staff warning (optional bypass)
    if (availability === false && userRole === 'staff') {
      const confirmed = await new Promise((resolve) => {
        showModal(
          'Model Restricted',
          'This model is currently disabled. As staff, you can still use it. Continue?',
          [
            { 
              text: 'Cancel', 
              type: 'cancel', 
              action: () => { 
                hideModal(); 
                resolve(false); 
              } 
            },
            { 
              text: 'Continue', 
              type: 'confirm', 
              action: () => { 
                hideModal(); 
                resolve(true); 
              }
            }
          ]
        );
      });
      
      if (!confirmed) {
        return; // *** STOP IF STAFF CANCELLED ***
      }
    }

    const message = messageText || getInputText();
    if (!message && uploadedFiles.length === 0) return;

    // Handle special commands
    if (handleSpecialCommands(message)) {
      return;
    }

    // Process uploaded files
    let fileData = [];
    if (uploadedFiles.length > 0) {
      showLoading('Processing files...');
      
      for (const file of uploadedFiles) {
        try {
          const content = await readFileAsBase64(file);
          fileData.push({
            name: file.name,
            type: file.type,
            size: file.size,
            content: content
          });
        } catch (error) {
          hideLoading();
          showError(`Failed to read file: ${file.name}`);
          debugConsole.log(`File read error: ${error.message}`, 'error');
          return;
        }
      }
      
      hideLoading();
    }

    // Build message content
    let messageContent = message;
    if (fileData.length > 0) {
      messageContent += '\n\n[Attached Files: ' + fileData.map(f => f.name).join(', ') + ']';
    }

    // Add user message
    if (!isRegenerate) {
      addMessage(messageContent, true);
      clearInput();
      uploadedFiles = [];
      updateFilePreview();
    }
    
    sendButton.disabled = true;
    totalMessagesSent++;
    
    // Remove existing typing indicator
    let existingTyping = document.querySelector('.typing-indicator');
    if (existingTyping && existingTyping.parentElement === chatMessages) {
      existingTyping.remove();
    }
    
    // Add typing indicator
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator active';
    typingDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    chatMessages.appendChild(typingDiv);
    
    if (isScrolledToBottom) {
      chatMessages.scrollTo({
        top: chatMessages.scrollHeight,
        behavior: 'smooth'
      });
    }

    // Add to conversation history with file data
    const userMessage = {
      role: 'user',
      content: message
    };
    
    if (fileData.length > 0) {
      userMessage.files = fileData;
    }
    
    conversationHistory.push(userMessage);

    // ========================================
    // CEREBRAS MODEL CHECK - Pass model parameter
    // ========================================
    const cerebrasModels = [
      'llama3.1-8b', 'llama-3.3-70b', 'gpt-oss-120b', 'qwen-3-32b',
      'qwen-3-235b-a22b-instruct-2507', 'zai-glm-4.6', 'zai-glm-4.7'
    ];
    
    const isCerebrasModel = cerebrasModels.includes(currentModel);

    // Prepare API call
    const callbackName = 'jsonpCallback' + (callbackCounter++);
    const startTime = performance.now();
    
    window[callbackName] = function(data) {
      const endTime = performance.now();
      const responseTime = endTime - startTime;
      
      const typingDiv = document.querySelector('.typing-indicator');
      if (typingDiv) typingDiv.remove();
      
      performanceMetrics.apiCalls++;
      performanceMetrics.totalLatency += responseTime;
      performanceMetrics.averageLatency = performanceMetrics.totalLatency / performanceMetrics.apiCalls;
      
      if (data.error) {
        showError('Error: ' + data.error);
        debugConsole.log('API Error: ' + data.error, 'error');
        performanceMetrics.errors++;
        sendButton.disabled = false;
        showRetryOption(message);
      } else if (data.content && data.content[0]) {
        const assistantMessage = data.content[0].text;
        conversationHistory.push({ 
          role: 'assistant', 
          content: assistantMessage 
        });
        
        const metadata = {
          model: aiModelSelect.options[aiModelSelect.selectedIndex].text,
          responseTime: responseTime,
          tokens: estimateTokens(assistantMessage)
        };
        
        addMessage(assistantMessage, false, true, metadata);
        sendButton.disabled = false;
        
        debugConsole.log(`API Success: ${responseTime.toFixed(0)}ms`, 'api');
        clearDraft();
      } else {
        showError('Unexpected response format');
        debugConsole.log('Unexpected response format: ' + JSON.stringify(data), 'error');
        performanceMetrics.errors++;
        sendButton.disabled = false;
      }
      
      delete window[callbackName];
    };

    const script = document.createElement('script');
    
    // Build parameters
    let params = 'callback=' + callbackName + '&messages=' + encodeURIComponent(JSON.stringify(conversationHistory));
    
    // *** ADD MODEL PARAMETER FOR CEREBRAS MODELS ***
    if (isCerebrasModel) {
      params += '&model=' + encodeURIComponent(currentModel);
      debugConsole.log(`CB Model: ${currentModel}`, 'info');
    }
    
    script.src = getCurrentScriptUrl() + '?' + params;
    
    script.onerror = function() {
      const typingDiv = document.querySelector('.typing-indicator');
      if (typingDiv) typingDiv.remove();
      
      showError('Failed to connect to the server. Please check your connection and try again.');
      debugConsole.log('API connection failed', 'error');
      performanceMetrics.errors++;
      sendButton.disabled = false;
      chatInput.focus();
      showRetryOption(message);
      delete window[callbackName];
    };
    
    document.body.appendChild(script);
    debugConsole.log(`API_CALL: ${getCurrentScriptUrl().substring(0, 80)}...`, 'api');
  }
  
  /**
   * Show retry option after error
   */
  function showRetryOption(message) {
    const retryDiv = document.createElement('div');
    retryDiv.className = 'alert error';
    retryDiv.innerHTML = `
      <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
      <div class="alert-content">
        <div class="alert-title">Connection Failed</div>
        <div class="alert-message">
          Would you like to retry?
          <button class="toolbar-btn" onclick="retrySendMessage('${message.replace(/'/g, "\\'")}'); this.closest('.alert').remove();" style="margin-top: 10px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </svg>
            Retry
          </button>
        </div>
      </div>
      <button class="alert-close" onclick="this.closest('.alert').remove()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    `;
    chatMessages.appendChild(retryDiv);
  }
  
  /**
   * Retry sending message
   */
  function retrySendMessage(message) {
    // Remove last user message from history
    if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'user') {
      conversationHistory.pop();
    }
    sendMessage(message, true);
  }
  
  /**
   * Handle special commands
   */
  function handleSpecialCommands(message) {
    const command = message.toLowerCase().trim();
    
    // System info command
    if (command === 'errorlist' || command === '/errorlist') {
      addMessage(message, true);
      
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      const dateString = now.toLocaleDateString();
      const modelName = aiModelSelect.options[aiModelSelect.selectedIndex].text;
      
      const typingCheck = document.querySelector('.typing-indicator') ? 'âœ“ Working' : 'âœ“ Ready';
      const apiUrl = getCurrentScriptUrl();
      const apiCheck = apiUrl ? 'âœ“ Connected' : 'âœ— Not Found';
      const sessionLimit = 100;
      const remaining = sessionLimit - totalMessagesSent;
      
      const systemInfo = `**System Information**

**Current Model:** ${modelName}
**Current Time:** ${timeString}
**Current Date:** ${dateString}
**Messages in History:** ${conversationHistory.length}
**Total Messages Sent:** ${totalMessagesSent}
**Messages Remaining (Est.):** ${remaining} / ${sessionLimit}
**Typing Indicator:** ${typingCheck}
**API Connection:** ${apiCheck}
**API URL:** ${apiUrl.substring(0, 50)}...
**Theme:** ${currentTheme}
**User:** ${currentUser || 'Guest'}
**Role:** ${userRole}
**Status:** Active and Running`;
      
      addMessage(systemInfo, false);
      return true;
    }
    
    // Speed test command
    if (command === 'speedtest' || command === '/speedtest') {
      addMessage(message, true);
      
      const modelName = aiModelSelect.options[aiModelSelect.selectedIndex].text;
      addMessage(`**Testing ${modelName} Speed**\n\nSending test request...`, false);
      
      const startTime = performance.now();
      const callbackName = 'speedTestCallback' + (callbackCounter++);
      
      window[callbackName] = function(data) {
        const endTime = performance.now();
        const responseTime = (endTime - startTime).toFixed(0);
        
        let speedRating = '';
        if (responseTime < 1000) {
          speedRating = 'âš¡ Excellent';
        } else if (responseTime < 2000) {
          speedRating = 'âœ“ Good';
        } else if (responseTime < 3000) {
          speedRating = 'â—‹ Average';
        } else {
          speedRating = 'âŠ— Slow';
        }
        
        const speedInfo = `**Speed Test Results**

**Model:** ${modelName}
**Response Time:** ${responseTime}ms
**Ping:** ${responseTime}ms
**Rating:** ${speedRating}
**Status:** ${data.error ? 'Error' : 'Success'}
**Average Latency:** ${performanceMetrics.averageLatency.toFixed(0)}ms
**API Calls:** ${performanceMetrics.apiCalls}
**Errors:** ${performanceMetrics.errors}`;
        
        addMessage(speedInfo, false);
        delete window[callbackName];
      };
      
      const testMessages = [{ role: 'user', content: 'Hi' }];
      const script = document.createElement('script');
      const params = 'callback=' + callbackName + '&messages=' + encodeURIComponent(JSON.stringify(testMessages));
      script.src = getCurrentScriptUrl() + '?' + params;
      
      script.onerror = function() {
        const endTime = performance.now();
        const responseTime = (endTime - startTime).toFixed(0);
        const speedInfo = `**Speed Test Failed**

**Model:** ${modelName}
**Time Before Error:** ${responseTime}ms
**Status:** Connection Failed`;
        addMessage(speedInfo, false);
        delete window[callbackName];
      };
      
      document.body.appendChild(script);
      return true;
    }
    
    // Report model command
    if (command === 'report' || command === '/report') {
      addMessage(message, true);
      
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      const dateString = now.toLocaleDateString();
      const modelName = aiModelSelect.options[aiModelSelect.selectedIndex].text;
      const timestamp = now.getTime();
      
      const callbackName = 'reportCallback' + (callbackCounter++);
      window[callbackName] = function(data) {
        if (data.success) {
          const reportInfo = `**Report Submitted**

**Model Reported:** ${modelName}
**Time:** ${timeString}
**Date:** ${dateString}
**Report ID:** ${timestamp}

Your report has been saved. Total reports in system: ${data.totalReports}`;
          addMessage(reportInfo, false);
        } else {
          showError('Failed to save report. Please try again.');
        }
        delete window[callbackName];
      };
      
      const script = document.createElement('script');
      const params = `callback=${callbackName}&action=report&model=${encodeURIComponent(modelName)}&time=${encodeURIComponent(timeString)}&date=${encodeURIComponent(dateString)}&timestamp=${timestamp}`;
      script.src = REPORTS_API + '?' + params;
      script.onerror = function() {
        showError('Failed to connect to reports server.');
        delete window[callbackName];
      };
      document.body.appendChild(script);
      
      return true;
    }
    
    // Check reports command
    if (command === 'checkreports' || command === '/checkreports') {
      addMessage(message, true);
      
      const callbackName = 'checkReportsCallback' + (callbackCounter++);
      window[callbackName] = function(data) {
        if (data.success) {
          if (data.reports.length === 0) {
            addMessage('**No Reports Found**\n\nThere are currently no reports in the system.', false);
          } else {
            let reportsInfo = `**Report History** (${data.reports.length} total)\n\n`;
            
            data.reports.slice(0, 10).forEach((report, index) => {
              reportsInfo += `**Report #${index + 1}**\n`;
              reportsInfo += `Model: ${report.model}\n`;
              reportsInfo += `Time: ${report.time}\n`;
              reportsInfo += `Date: ${report.date}\n\n`;
            });
            
            if (data.reports.length > 10) {
              reportsInfo += `\n*Showing 10 of ${data.reports.length} reports*`;
            }
            
            addMessage(reportsInfo, false);
          }
        } else {
          showError('Failed to fetch reports. Please try again.');
        }
        delete window[callbackName];
      };
      
      const script = document.createElement('script');
      const params = `callback=${callbackName}&action=getreports`;
      script.src = REPORTS_API + '?' + params;
      script.onerror = function() {
        showError('Failed to connect to reports server.');
        delete window[callbackName];
      };
      document.body.appendChild(script);
      
      return true;
    }
    
    // Summarize command
    if (command === '/summarize') {
      addMessage(message, true);
      
      if (conversationHistory.length < 2) {
        addMessage('Not enough messages to summarize. Continue the conversation first.', false);
        return true;
      }
      
      const summary = `**Conversation Summary**

**Total Messages:** ${conversationHistory.length}
**User Messages:** ${conversationHistory.filter(m => m.role === 'user').length}
**Assistant Messages:** ${conversationHistory.filter(m => m.role === 'assistant').length}
**Model:** ${aiModelSelect.options[aiModelSelect.selectedIndex].text}
**Duration:** ${getRelativeTime(new Date(Date.now() - (conversationHistory.length * 60000)))}

*This is a basic summary. For AI-powered summarization, ask the AI to "summarize our conversation".*`;
      
      addMessage(summary, false);
      return true;
    }
    
    // Clear history command
    if (command === '/clear') {
      showModal(
        'Clear Conversation?',
        'This will clear the current conversation. This cannot be undone.',
        [
          { text: 'Cancel', type: 'cancel', action: hideModal },
          { 
            text: 'Clear', 
            type: 'delete', 
            action: function() {
              conversationHistory = [];
              chatMessages.innerHTML = '<div class="message assistant"><div class="message-avatar">AI<span class="avatar-status"></span></div><div class="message-content">yo wsg gang, What do you want..<span class="message-timestamp"></span></div></div>';
              showSuccess('Conversation cleared');
              hideModal();
            }
          }
        ]
      );
      return true;
    }
    
    return false;
  }
  // ============================================
  // SECTION 18: CHAT HISTORY MANAGEMENT
  // ============================================
  
  /**
   * Load chat history from server
   */
  function loadChatHistory() {
    if (!isAuthenticated || !currentUser) {
      const historyList = document.getElementById('historyList');
      if (historyList) {
        historyList.innerHTML = `
          <div class="empty-state">
            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <div class="empty-state-title">Login to save chats</div>
            <div class="empty-state-message">Sign in to save and access your chat history across devices</div>
          </div>
        `;
      }
      return;
    }

    const callbackName = 'historyCallback' + (callbackCounter++);
    window[callbackName] = function(data) {
      if (data.success && data.history) {
        chatHistory = data.history;
        renderHistory();
        debugConsole.log(`Loaded ${chatHistory.length} chats from history`, 'success');
      } else {
        debugConsole.log('Failed to load chat history', 'error');
      }
      delete window[callbackName];
    };

    const script = document.createElement('script');
    script.src = HISTORY_API + '?callback=' + callbackName + '&action=getHistory&username=' + encodeURIComponent(currentUser);
    script.onerror = function() {
      showError('Failed to load history');
      debugConsole.log('History API connection failed', 'error');
      delete window[callbackName];
    };
    document.body.appendChild(script);
  }
  
  /**
   * Render history list
   */
  function renderHistory(filter = 'all') {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    if (chatHistory.length === 0) {
      historyList.innerHTML = `
        <div class="empty-state">
          <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <div class="empty-state-title">No chat history yet</div>
          <div class="empty-state-message">Start a conversation and save it to see it here!</div>
        </div>
      `;
      return;
    }

    historyList.innerHTML = '';
    
    // Filter chats
    let filteredChats = chatHistory;
    const today = new Date().toDateString();
    
    if (filter === 'favorites') {
      filteredChats = chatHistory.filter(chat => favoriteChats.includes(chat.id));
    } else if (filter === 'today') {
      filteredChats = chatHistory.filter(chat => {
        const chatDate = new Date(chat.timestamp || chat.date).toDateString();
        return chatDate === today;
      });
    }
    
    if (filteredChats.length === 0) {
      historyList.innerHTML = `
        <div class="empty-state">
          <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <div class="empty-state-title">No chats found</div>
          <div class="empty-state-message">Try a different filter</div>
        </div>
      `;
      return;
    }
    
    // Sort by date (newest first)
    filteredChats.sort((a, b) => {
      const dateA = new Date(a.timestamp || a.date);
      const dateB = new Date(b.timestamp || b.date);
      return dateB - dateA;
    });
    
    filteredChats.forEach(chat => {
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';
      historyItem.dataset.chatId = chat.id;
      
      let modelInfo = '';
      let messageCount = 0;
      
      if (chat.messages && typeof chat.messages === 'object' && chat.messages.modelName) {
        modelInfo = chat.messages.modelName;
        messageCount = chat.messages.messages ? chat.messages.messages.length : 0;
      }
      
      const isFavorite = favoriteChats.includes(chat.id);
      const chatDate = new Date(chat.timestamp || chat.date);
      const preview = getFirstUserMessage(chat);

      historyItem.innerHTML = `
        <div class="history-item-header">
          <div class="history-item-title">${sanitizeHTML(chat.title)}</div>
          <button class="history-item-favorite ${isFavorite ? 'active' : ''}" data-id="${chat.id}">
            <svg viewBox="0 0 24 24" fill="${isFavorite ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
          </button>
        </div>
        <div class="history-item-date">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          ${formatDate(chatDate)} â€¢ ${formatTimestamp(chatDate)}
        </div>
        ${preview ? `<div class="history-item-preview">${sanitizeHTML(preview)}</div>` : ''}
        <div class="history-item-meta">
          ${modelInfo ? `<span class="history-meta-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"></path></svg>${modelInfo}</span>` : ''}
          ${messageCount > 0 ? `<span class="history-meta-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>${messageCount} messages</span>` : ''}
        </div>
        <div class="history-item-actions">
          <button class="history-btn load-btn" data-id="${chat.id}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 17 9 11 13 15 21 7"></polyline>
              <polyline points="14 7 21 7 21 14"></polyline>
            </svg>
            Load
          </button>
          <button class="history-btn copy" data-id="${chat.id}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copy
          </button>
          <button class="history-btn rename-btn" data-id="${chat.id}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Rename
          </button>
          <button class="history-btn delete" data-id="${chat.id}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete
          </button>
        </div>
      `;
      
      historyList.appendChild(historyItem);
    });

    // Attach event handlers
    attachHistoryEventHandlers();
  }
  
  /**
   * Get first user message as preview
   */
  function getFirstUserMessage(chat) {
    let messages = [];
    
    if (chat.messages && chat.messages.messages) {
      messages = chat.messages.messages;
    } else if (Array.isArray(chat.messages)) {
      messages = chat.messages;
    }
    
    const userMsg = messages.find(m => m.role === 'user');
    if (userMsg && userMsg.content) {
      return userMsg.content.substring(0, 100) + (userMsg.content.length > 100 ? '...' : '');
    }
    return '';
  }
  
  /**
   * Attach history event handlers
   */
  function attachHistoryEventHandlers() {
    // Load buttons
    document.querySelectorAll('.load-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const chatId = parseInt(this.dataset.id);
        loadChat(chatId);
      });
    });

    // Copy buttons
    document.querySelectorAll('.history-btn.copy').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const chatId = parseInt(this.dataset.id);
        copyChat(chatId);
      });
    });

    // Rename buttons
    document.querySelectorAll('.rename-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const chatId = parseInt(this.dataset.id);
        renameChat(chatId);
      });
    });

    // Delete buttons
    document.querySelectorAll('.history-btn.delete').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const chatId = parseInt(this.dataset.id);
        pendingDeleteChatId = chatId;
        
        showModal(
          'Delete Chat?',
          'Are you sure you want to delete this chat? This cannot be undone.',
          [
            { text: 'Cancel', type: 'cancel', action: hideModal },
            {
              text: 'Delete',
              type: 'delete',
              action: function() {
                if (pendingDeleteChatId !== null) {
                  deleteChat(pendingDeleteChatId);
                  hideModal();
                }
              }
            }
          ]
        );
      });
    });
    
    // Favorite buttons
    document.querySelectorAll('.history-item-favorite').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const chatId = parseInt(this.dataset.id);
        toggleFavorite(chatId);
      });
    });
  }
  
  /**
   * Load chat
   */
function loadChat(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) {
      showError('Chat not found');
      return;
    }

    let chatData = chat.messages;
    let savedModel = null;
    
    if (chatData && typeof chatData === 'object' && chatData.messages) {
      conversationHistory = chatData.messages || [];
      savedModel = chatData.model;
    } else {
      conversationHistory = chatData || [];
    }
    
    // CHECK IF SAVED MODEL IS AVAILABLE
    if (savedModel) {
      const canLoad = canLoadChatModel(savedModel);
      
      if (canLoad === false) {
        showModal(
          'Model Not Available',
          `This chat uses "${MODEL_CAPABILITIES[savedModel]?.name || savedModel}" which is currently disabled. You cannot load this chat.`,
          [
            { text: 'OK', type: 'cancel', action: hideModal }
          ]
        );
        return;
      }
      
      if (canLoad === 'warning') {
        showModal(
          'Model Restricted',
          `This chat uses "${MODEL_CAPABILITIES[savedModel]?.name || savedModel}" which is currently disabled. As staff, you can still load it. Continue?`,
          [
            { text: 'Cancel', type: 'cancel', action: hideModal },
            { 
              text: 'Load Chat', 
              type: 'confirm', 
              action: () => {
                hideModal();
                performLoadChat(chat, savedModel);
              }
            }
          ]
        );
        return;
      }
    }
    
    performLoadChat(chat, savedModel);
}
  function performLoadChat(chat, savedModel) {
    conversationHistory = [];
    chatMessages.innerHTML = '';
    
    let chatData = chat.messages;
    
    if (chatData && typeof chatData === 'object' && chatData.messages) {
      conversationHistory = chatData.messages || [];
    } else {
      conversationHistory = chatData || [];
    }
    
    if (savedModel && AI_MODELS[savedModel]) {
      currentModel = savedModel;
      const dropdown = document.getElementById('aiModel');
      if (dropdown) {
        dropdown.value = savedModel;
      }
      pendingModel = null;
      updatePlaceholder();
    }
    
    conversationHistory.forEach(msg => {
      addMessage(msg.content, msg.role === 'user', false);
    });

    setTimeout(() => {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('active');
    }, 100);
    
    const dropdown = document.getElementById('aiModel');
    const modelName = dropdown ? dropdown.options[dropdown.selectedIndex].text : 'AI';
    showSuccess(savedModel ? `Chat loaded! Model: ${modelName}` : 'Chat loaded successfully!');
    debugConsole.log(`Loaded chat: ${chat.title}`, 'info');
}
  /**
   * Save current chat
   */
  function saveCurrentChat() {
    if (!isAuthenticated || !currentUser) {
      showError('Please login to save chats');
      return;
    }

    if (conversationHistory.length === 0) {
      showError('No conversation to save');
      return;
    }

    const firstUserMsg = conversationHistory.find(msg => msg.role === 'user');
    const suggestedTitle = firstUserMsg ? firstUserMsg.content.substring(0, 50) : 'Untitled Chat';
    
    showModal(
      'Save Chat',
      'Give your chat a name:',
      [
        { text: 'Cancel', type: 'cancel', action: hideModal },
        {
          text: 'Save',
          type: 'confirm',
          action: function() {
            const chatName = getModalInputValue();
            if (!chatName) {
              showError('Please enter a chat name');
              return;
            }
            performSaveChat(chatName);
            hideModal();
          }
        }
      ],
      true,
      'Chat Name',
      suggestedTitle
    );
  }
  
  /**
   * Perform save chat
   */
  function performSaveChat(chatName) {
    const currentModelName = aiModelSelect.options[aiModelSelect.selectedIndex].text;
    
    showLoading('Saving chat...');
    
    const callbackName = 'saveCallback' + (callbackCounter++);
    window[callbackName] = function(data) {
      hideLoading();
      
      if (data.success) {
        chatHistory = data.history;
        renderHistory();
        showSuccess('Chat saved successfully!');
        debugConsole.log('Chat saved: ' + chatName, 'success');
      } else {
        showError('Failed to save chat: ' + (data.error || 'Unknown error'));
        debugConsole.log('Failed to save chat: ' + (data.error || 'Unknown error'), 'error');
      }
      delete window[callbackName];
    };

    function truncateText(text, maxLen) {
      if (typeof text !== 'string') return '';
      if (text.length <= maxLen) return text;
      return text.slice(0, maxLen) + 'â€¦';
    }

    function buildChatDataForJsonp() {
      // JSONP uses GET query params, so the URL can become too large.
      // Most common offender: large chats + any attached file data.
      const steps = [
        { maxMessages: 50, maxChars: 6000 },
        { maxMessages: 30, maxChars: 4000 },
        { maxMessages: 20, maxChars: 2500 },
        { maxMessages: 12, maxChars: 1500 },
        { maxMessages: 8, maxChars: 1000 }
      ];

      const fullHistory = Array.isArray(conversationHistory) ? conversationHistory : [];

      for (const step of steps) {
        const sliced = fullHistory.slice(-step.maxMessages);
        const sanitizedMessages = sliced.map(m => {
          const msg = {
            role: m?.role,
            content: truncateText(m?.content || '', step.maxChars)
          };
          // Never try to save file blobs/base64/etc via JSONP URL.
          // (Keeps saves reliable and prevents oversized URLs.)
          return msg;
        });

        const chatDataObj = {
          messages: sanitizedMessages,
          model: currentModel,
          modelName: currentModelName,
          timestamp: Date.now()
        };

        const json = JSON.stringify(chatDataObj);
        const encoded = encodeURIComponent(json);
        // Conservative guard: keep encoded payload small enough for common URL limits.
        if (encoded.length <= 6000) return encoded;
      }
      return null;
    }

    const encodedChatData = buildChatDataForJsonp();
    if (!encodedChatData) {
      hideLoading();
      showError('Chat is too large to save via JSONP. Try a shorter chat (or save without file attachments).');
      debugConsole.log('Failed to save chat: payload too large for JSONP', 'error');
      delete window[callbackName];
      return;
    }

    const script = document.createElement('script');
    const params = 'callback=' + callbackName + '&action=saveChat&username=' + encodeURIComponent(currentUser) +
                   '&chatTitle=' + encodeURIComponent(chatName) +
                   '&chatData=' + encodedChatData +
                   '&_t=' + Date.now();
    script.src = HISTORY_API + '?' + params;

    const timeoutMs = 15000;
    const timeoutId = setTimeout(() => {
      hideLoading();
      showError('Save timed out. Please try again.');
      debugConsole.log('Failed to save chat: timeout', 'error');
      try { script.remove(); } catch (e) {}
      delete window[callbackName];
    }, timeoutMs);

    const cleanup = () => {
      clearTimeout(timeoutId);
      try { script.remove(); } catch (e) {}
    };

    const originalCallback = window[callbackName];
    window[callbackName] = function(data) {
      cleanup();
      originalCallback(data);
    };

    script.onerror = function() {
      cleanup();
      hideLoading();
      showError('Failed to connect to server');
      debugConsole.log('Failed to save chat: connection error', 'error');
      delete window[callbackName];
    };

    document.body.appendChild(script);
  }
  
  /**
   * Rename chat
   */
  function renameChat(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) {
      showError('Chat not found');
      return;
    }

    pendingRenameChatId = chatId;
    
    showModal(
      'Rename Chat',
      'Enter a new name for this chat:',
      [
        { text: 'Cancel', type: 'cancel', action: hideModal },
        {
          text: 'Rename',
          type: 'confirm',
          action: function() {
            const newName = getModalInputValue();
            if (!newName) {
              showError('Please enter a chat name');
              return;
            }
            performRenameChat(pendingRenameChatId, newName);
            hideModal();
          }
        }
      ],
      true,
      'New Chat Name',
      chat.title
    );
  }
  
  /**
   * Perform rename chat
   */
  function performRenameChat(chatId, newName) {
    showLoading('Renaming chat...');

    const callbackName = 'renameCallback' + (callbackCounter++);
    window[callbackName] = function(data) {
      hideLoading();
      
      if (data.success) {
        chatHistory = data.history || [];
        renderHistory();
        showSuccess('Chat renamed successfully!');
        debugConsole.log('Chat renamed to: ' + newName, 'success');
      } else {
        showError('Failed to rename chat: ' + (data.error || 'Unknown error'));
        debugConsole.log('Failed to rename chat: ' + (data.error || 'Unknown error'), 'error');
      }
      delete window[callbackName];
    };

    const script = document.createElement('script');
    script.src = HISTORY_API + '?callback=' + callbackName + '&action=renameChat&username=' + encodeURIComponent(currentUser) + '&chatId=' + chatId + '&newTitle=' + encodeURIComponent(newName);
    script.onerror = function() {
      hideLoading();
      showError('Failed to connect to server');
      debugConsole.log('Failed to rename chat: connection error', 'error');
      delete window[callbackName];
    };
    document.body.appendChild(script);
  }
  
  /**
   * Delete chat
   */
  function deleteChat(chatId) {
    showLoading('Deleting chat...');

    const callbackName = 'deleteCallback' + (callbackCounter++);
    window[callbackName] = function(data) {
      hideLoading();
      
      if (data.success) {
        chatHistory = data.history || [];
        renderHistory();
        showSuccess('Chat deleted successfully!');
        debugConsole.log('Chat deleted', 'success');
      } else {
        showError('Failed to delete chat: ' + (data.error || 'Unknown error'));
        debugConsole.log('Failed to delete chat: ' + (data.error || 'Unknown error'), 'error');
      }
      delete window[callbackName];
    };

    const script = document.createElement('script');
    script.src = HISTORY_API + '?callback=' + callbackName + '&action=deleteChat&username=' + encodeURIComponent(currentUser) + '&chatId=' + chatId;
    script.onerror = function() {
      hideLoading();
      showError('Failed to connect to server');
      debugConsole.log('Failed to delete chat: connection error', 'error');
      delete window[callbackName];
    };
    document.body.appendChild(script);
  }
  
  /**
   * Copy chat
   */
  function copyChat(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) {
      showError('Chat not found');
      return;
    }

    let chatData = chat.messages;
    let messages = [];
    
    if (chatData && typeof chatData === 'object' && chatData.messages) {
      messages = chatData.messages || [];
    } else {
      messages = chatData || [];
    }

    if (messages.length === 0) {
      showError('No messages to copy');
      return;
    }

    let chatText = `Chat: ${chat.title}\n`;
    chatText += `Date: ${chat.date}\n`;
    if (chatData && chatData.modelName) {
      chatText += `Model: ${chatData.modelName}\n`;
    }
    chatText += `${'='.repeat(50)}\n\n`;

    messages.forEach((msg, index) => {
      const role = msg.role === 'user' ? 'You' : 'AI';
      chatText += `${role}:\n${msg.content}\n\n`;
      if (index < messages.length - 1) {
        chatText += `${'-'.repeat(50)}\n\n`;
      }
    });

    copyToClipboard(chatText).then(() => {
      showSuccess('Chat copied to clipboard!');
      debugConsole.log('Chat copied to clipboard', 'success');
    }).catch(err => {
      showError('Failed to copy chat: ' + err.message);
      debugConsole.log('Failed to copy chat: ' + err.message, 'error');
    });
  }
  
  /**
   * Toggle favorite
   */
  function toggleFavorite(chatId) {
    const index = favoriteChats.indexOf(chatId);
    
    if (index === -1) {
      favoriteChats.push(chatId);
      showInfo('Added to favorites');
    } else {
      favoriteChats.splice(index, 1);
      showInfo('Removed from favorites');
    }
    
    // Save to localStorage
    localStorage.setItem('favoriteChats', JSON.stringify(favoriteChats));
    
    // Re-render if on favorites filter
    const activeFilter = document.querySelector('.filter-chip.active');
    if (activeFilter && activeFilter.dataset.filter === 'favorites') {
      renderHistory('favorites');
    } else {
      // Just update the button
      const btn = document.querySelector(`.history-item-favorite[data-id="${chatId}"]`);
      if (btn) {
        const svg = btn.querySelector('svg');
        if (favoriteChats.includes(chatId)) {
          btn.classList.add('active');
          svg.setAttribute('fill', 'currentColor');
        } else {
          btn.classList.remove('active');
          svg.setAttribute('fill', 'none');
        }
      }
    }
  }
  
  /**
   * Load favorites from localStorage
   */
  function loadFavorites() {
    const saved = localStorage.getItem('favoriteChats');
    if (saved) {
      try {
        favoriteChats = JSON.parse(saved);
      } catch (e) {
        favoriteChats = [];
      }
    }
  }
  // ============================================
  // SECTION 19: AUTHENTICATION & DEBUG CONSOLE
  // ============================================
  
  /**
   * Handle login
   */
  
  /**
   * Handle logout
   */
  function handleLogout() {
    showModal(
      'Logout?',
      'Are you sure you want to logout? Your current chat will be cleared.',
      [
        { text: 'Cancel', type: 'cancel', action: hideModal },
        {
          text: 'Logout',
          type: 'delete',
          action: function() {
            isAuthenticated = false;
            currentUser = null;
            userRole = 'user';
            conversationHistory = [];
            chatMessages.innerHTML = '<div class="message assistant"><div class="message-avatar">AI<span class="avatar-status"></span></div><div class="message-content">yo wsg gang, What do you want..<span class="message-timestamp"></span></div></div>';
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
            updateSidebarUser();
            filterAIModels();
            showAuth();
            debugConsole.log('User logged out', 'info');
            hideModal();
          }
        }
      ]
    );
  }
  
  /**
   * Show stats modal
   */
  function showStats() {
    if (!isAuthenticated || !currentUser) {
      showError('Please login to view statistics');
      return;
    }

    const totalChats = chatHistory.length;
    const totalMessages = conversationHistory.length;
    
    const modelCounts = {};
    chatHistory.forEach(chat => {
      if (chat.messages && chat.messages.modelName) {
        const modelName = chat.messages.modelName;
        modelCounts[modelName] = (modelCounts[modelName] || 0) + 1;
      }
    });
    
    let mostUsedModel = 'N/A';
    let maxCount = 0;
    for (const model in modelCounts) {
      if (modelCounts[model] > maxCount) {
        maxCount = modelCounts[model];
        mostUsedModel = model;
      }
    }
    
    const todayMessages = totalMessagesSent;
    
    let totalChatMessages = 0;
    chatHistory.forEach(chat => {
      if (chat.messages && chat.messages.messages) {
        totalChatMessages += chat.messages.messages.length;
      }
    });
    const avgMessages = totalChats > 0 ? Math.round(totalChatMessages / totalChats) : 0;
    
    let modelBreakdown = '';
    const sortedModels = Object.entries(modelCounts).sort((a, b) => b[1] - a[1]);
    sortedModels.forEach(([model, count]) => {
      modelBreakdown += `
        <li class="stat-list-item">
          <span class="stat-list-label">${model}</span>
          <span class="stat-list-value">${count} chats</span>
        </li>
      `;
    });
    
    if (modelBreakdown === '') {
      modelBreakdown = '<li class="stat-list-item"><span class="stat-list-label">No data yet</span></li>';
    }
    
    const statsHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">${totalChats}</div>
          <div class="stat-label">Total Chats</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">${todayMessages}</div>
          <div class="stat-label">Today's Messages</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">${avgMessages}</div>
          <div class="stat-label">Avg Messages/Chat</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">${mostUsedModel}</div>
          <div class="stat-label">Favorite Model</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">${performanceMetrics.averageLatency.toFixed(0)}ms</div>
          <div class="stat-label">Avg Response Time</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-value">${performanceMetrics.apiCalls}</div>
          <div class="stat-label">API Calls</div>
        </div>
        
        <div class="stat-card full-width">
          <div class="stat-label" style="margin-bottom: 12px;">Model Usage Breakdown</div>
          <ul class="stat-list">${modelBreakdown}</ul>
        </div>
      </div>
    `;
    
    modalTitle.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="20" x2="12" y2="10"></line>
        <line x1="18" y1="20" x2="18" y2="4"></line>
        <line x1="6" y1="20" x2="6" y2="16"></line>
      </svg>
      Your Chat Statistics
    `;
    modalMessage.innerHTML = statsHTML;
    modalButtons.innerHTML = '';
    modalInputContainer.innerHTML = '';
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'modal-button confirm';
    closeBtn.textContent = 'Close';
    closeBtn.onclick = hideModal;
    modalButtons.appendChild(closeBtn);
    
    modalOverlay.classList.add('active');
  }
  
  /**
   * Generate floating particles for auth screen
   */
  function createParticles() {
    const particles = document.getElementById('particles');
    if (!particles) return;
    
    for (let i = 0; i < 50; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      const size = Math.random() * 100 + 50;
      particle.style.width = size + 'px';
      particle.style.height = size + 'px';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.bottom = '-100px';
      particle.style.animationDelay = Math.random() * 20 + 's';
      particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
      particles.appendChild(particle);
    }
  }
  
  // ============================================
  // DEBUG CONSOLE SYSTEM
  // ============================================
  
  const debugConsole = {
    element: null,
    content: null,
    errorCount: 0,
    warnCount: 0,
    logCount: 0,
    isDragging: false,
    startX: 0,
    startY: 0,
    initialX: 0,
    initialY: 0,
    filters: {
      info: true,
      warn: true,
      error: true,
      success: true,
      api: true
    },
    isMinimized: false,
    logs: [],
    
    init() {
      this.element = document.getElementById('debugConsole');
      this.content = document.getElementById('debugConsoleContent');
      
      const header = document.getElementById('debugConsoleHeader');
      header.addEventListener('mousedown', (e) => this.startDrag(e));
      document.addEventListener('mousemove', (e) => this.drag(e));
      document.addEventListener('mouseup', () => this.stopDrag());
      
      document.getElementById('clearConsoleBtn').addEventListener('click', () => this.clear());
      document.getElementById('closeConsoleBtn').addEventListener('click', () => this.toggle());
      document.getElementById('minimizeConsoleBtn').addEventListener('click', () => this.minimize());
      document.getElementById('exportLogsBtn').addEventListener('click', () => this.exportLogs());
      
      this.setupFilters();
      this.interceptConsole();
      this.captureErrors();
      this.monitorPerformance();
      
      this.log('Debug console ready - Enhanced Edition', 'success');
    },
    
    setupFilters() {
      const filterContainer = document.getElementById('consoleFilters');
      if (!filterContainer) return;
      
      Object.keys(this.filters).forEach(type => {
        const btn = document.createElement('button');
        btn.className = 'console-filter-btn active';
        btn.dataset.filter = type;
        btn.textContent = type.charAt(0).toUpperCase() + type.slice(1);
        btn.addEventListener('click', () => this.toggleFilter(type, btn));
        filterContainer.appendChild(btn);
      });
    },
    
    toggleFilter(type, btn) {
      this.filters[type] = !this.filters[type];
      btn.classList.toggle('active');
      this.applyFilters();
    },
    
    applyFilters() {
      const logs = this.content.querySelectorAll('.debug-log');
      logs.forEach(log => {
        const type = Array.from(log.classList).find(c => c !== 'debug-log');
        if (type && this.filters[type] !== undefined) {
          log.style.display = this.filters[type] ? 'flex' : 'none';
        }
      });
    },
    
    minimize() {
      this.isMinimized = !this.isMinimized;
      this.content.style.display = this.isMinimized ? 'none' : 'block';
      const filters = document.getElementById('consoleFilters');
      const stats = document.querySelector('.console-stats');
      if (filters) filters.style.display = this.isMinimized ? 'none' : 'flex';
      if (stats) stats.style.display = this.isMinimized ? 'none' : 'flex';
      const btn = document.getElementById('minimizeConsoleBtn');
      if (btn) btn.textContent = this.isMinimized ? 'â–¡' : 'âˆ’';
    },
    
    exportLogs() {
      if (this.logs.length === 0) {
        showInfo('No logs to export');
        return;
      }
      
      const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
      const content = this.logs.map(log => 
        `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`
      ).join('\n');
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `console-logs-${timestamp}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      this.log('Logs exported successfully', 'success');
    },
    
    monitorPerformance() {
      if (performance.memory) {
        setInterval(() => {
          const used = (performance.memory.usedJSHeapSize / 1048576).toFixed(2);
          const total = (performance.memory.totalJSHeapSize / 1048576).toFixed(2);
          const percent = ((used / total) * 100).toFixed(1);
          
          if (percent > 80) {
            this.log(`âš ï¸ High memory usage: ${used}MB / ${total}MB (${percent}%)`, 'warn');
          }
        }, 30000);
      }
    },
    
    startDrag(e) {
      if (e.target.closest('.debug-console-btn')) return;
      this.isDragging = true;
      this.startX = e.clientX;
      this.startY = e.clientY;
      const rect = this.element.getBoundingClientRect();
      this.initialX = rect.right - window.innerWidth;
      this.initialY = rect.bottom - window.innerHeight;
    },
    
    drag(e) {
      if (!this.isDragging) return;
      e.preventDefault();
      
      const dx = e.clientX - this.startX;
      const dy = e.clientY - this.startY;
      
      this.element.style.right = Math.max(10, -this.initialX - dx) + 'px';
      this.element.style.bottom = Math.max(10, -this.initialY - dy) + 'px';
    },
    
    stopDrag() {
      this.isDragging = false;
    },
    
    toggle() {
      this.element.classList.toggle('active');
      const btn = document.getElementById('consoleToggleBtn');
      if (btn) btn.classList.toggle('active');
    },
    
    log(message, type = 'info') {
      if (!this.content) return;

      const timestamp = new Date().toLocaleTimeString();
      const logDiv = document.createElement('div');
      logDiv.className = `debug-log ${type}`;
      
      const icons = { info: 'â„¹ï¸', error: 'âŒ', warn: 'âš ï¸', success: 'âœ…', api: 'ðŸŒ' };
      const icon = icons[type] || 'â„¹ï¸';
      logDiv.innerHTML = `<span class="debug-timestamp">[${timestamp}]</span><span class="debug-message">${icon} ${this.formatMessage(message)}</span>`;
      
      this.content.appendChild(logDiv);
      this.content.scrollTop = this.content.scrollHeight;
      
      this.logs.push({ timestamp, type, message: typeof message === 'string' ? message : JSON.stringify(message) });
      
      if (type === 'error') this.errorCount++;
      else if (type === 'warn') this.warnCount++;
      else if (type === 'info' || type === 'success' || type === 'api') this.logCount++;
      
      this.updateCounters();
      this.applyFilters();
    },
    
    updateCounters() {
      const badge = document.getElementById('consoleErrorBadge');
      if (badge) {
        const total = this.errorCount + this.warnCount;
        if (total > 0) {
          badge.textContent = total;
          badge.style.display = 'inline-block';
          badge.style.background = this.errorCount > 0 ? '#ff6666' : '#ffaa44';
        } else {
          badge.style.display = 'none';
        }
      }
      
      const logCountEl = document.getElementById('logCountStat');
      const warnCountEl = document.getElementById('warnCountStat');
      const errorCountEl = document.getElementById('errorCountStat');
      
      if (logCountEl) logCountEl.textContent = this.logCount;
      if (warnCountEl) warnCountEl.textContent = this.warnCount;
      if (errorCountEl) errorCountEl.textContent = this.errorCount;
    },
    
    formatMessage(message) {
      if (typeof message === 'object') {
        try {
          return '<pre style="margin: 4px 0; font-size: 11px;">' + JSON.stringify(message, null, 2) + '</pre>';
        } catch (e) {
          return String(message);
        }
      }
      return String(message);
    },
    
    clear() {
      this.content.innerHTML = '<div class="debug-log info"><span class="debug-timestamp">[' + 
        new Date().toLocaleTimeString() + ']</span><span class="debug-message">â„¹ï¸ Console cleared</span></div>';
      this.errorCount = 0;
      this.warnCount = 0;
      this.logCount = 0;
      this.logs = [];
      this.updateCounters();
    },
    
    interceptConsole() {
      const originalLog = console.log;
      const originalError = console.error;
      const originalWarn = console.warn;
      
      console.log = (...args) => {
        originalLog.apply(console, args);
        this.log(args.join(' '), 'info');
      };
      
      console.error = (...args) => {
        originalError.apply(console, args);
        this.log(args.join(' '), 'error');
      };
      
      console.warn = (...args) => {
        originalWarn.apply(console, args);
        this.log(args.join(' '), 'warn');
      };
    },
    
    captureErrors() {
      window.addEventListener('error', (event) => {
        this.log(`ERROR: ${event.message} at ${event.filename}:${event.lineno}:${event.colno}`, 'error');
      });
      
      window.addEventListener('unhandledrejection', (event) => {
        this.log(`PROMISE REJECTION: ${event.reason}`, 'error');
      });
    }
  };
  // ============================================
  // SECTION 20: EVENT LISTENERS & INIT
  // ============================================
  
  // ============================================
  // MEMBER KEY AUTHENTICATION
  // ============================================
  
  // Initialize member key input on page load
  document.addEventListener('DOMContentLoaded', () => {
    const keyInput = document.getElementById('memberKeyInput');
    
    // Auto-submit if code is pre-filled from login page
    if (keyInput && keyInput.value.length === 6) {
      setTimeout(() => {
        validateMemberKey();
      }, 500);
    }
  });
  
  // Focus input field when overlay shown
  setTimeout(() => {
    const memberKeyInput = document.getElementById('memberKeyInput');
    if (memberKeyInput) {
      memberKeyInput.focus();
    }
  }, 100);
  
  // Allow Enter key to submit
  safeAddEventListener('memberKeyInput', 'keypress', function(e) {
    if (e.key === 'Enter') {
      validateMemberKey();
    }
  });
  
  // Auto-format input (digits only)
  safeAddEventListener('memberKeyInput', 'input', function(e) {
    this.value = this.value.replace(/\D/g, '').substring(0, 6);
  });

/**
 * Validate member key with backend
 */
function validateMemberKey() {
  const code = document.getElementById('memberKeyInput').value.trim();
  const keyError = document.getElementById('keyErrorMessage');
  const keySuccess = document.getElementById('keySuccessMessage');
  const validateBtn = document.getElementById('validateKeyBtn');
  
  // Hide previous messages
  keyError.classList.remove('show');
  keySuccess.classList.remove('show');
  
  // Validation
  if (!code) {
    showKeyError('Please enter a member key');
    return;
  }
  
  if (code.length !== 6) {
    showKeyError('Member key must be 6 digits');
    return;
  }
  
  if (!/^\d{6}$/.test(code)) {
    showKeyError('Member key must contain only numbers');
    return;
  }
  
  // Show loading state
  validateBtn.disabled = true;
  validateBtn.textContent = 'VALIDATING...';
  
  // Call validation API
  const callbackName = 'validateCallback' + Date.now();
  
  window[callbackName] = function(data) {
    validateBtn.disabled = false;
    validateBtn.textContent = 'ACCESS CHAT';
    
    if (data.success) {
      // Set user session data
      currentUser = data.username;
      userRole = data.role || 'user';
      isAuthenticated = !data.isGuest;
      
      // Show success message
      keySuccess.textContent = 'Access granted! Loading chat interface...';
      keySuccess.classList.add('show');
      
      // Hide member key overlay
      setTimeout(() => {
        document.getElementById('memberKeyOverlay').classList.add('hidden');
        
        // Update UI
        updateSidebarUser();
        filterAIModels();
        
        // Load chat history for authenticated users
        if (!data.isGuest) {
          loadChatHistory();
        }
        
        // Show welcome message
        const welcomeMsg = data.isGuest ? 
          'Welcome, Guest! You have access to Cerebra and Groq models.' :
          'Welcome back, ' + data.username + '!';
        showSuccess(welcomeMsg);
        
        debugConsole.log('Member key validated: ' + code + ' for user: ' + data.username, 'success');
        
        // Apply model restrictions
        setTimeout(() => {
          loadModelAvailability();
        }, 500);
        
      }, 800);
      
    } else {
      showKeyError(data.error || 'Invalid or expired member key');
      debugConsole.log('Member key validation failed: ' + (data.error || 'Unknown error'), 'error');
    }
    
    delete window[callbackName];
  };
  
  const script = document.createElement('script');
  script.src = 'https://script.google.com/macros/s/AKfycbzHDXl45MX96gaOlKPeqD4Q75nNeDm1cMUvQpc0GWVXHSE8ErnMbkZ6GSMnO9zTbFO_Bg/exec?action=validateCode&code=' + 
               encodeURIComponent(code) + 
               '&callback=' + callbackName;
  
  script.onerror = function() {
    validateBtn.disabled = false;
    validateBtn.textContent = 'ACCESS CHAT';
    showKeyError('Connection failed. Please try again.');
    debugConsole.log('Member key validation API connection failed', 'error');
    delete window[callbackName];
  };
  
  document.body.appendChild(script);
}

/**
 * Show error message for member key
 */
function showKeyError(message) {
  const errorDiv = document.getElementById('keyErrorMessage');
  errorDiv.textContent = message;
  errorDiv.classList.add('show');
  
  // Shake animation
  const input = document.getElementById('memberKeyInput');
  input.style.animation = 'shake 0.5s';
  setTimeout(() => {
    input.style.animation = '';
  }, 500);
}

/**
 * Show success message for member key
 */
function showKeySuccess(message) {
  const successDiv = document.getElementById('keySuccessMessage');
  successDiv.textContent = message;
  successDiv.classList.add('show');
}

/**
 * Hide member key overlay (called after successful validation)
 */
function hideMemberKeyOverlay() {
  const overlay = document.getElementById('memberKeyOverlay');
  if (overlay) {
    overlay.classList.add('hidden');
  }
}
  
  // ============================================
  // SEND MESSAGE
  // ============================================
  sendButton.addEventListener('click', async () => {
    const availability = isModelAvailable(currentModel);
    if (availability === false) {
      showError('This model is disabled!');
      return;
    }
    sendMessage();
  });
  
  chatInput.addEventListener('keypress', async function(e) {
    if (e.key === 'Enter') {
      if (enterToSend && !e.shiftKey) {
        // Enter to send mode: Enter sends, Shift+Enter = newline
        e.preventDefault();
        const availability = isModelAvailable(currentModel);
        if (availability === false) {
          showError('This model is disabled!');
          return;
        }
        sendMessage();
      } else if (!enterToSend && (e.ctrlKey || e.metaKey)) {
        // Ctrl+Enter to send mode: Ctrl+Enter sends, Enter = newline
        e.preventDefault();
        const availability = isModelAvailable(currentModel);
        if (availability === false) {
          showError('This model is disabled!');
          return;
        }
        sendMessage();
      }
    }
  });
  
  // ============================================
  // AI MODEL SELECTOR
  // ============================================
 // ============================================
// AI MODEL SELECTOR
// ============================================
aiModelSelect.addEventListener('change', function(e) {
  const newModel = this.value;
  
  if (e.isTrusted === false || newModel === currentModel) {
    return;
  }
  
  if (newModel !== currentModel) {
    const modelName = this.options[this.selectedIndex].text;
    pendingModel = newModel;
    
    showModal(
      'Switch AI Model?',
      'Switching to ' + modelName + ' will clear your current conversation. Continue?',
      [
        {
          text: 'Cancel',
          type: 'cancel',
          action: function() {
            aiModelSelect.value = currentModel;
            hideModal();
          }
        },
        {
          text: 'Continue',
          type: 'confirm',
          action: function() {
            if (pendingModel) {
              conversationHistory = [];
              chatMessages.innerHTML = '<div class="message assistant"><div class="message-avatar">AI<span class="avatar-status"></span></div><div class="message-content">yo wsg gang, What do you want..<span class="message-timestamp"></span></div></div>';
              currentModel = pendingModel;
              pendingModel = null;
              updatePlaceholder();
              debugConsole.log('Switched to model: ' + currentModel, 'info');
              
              // Apply restrictions after model change
              applyRestrictionState();
              
              // Update file upload button capabilities
              updateFileUploadButton();
              
              // Clear uploaded files if new model doesn't support them
              const caps = getCurrentModelCapabilities();
              if (uploadedFiles.length > 0) {
                const hasUnsupported = uploadedFiles.some(file => !isFileTypeSupported(file));
                if (hasUnsupported || (!caps.text && !caps.images && !caps.pdfs && !caps.videos && !caps.audio)) {
                  uploadedFiles = [];
                  updateFilePreview();
                  showWarning('Uploaded files cleared due to model change');
                }
              }
            }
            hideModal();
          }
        }
      ]
    );
  }
});
  
  // ============================================
  // COMMAND SELECT
  // ============================================
  document.getElementById('commandSelect').addEventListener('change', function() {
    const command = this.value;
    if (command) {
      chatInput.textContent = command;
      sendMessage();
      this.value = '';
    }
  });
  
  // ============================================
  // SIDEBAR
  // ============================================
  document.getElementById('toggleSidebar').addEventListener('click', function() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
  });

  document.getElementById('sidebarOverlay').addEventListener('click', function() {
    document.getElementById('sidebar').classList.remove('open');
    this.classList.remove('active');
  });

  document.getElementById('newChatBtn').addEventListener('click', function() {
    if (conversationHistory.length > 0) {
      showModal(
        'Start New Chat?',
        'Starting a new chat will clear your current conversation. Make sure to save it if you want to keep it.',
        [
          { text: 'Cancel', type: 'cancel', action: hideModal },
          {
            text: 'New Chat',
            type: 'confirm',
            action: function() {
              conversationHistory = [];
              chatMessages.innerHTML = '<div class="message assistant"><div class="message-avatar">AI<span class="avatar-status"></span></div><div class="message-content">yo wsg gang, What do you want..<span class="message-timestamp"></span></div></div>';
              document.getElementById('sidebar').classList.remove('open');
              document.getElementById('sidebarOverlay').classList.remove('active');
              clearDraft();
              debugConsole.log('Started new chat', 'info');
              hideModal();
            }
          }
        ]
      );
    } else {
      conversationHistory = [];
      chatMessages.innerHTML = '<div class="message assistant"><div class="message-avatar">AI<span class="avatar-status"></span></div><div class="message-content">yo wsg gang, What do you want..<span class="message-timestamp"></span></div></div>';
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('active');
      debugConsole.log('Started new chat', 'info');
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', handleLogout);
  document.getElementById('saveChatBtn').addEventListener('click', saveCurrentChat);
  document.getElementById('statsBtn').addEventListener('click', showStats);
  
  // ============================================
  // SETTINGS BUTTON
  // ============================================
  document.getElementById('settingsBtn').addEventListener('click', function() {
    const currentColorTheme = localStorage.getItem('colorTheme') || 'green';
    var cloakTitle = localStorage.getItem('airai_cloakTitle') || '';
    var cloakUrl = localStorage.getItem('airai_cloakUrl') || '';
    var cloakRestore = localStorage.getItem('airai_cloakRestoreTitle') || '';
    showModal(
      'Settings',
      // â”€â”€ Color Theme â”€â”€
      '<div class="settings-section"><div class="settings-section-title">ðŸŽ¨ Color Theme</div><div class="settings-row"><div class="settings-label"><div class="settings-label-main">Interface Color</div><div class="settings-label-sub">Choose a color palette for the entire UI</div></div></div><div class="color-theme-picker" id="colorThemePicker">' +
      '<div class="color-swatch color-swatch-green' + (currentColorTheme === 'green' ? ' active' : '') + '" data-theme="green" title="Green (Default)"></div>' +
      '<div class="color-swatch color-swatch-blue' + (currentColorTheme === 'blue' ? ' active' : '') + '" data-theme="blue" title="Blue"></div>' +
      '<div class="color-swatch color-swatch-purple' + (currentColorTheme === 'purple' ? ' active' : '') + '" data-theme="purple" title="Purple"></div>' +
      '<div class="color-swatch color-swatch-rose' + (currentColorTheme === 'rose' ? ' active' : '') + '" data-theme="rose" title="Rose"></div>' +
      '<div class="color-swatch color-swatch-amber' + (currentColorTheme === 'amber' ? ' active' : '') + '" data-theme="amber" title="Amber"></div>' +
      '<div class="color-swatch color-swatch-teal' + (currentColorTheme === 'teal' ? ' active' : '') + '" data-theme="teal" title="Teal"></div>' +
      '</div></div>' +
      // â”€â”€ Preferences â”€â”€
      '<div class="settings-section"><div class="settings-section-title">âš™ï¸ Preferences</div>' +
      '<div class="settings-row"><div class="settings-label"><div class="settings-label-main">Auto-save Drafts</div><div class="settings-label-sub">Automatically save your messages as you type</div></div><label class="toggle-switch"><input type="checkbox" id="autoSaveSetting" ' + (autoSaveDrafts ? 'checked' : '') + '><span class="toggle-slider"></span></label></div>' +
      '<div class="settings-row"><div class="settings-label"><div class="settings-label-main">Streaming Responses</div><div class="settings-label-sub">Show responses as they are generated</div></div><label class="toggle-switch"><input type="checkbox" id="streamingSetting" ' + (streamingEnabled ? 'checked' : '') + '><span class="toggle-slider"></span></label></div>' +
      '<div class="settings-row"><div class="settings-label"><div class="settings-label-main">Enter to Send</div><div class="settings-label-sub">Press Enter to send messages. When off, use Ctrl+Enter to send</div></div><label class="toggle-switch"><input type="checkbox" id="enterToSendSetting" ' + (enterToSend ? 'checked' : '') + '><span class="toggle-slider"></span></label></div>' +
      '<div class="settings-range-row"><div class="settings-range-header"><div class="settings-label"><div class="settings-label-main">Chat Font Size</div><div class="settings-label-sub">Adjust the size of message text</div></div><span class="range-value" id="fontSizeValue">' + chatFontSize + 'px</span></div><input type="range" class="range-slider" id="fontSizeSetting" min="12" max="20" step="0.5" value="' + chatFontSize + '"></div>' +
      '</div>' +
      // â”€â”€ Tab Cloak â”€â”€
      '<div class="settings-section"><div class="settings-section-title">ðŸ›¡ï¸ Tab Cloak</div>' +
      '<div class="settings-input-row"><div class="settings-input-label">Panic Tab Title</div><div class="settings-input-sub">Title shown when you press ? to hide (default: HCPSS)</div><input type="text" class="settings-input" id="cloakTitleSetting" placeholder="HCPSS" value="' + cloakTitle.replace(/"/g, '&quot;') + '"></div>' +
      '<div class="settings-input-row"><div class="settings-input-label">Panic Tab URL</div><div class="settings-input-sub">Website loaded when you press ? (default: hcpss.me)</div><input type="text" class="settings-input" id="cloakUrlSetting" placeholder="https://www.hcpss.me/" value="' + cloakUrl.replace(/"/g, '&quot;') + '"></div>' +
      '<div class="settings-input-row"><div class="settings-input-label">Restore Title</div><div class="settings-input-sub">Title restored when you press / (default: Math Notes)</div><input type="text" class="settings-input" id="cloakRestoreSetting" placeholder="Math Notes" value="' + cloakRestore.replace(/"/g, '&quot;') + '"></div>' +
      '</div>' +
      // â”€â”€ Data Management â”€â”€
      '<div class="settings-section"><div class="settings-section-title">ðŸ—‘ï¸ Data Management</div>' +
      '<div class="settings-btn-row"><button type="button" class="settings-btn settings-btn-danger" id="clearHistoryBtn">Clear Chat History</button><button type="button" class="settings-btn settings-btn-danger" id="resetSettingsBtn">Reset All Settings</button></div>' +
      '</div>',
      [
        {
          text: 'Save & Close',
          type: 'confirm',
          action: function() {
            // Preferences
            autoSaveDrafts = document.getElementById('autoSaveSetting').checked;
            streamingEnabled = document.getElementById('streamingSetting').checked;
            enterToSend = document.getElementById('enterToSendSetting').checked;
            chatFontSize = parseFloat(document.getElementById('fontSizeSetting').value);
            localStorage.setItem('autoSaveDrafts', autoSaveDrafts);
            localStorage.setItem('streamingEnabled', streamingEnabled);
            localStorage.setItem('enterToSend', enterToSend);
            localStorage.setItem('chatFontSize', chatFontSize);
            applyChatFontSize(chatFontSize);
            // Cloak settings
            var ct = document.getElementById('cloakTitleSetting').value.trim();
            var cu = document.getElementById('cloakUrlSetting').value.trim();
            var cr = document.getElementById('cloakRestoreSetting').value.trim();
            if (ct) localStorage.setItem('airai_cloakTitle', ct); else localStorage.removeItem('airai_cloakTitle');
            if (cu) localStorage.setItem('airai_cloakUrl', cu); else localStorage.removeItem('airai_cloakUrl');
            if (cr) localStorage.setItem('airai_cloakRestoreTitle', cr); else localStorage.removeItem('airai_cloakRestoreTitle');
            hideModal();
          }
        }
      ]
    );

    // Attach color swatch listeners after modal is shown
    setTimeout(function() {
      var picker = document.getElementById('colorThemePicker');
      if (picker) {
        picker.addEventListener('click', function(e) {
          var swatch = e.target.closest('.color-swatch');
          if (!swatch) return;
          var theme = swatch.dataset.theme;
          applyColorTheme(theme);
          picker.querySelectorAll('.color-swatch').forEach(function(s) { s.classList.remove('active'); });
          swatch.classList.add('active');
        });
      }
      // Font size slider live preview
      var fontSlider = document.getElementById('fontSizeSetting');
      var fontValue = document.getElementById('fontSizeValue');
      if (fontSlider) {
        fontSlider.addEventListener('input', function() {
          fontValue.textContent = fontSlider.value + 'px';
          applyChatFontSize(parseFloat(fontSlider.value));
        });
      }
      // Clear history button
      var clearBtn = document.getElementById('clearHistoryBtn');
      if (clearBtn) {
        clearBtn.addEventListener('click', function() {
          if (confirm('Clear all saved chat history? This cannot be undone.')) {
            localStorage.removeItem('favoriteChats');
            var historyList = document.getElementById('historyList');
            if (historyList) historyList.innerHTML = '';
            clearBtn.textContent = 'Cleared!';
            setTimeout(function() { clearBtn.textContent = 'Clear Chat History'; }, 1500);
          }
        });
      }
      // Reset settings button
      var resetBtn = document.getElementById('resetSettingsBtn');
      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          if (confirm('Reset all settings to defaults? This cannot be undone.')) {
            localStorage.removeItem('colorTheme');
            localStorage.removeItem('autoSaveDrafts');
            localStorage.removeItem('streamingEnabled');
            localStorage.removeItem('enterToSend');
            localStorage.removeItem('chatFontSize');
            localStorage.removeItem('airai_cloakTitle');
            localStorage.removeItem('airai_cloakUrl');
            localStorage.removeItem('airai_cloakRestoreTitle');
            autoSaveDrafts = true;
            streamingEnabled = false;
            enterToSend = true;
            chatFontSize = 14.5;
            applyColorTheme('green');
            applyChatFontSize(14.5);
            resetBtn.textContent = 'Reset!';
            setTimeout(function() { hideModal(); }, 800);
          }
        });
      }
    }, 100);
  });
  
  // ============================================
  // HISTORY SEARCH
  // ============================================
  document.getElementById('historySearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const historyItems = document.querySelectorAll('.history-item');
    
    historyItems.forEach(item => {
      const title = item.querySelector('.history-item-title').textContent.toLowerCase();
      const preview = item.querySelector('.history-item-preview')?.textContent.toLowerCase() || '';
      
      if (title.includes(searchTerm) || preview.includes(searchTerm)) {
        item.style.display = 'block';
      } else {
        item.style.display = 'none';
      }
    });
  });
  
  // ============================================
  // HISTORY FILTERS
  // ============================================
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', function() {
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      this.classList.add('active');
      const filter = this.dataset.filter;
      renderHistory(filter);
    });
  });
  
  // ============================================
  // THEME TOGGLE
  // ============================================
  themeToggle.addEventListener('click', toggleTheme);
  
  // ============================================
  // SCROLL TO BOTTOM
  // ============================================
  scrollToBottom.addEventListener('click', scrollToBottomSmooth);
  chatMessages.addEventListener('scroll', throttledScrollCheck);
  
  // ============================================
  // MODAL CLOSE
  // ============================================
  modalOverlay.addEventListener('click', function(e) {
    if (e.target === modalOverlay) {
      if (pendingModel) {
        aiModelSelect.value = currentModel;
      }
      hideModal();
    }
  });
  
  document.getElementById('modalClose')?.addEventListener('click', hideModal);
  
  // ============================================
  // FILE UPLOAD
  // ============================================
  document.getElementById('fileUploadBtn').addEventListener('click', function() {
    document.getElementById('chat-input-file-upload').click();
  });
  
document.getElementById('chat-input-file-upload').addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  const caps = getCurrentModelCapabilities();
  
  // Double-check: Block if model has no file support (shouldn't happen with accept attribute)
  if (!caps.text && !caps.images && !caps.pdfs && !caps.videos && !caps.audio) {
    showError(`${caps.name} does not support file uploads.`);
    e.target.value = '';
    return;
  }
  
  let hasInvalidFiles = false;
  
  files.forEach(file => {
    // Check file size
    if (file.size > 10 * 1024 * 1024) {
      showError(`File too large: ${file.name} (max 10MB)`);
      hasInvalidFiles = true;
      return;
    }
    
    // Check compatibility (extra validation)
    const supported = isFileTypeSupported(file);
    if (!supported) {
      let fileType = 'file';
      if (file.type.startsWith('image/')) fileType = 'image';
      else if (file.type === 'application/pdf') fileType = 'PDF';
      else if (file.type.startsWith('video/')) fileType = 'video';
      else if (file.type.startsWith('audio/')) fileType = 'audio';
      
      showError(`${file.name}: ${caps.name} cannot process ${fileType}s. Only ${caps.text ? 'text files' : 'supported file types'} allowed.`);
      hasInvalidFiles = true;
      return;
    }
    
    // Add valid files
    uploadedFiles.push(file);
  });
  
  // Clear input and update preview
  e.target.value = '';
  
  if (uploadedFiles.length > 0) {
    updateFilePreview();
    
    // Show success message
    if (uploadedFiles.length === 1) {
      showSuccess(`File added: ${uploadedFiles[0].name}`);
    } else {
      showSuccess(`${uploadedFiles.length} files added`);
    }
  }
});
  
  // ============================================
  // VOICE INPUT
  // ============================================
  document.getElementById('voiceInputBtn').addEventListener('click', function() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      showError('Speech recognition not supported in this browser');
      return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    
    recognition.continuous = false;
    recognition.interimResults = false;
    
    this.classList.add('recording');
    
    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      chatInput.textContent = transcript;
      updateCharCounter();
      updateTokenCounter();
    };
    
    recognition.onerror = function(event) {
      showError('Voice recognition error: ' + event.error);
    };
    
    recognition.onend = function() {
      document.getElementById('voiceInputBtn').classList.remove('recording');
    };
    
    recognition.start();
  });
  
  // ============================================
  // MARKDOWN TOOLBAR
  // ============================================
  document.getElementById('markdownToggle').addEventListener('click', function() {
    const toolbar = document.getElementById('markdownToolbar');
    if (toolbar.style.display === 'none' || !toolbar.style.display) {
      toolbar.style.display = 'flex';
      this.classList.add('active');
    } else {
      toolbar.style.display = 'none';
      this.classList.remove('active');
    }
  });
  
  // ============================================
  // PROMPT SUGGESTIONS
  // ============================================
  document.getElementById('suggestionsBtn').addEventListener('click', function() {
    const suggestions = document.getElementById('promptSuggestions');
    suggestions.classList.toggle('show');
    this.classList.toggle('active');
  });
  
  document.querySelectorAll('.suggestion-item').forEach(item => {
    item.addEventListener('click', function() {
      chatInput.textContent = this.dataset.prompt;
      document.getElementById('promptSuggestions').classList.remove('show');
      document.getElementById('suggestionsBtn').classList.remove('active');
      chatInput.focus();
    });
  });
  
  // ============================================
  // KEYBOARD SHORTCUTS
  // ============================================
  document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K - Show shortcuts
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      const hint = document.getElementById('keyboardHint');
      hint.classList.toggle('show');
    }
    
    // Ctrl/Cmd + N - New chat
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
      e.preventDefault();
      document.getElementById('newChatBtn').click();
    }
    
    // Ctrl/Cmd + B - Toggle sidebar
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
      e.preventDefault();
      document.getElementById('toggleSidebar').click();
    }
    
    // Ctrl/Cmd + ` - Toggle console
    if ((e.ctrlKey || e.metaKey) && e.key === '`') {
      e.preventDefault();
      debugConsole.toggle();
    }
    
    // Escape - Close modals/overlays
    if (e.key === 'Escape') {
      if (modalOverlay.classList.contains('active')) {
        hideModal();
      }
      if (document.getElementById('sidebar').classList.contains('open')) {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('active');
      }
    }
  });
  // Model selector tooltip
aiModelSelect.addEventListener('mouseenter', showModelTooltip);
aiModelSelect.addEventListener('mouseleave', hideModelTooltip);
aiModelSelect.addEventListener('focus', showModelTooltip);
aiModelSelect.addEventListener('blur', hideModelTooltip);

// Update file button on model change
aiModelSelect.addEventListener('change', function() {
  updateFileUploadButton();
  showFileWarning();
}); // â† CLOSE DOMContentLoaded listener

// ============================================
// INITIALIZATION
// ============================================
// ============================================
// INITIALIZATION
// ============================================
window.addEventListener('load', function() {
    // Show auth screen
    showAuth();
    
    // Initialize debug console
    debugConsole.init();
    
    // Create particles
    createParticles();
    
    // Load theme preference
    loadThemePreference();
    
    // Load settings
    const savedAutoSave = localStorage.getItem('autoSaveDrafts');
    if (savedAutoSave !== null) {
      autoSaveDrafts = savedAutoSave === 'true';
    }
    
    const savedStreaming = localStorage.getItem('streamingEnabled');
    if (savedStreaming !== null) {
      streamingEnabled = savedStreaming === 'true';
    }

    const savedEnterToSend = localStorage.getItem('enterToSend');
    if (savedEnterToSend !== null) {
      enterToSend = savedEnterToSend === 'true';
    }

    const savedFontSize = localStorage.getItem('chatFontSize');
    if (savedFontSize !== null) {
      chatFontSize = parseFloat(savedFontSize);
      applyChatFontSize(chatFontSize);
    }

    // Load draft
    loadDraft();
    
    // Load favorites
    loadFavorites();
    
    // Update placeholder
    updatePlaceholder();
    
    // Filter models
    filterAIModels();
    
    // Check network status
    checkNetworkStatus();
    
    // *** CRITICAL FIX: Load model availability FIRST (includes staff lock) ***
    loadModelAvailability();
    
    // *** DO NOT call loadStaffLockStatus() - it's now included in loadModelAvailability() ***
    // loadStaffLockStatus(); // âŒ DELETE THIS LINE
    
    // Show model control button for staff
    if (isAuthenticated && userRole === 'staff') {
      const modelControlBtn = document.getElementById('modelControlBtn');
      if (modelControlBtn) {
        modelControlBtn.style.display = 'inline-flex';
      }
    }
    
    // Model Control Button
    document.getElementById('modelControlBtn')?.addEventListener('click', function() {
      showModelControlPanel();
    });
    
    // Initialize timestamps
    document.querySelectorAll('.message-timestamp').forEach(ts => {
      if (!ts.textContent) {
        ts.textContent = formatTimestamp();
      }
    });
    
    // Initialize file upload button state
    updateFileUploadButton();
    
    // Log initialization
    debugConsole.log('Application initialized successfully', 'success');
    debugConsole.log('Version: 2.0.0 Enhanced', 'info');
    debugConsole.log('Browser: ' + navigator.userAgent.split(' ').slice(-2).join(' '), 'info');
    
    // Performance monitoring
    const loadTime = performance.now();
    debugConsole.log(`Page loaded in ${loadTime.toFixed(0)}ms`, 'info');
    
    // Service Worker registration (PWA support)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(function(registration) {
        debugConsole.log('ServiceWorker registered', 'success');
      }).catch(function(error) {
        debugConsole.log('ServiceWorker registration failed: ' + error, 'warn');
      });
    }
    
    // *** CRITICAL FIX: Apply restriction state AFTER data loads ***
    setTimeout(() => {
      applyRestrictionState();
      debugConsole.log('Initial restriction state applied', 'info');
    }, 1500); // Increased delay to ensure backend data is loaded
});
  
  // ============================================
  // BEFORE UNLOAD
  // ============================================
  window.addEventListener('beforeunload', function(e) {
    if (conversationHistory.length > 0 && isAuthenticated) {
      const message = 'You have unsaved changes. Are you sure you want to leave?';
      e.returnValue = message;
      return message;
    }
  });
  
  // ============================================
  // VISIBILITY CHANGE
  // ============================================
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      debugConsole.log('App hidden', 'info');
    } else {
      debugConsole.log('App visible', 'info');
      checkNetworkStatus();
    }
  });
  
  // ============================================
  // VISIBILITY CHANGE
  // ============================================
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      debugConsole.log('App hidden', 'info');
    } else {
      debugConsole.log('App visible', 'info');
      checkNetworkStatus();
    }
  });
  /**
 * Load model availability from backend
 */
/**
 * Load model availability from backend
 */
/**
 * Load model availability from backend
 */
/**
 * Load model availability from backend - FIXED VERSION
 */
/**
 * Load model availability from backend - FIXED VERSION
 */
/**
 * Load model availability from backend - DEBUG VERSION
 */
/**
 * Load model availability from backend - CLEAN VERSION
 */
function loadModelAvailability() {
  const callbackName = 'modelAvailabilityCallback' + (callbackCounter++);
  window[callbackName] = function(data) {
    if (data.success) {
      modelAvailability = data.models;
      
      if (data.staffLockEnabled !== undefined) {
        staffLockEnabled = data.staffLockEnabled;
        debugConsole.log('Staff lock: ' + (staffLockEnabled ? 'ENABLED' : 'DISABLED'), 'info');
      }
      
      updateModelSelectUI();
      
      const availability = isModelAvailable(currentModel);
      
      if (availability === false) {
        const fallback = findFirstAllowedModel();
        if (fallback) {
          currentModel = fallback;
          const dropdown = document.getElementById('aiModel');
          if (dropdown) dropdown.value = fallback;
          updatePlaceholder();
          showWarning('Your model was disabled. Switched to ' + (MODEL_CAPABILITIES[fallback]?.name || fallback));
        } else {
          showError('No models available!');
        }
      }
      
      setTimeout(() => {
        applyRestrictionState();
      }, 300);
      
      debugConsole.log('Model availability loaded', 'success');
    } else {
      debugConsole.log('Failed to load: ' + data.error, 'error');
    }
    delete window[callbackName];
  };

  const script = document.createElement('script');
  script.src = MODEL_CONTROL_API + '?callback=' + callbackName + '&action=getModelStatus';
  script.onerror = function() {
    debugConsole.log('Failed to connect to model control API', 'error');
    delete window[callbackName];
  };
  document.body.appendChild(script);
}

/**
 * Load staff lock status
 */

/**
 * Check if model is available for user
 */
/**
 * Check if model is available for user
 */
/**
 * Check if model is available for user - FIXED VERSION
 */
/**
 * Check if model is available for user - FIXED VERSION
 */
/**
 * Check if model is available - FULL DEBUG VERSION
 */
/**
 * Check if model is available - CLEAN VERSION (NO DEBUG)
 */
function isModelAvailable(modelId) {
  // If data not loaded yet, assume available temporarily
  if (!modelAvailability || !modelAvailability[modelId]) {
    return true;
  }
  
  const modelStatus = modelAvailability[modelId];
  
  // PRIORITY 1: STAFF LOCK - THE ULTIMATE OVERRIDE
  if (staffLockEnabled && modelStatus.staffLocked) {
    return false; // HARD BLOCK
  }
  
  // PRIORITY 2: MODEL ENABLED CHECK
  if (modelStatus.enabled) {
    return true;
  }
  
  // PRIORITY 3: USER ROLE CHECK
  if (userRole === 'staff') {
    return 'staff-warning';
  }
  
  return false;
}

/**
 * Update model select UI with availability
 */
/**
 * Update model select UI with availability
 */
function updateModelSelectUI() {
  const select = document.getElementById('aiModel');
  if (!select) return;
  
  const options = select.querySelectorAll('option');
  
  options.forEach(option => {
    const modelId = option.value;
    const availability = isModelAvailable(modelId);
    
    // Remove all classes first
    option.classList.remove('model-disabled', 'model-staff-locked', 'model-staff-only');
    option.disabled = false;
    
    // Remove all indicators
    option.textContent = option.textContent.replace(' ðŸ”’', '').replace(' âš ï¸', '').replace(' ðŸ”´', '');
    
    const modelStatus = modelAvailability[modelId];
    
    // Check if staff-locked (RED)
    if (staffLockEnabled && modelStatus?.staffLocked) {
      option.classList.add('model-staff-locked');
      option.disabled = true;
      if (!option.textContent.includes('ðŸ”´')) {
        option.textContent = option.textContent + ' ðŸ”´';
      }
    }
    // Check if just disabled (YELLOW)
    else if (availability === false) {
      option.classList.add('model-disabled');
      option.disabled = true;
      if (!option.textContent.includes('ðŸ”’')) {
        option.textContent = option.textContent + ' ðŸ”’';
      }
    }
    // Staff warning (can still use)
    else if (availability === 'staff-warning') {
      option.classList.add('model-staff-only');
      option.disabled = false;
      if (!option.textContent.includes('âš ï¸')) {
        option.textContent = option.textContent + ' âš ï¸';
      }
    }
  });
  
  // Update send button state
  const availability = isModelAvailable(currentModel);
  const sendBtn = document.querySelector('.send-button-enhanced');
  const input = document.getElementById('chatInput');
  
  if (availability === false) {
    if (sendBtn) sendBtn.disabled = true;
    if (input) input.setAttribute('contenteditable', 'false');
  } else {
    if (sendBtn) sendBtn.disabled = false;
    if (input) input.setAttribute('contenteditable', 'true');
  }
}

/**
 * Check model before sending message
 */
function checkModelBeforeSending() {
  const availability = isModelAvailable(currentModel);
  
  if (availability === false) {
    showError('This model is currently disabled. Please select another model.');
    return false;
  }
  
  if (availability === 'staff-warning') {
    return new Promise((resolve) => {
      showModal(
        'Model Restricted',
        'This model is currently disabled. As staff, you can still use it. Continue?',
        [
          { text: 'Cancel', type: 'cancel', action: () => { hideModal(); resolve(false); } },
          { text: 'Continue', type: 'confirm', action: () => { hideModal(); resolve(true); } }
        ]
      );
    });
  }
  
  return true;
}

/**
 * Show model control panel (Staff only)
 */
/**
 * Show model control panel (Staff only)
 */
/**
 * Show model control panel (Staff only) - UPDATED WITH WIDER MODAL
 */
/**
 * Show model control panel (Staff only) - WITH WIDER MODAL BOX
 * Replace your existing showModelControlPanel() function with this
 */
/**
 * Show model control panel (Staff only) - DEBUG VERSION
 * Replace your existing showModelControlPanel() function with this temporarily
 */
/**
 * Show model control panel (Staff only) - FINAL VERSION (No Debug)
 * Replace your showModelControlPanel() function with this
 */
function showModelControlPanel() {
  if (userRole !== 'staff') {
    showError('Only staff can access model controls');
    return;
  }
  
  showLoading('Loading model controls...');
  
  const callbackName = 'modelControlCallback' + (callbackCounter++);
  window[callbackName] = function(data) {
    hideLoading();
    
    if (!data.success) {
      showError('Failed to load model controls: ' + data.error);
      delete window[callbackName];
      return;
    }
    
    const models = data.models;
    let controlHTML = '<div class="model-control-panel">';
    
    // Staff lock toggle (only for KodyCookie)
    if (currentUser === 'KodyCookie') {
      controlHTML += `
        <div class="control-section staff-lock-section">
          <div class="control-section-header">
            <h3>ðŸ” Staff Lock (KodyCookie Only)</h3>
            <p>When enabled, staff cannot bypass disabled models</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="globalStaffLock" ${staffLockEnabled ? 'checked' : ''}>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div style="height: 2px; background: var(--border-primary); margin: 20px 0;"></div>
      `;
    }
    
    controlHTML += '<div class="control-section"><h3>Model Availability</h3><div class="model-control-grid">';
    
    // Group models
    const mainModels = ['gemini', 'groq', 'cerebra', 'openai', 'deepseek', 'qwen', 'mistral', 'nous', 'tongyi', 'trinity', 'glm', 'nova', 'airai'];
    
    // CB Models list
    const cbModels = [
      'llama3.1-8b',
      'llama-3.3-70b',
      'gpt-oss-120b',
      'qwen-3-32b',
      'qwen-3-235b-a22b-instruct-2507',
      'zai-glm-4.6',
      'zai-glm-4.7'
    ];
    
    // Filter out main and CB models to get extra models (OpenRouter)
    const extraModels = Object.keys(models).filter(m => !mainModels.includes(m) && !cbModels.includes(m));
    
    // Main models
    controlHTML += '<div class="model-group"><h4>Main Models</h4>';
    mainModels.forEach(modelId => {
      if (models[modelId]) {
        controlHTML += createModelControlRow(modelId, models[modelId]);
      }
    });
    controlHTML += '</div>';
    
    // CB Models
    controlHTML += '<div class="model-group"><h4>CB Models (Cerebras)</h4>';
    cbModels.forEach(modelId => {
      if (models[modelId]) {
        controlHTML += createModelControlRow(modelId, models[modelId]);
      }
    });
    controlHTML += '</div>';
    
    // Extra models (OpenRouter)
    if (extraModels.length > 0) {
      controlHTML += '<div class="model-group"><h4>Extra Models (OpenRouter)</h4>';
      extraModels.forEach(modelId => {
        if (models[modelId]) {
          controlHTML += createModelControlRow(modelId, models[modelId]);
        }
      });
      controlHTML += '</div>';
    }
    
    controlHTML += '</div></div></div>';
    
    modalTitle.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
      Model Control Panel
    `;
    modalMessage.innerHTML = controlHTML;
    modalButtons.innerHTML = '';
    modalInputContainer.innerHTML = '';
    
    // Add class to modal overlay to make it wider
    const modalOverlay = document.getElementById('modalOverlay');
    if (modalOverlay) {
      modalOverlay.classList.add('model-control-active');
    }
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'modal-button confirm';
    closeBtn.textContent = 'Close';
    closeBtn.onclick = () => {
      // Remove wider class on close
      const modalOverlay = document.getElementById('modalOverlay');
      if (modalOverlay) {
        modalOverlay.classList.remove('model-control-active');
      }
      loadModelAvailability(); // Reload
      hideModal();
    };
    modalButtons.appendChild(closeBtn);
    
    modalOverlay.classList.add('active');
    
    // Attach event listeners
    attachModelControlListeners();
    
    delete window[callbackName];
  };

  const script = document.createElement('script');
  script.src = MODEL_CONTROL_API + '?callback=' + callbackName + '&action=getModelStatus';
  script.onerror = function() {
    hideLoading();
    showError('Failed to connect to model control API');
    delete window[callbackName];
  };
  document.body.appendChild(script);
}

/**
 * Create model control row HTML
 */
function createModelControlRow(modelId, modelData) {
  const modelName = MODEL_CAPABILITIES[modelId]?.name || modelId;
  const enabled = modelData.enabled;
  const staffLocked = modelData.staffLocked;
  
  return `
    <div class="model-control-row" data-model="${modelId}">
      <div class="model-control-info">
        <div class="model-control-name">${modelName}</div>
        <div class="model-control-id">${modelId}</div>
      </div>
      <div class="model-control-toggles">
        <label class="model-control-toggle">
          <span>Enabled</span>
          <label class="toggle-switch">
            <input type="checkbox" class="model-enabled-toggle" data-model="${modelId}" ${enabled ? 'checked' : ''}>
            <span class="toggle-slider"></span>
          </label>
        </label>
        <label class="model-control-toggle">
          <span>Staff Lock ðŸ”’</span>
          <label class="toggle-switch">
            <input type="checkbox" class="model-staff-lock-toggle" data-model="${modelId}" ${staffLocked ? 'checked' : ''}>
            <span class="toggle-slider"></span>
          </label>
        </label>
      </div>
    </div>
  `;
}

/**
 * Attach event listeners to model controls
 */
function attachModelControlListeners() {
  // Global staff lock (KodyCookie only)
  const globalStaffLock = document.getElementById('globalStaffLock');
  if (globalStaffLock) {
    globalStaffLock.addEventListener('change', function() {
      updateGlobalStaffLock(this.checked);
    });
  }
  
  // Model enabled toggles
  document.querySelectorAll('.model-enabled-toggle').forEach(toggle => {
    toggle.addEventListener('change', function() {
      const modelId = this.dataset.model;
      const enabled = this.checked;
      updateModelStatus(modelId, enabled, null);
    });
  });
  
  // Model staff lock toggles
  document.querySelectorAll('.model-staff-lock-toggle').forEach(toggle => {
    toggle.addEventListener('change', function() {
      const modelId = this.dataset.model;
      const staffLocked = this.checked;
      updateModelStatus(modelId, null, staffLocked);
    });
  });
}

/**
 * Update global staff lock
 */
/**
 * Update global staff lock
 */
/**
 * Update global staff lock
 */
/**
 * Update global staff lock
 */
/**
 * Update global staff lock - FIXED VERSION
 */
/**
 * Update global staff lock - FIXED VERSION
 */
/**
 * Update global staff lock - DEBUG VERSION
 */
/**
 * Update global staff lock - CLEAN VERSION
 */
function updateGlobalStaffLock(enabled) {
  const callbackName = 'updateStaffLockCallback' + (callbackCounter++);
  window[callbackName] = function(data) {
    if (data.success) {
      staffLockEnabled = data.staffLockEnabled;
      
      showSuccess('Staff lock ' + (enabled ? 'enabled' : 'disabled'));
      debugConsole.log('Staff lock updated: ' + enabled, 'success');
      
      setTimeout(() => {
        loadModelAvailability();
      }, 500);
      
    } else {
      showError('Failed to update staff lock: ' + data.error);
      const toggle = document.getElementById('globalStaffLock');
      if (toggle) toggle.checked = !enabled;
    }
    delete window[callbackName];
  };

  const script = document.createElement('script');
  script.src = MODEL_CONTROL_API + '?callback=' + callbackName + 
               '&action=updateStaffLock&username=' + encodeURIComponent(currentUser) + 
               '&enabled=' + enabled;
  script.onerror = function() {
    showError('Failed to connect to API');
    const toggle = document.getElementById('globalStaffLock');
    if (toggle) toggle.checked = !enabled;
    delete window[callbackName];
  };
  document.body.appendChild(script);
}

/**
 * Update model status
 */
function updateModelStatus(modelId, enabled, staffLocked) {
  const callbackName = 'updateModelCallback' + (callbackCounter++);
  window[callbackName] = function(data) {
    if (data.success) {
      modelAvailability = data.models;
      updateModelSelectUI();
      
      if (enabled !== null) {
        showSuccess('Model ' + (enabled ? 'enabled' : 'disabled'));
      }
      if (staffLocked !== null) {
        showSuccess('Staff lock ' + (staffLocked ? 'enabled' : 'disabled') + ' for this model');
      }
      
      debugConsole.log('Model status updated: ' + modelId, 'success');
    } else {
      showError('Failed to update model: ' + data.error);
      // Reload to revert UI
      showModelControlPanel();
    }
    delete window[callbackName];
  };

  let params = 'callback=' + callbackName + 
               '&action=updateModelStatus' +
               '&username=' + encodeURIComponent(currentUser) +
               '&model=' + encodeURIComponent(modelId);
  
  if (enabled !== null) {
    params += '&enabled=' + enabled;
  } else {
    // Get current enabled status
    params += '&enabled=' + (modelAvailability[modelId]?.enabled || false);
  }
  
  if (staffLocked !== null) {
    params += '&staffLocked=' + staffLocked;
  } else {
    // Get current staff lock status
    params += '&staffLocked=' + (modelAvailability[modelId]?.staffLocked || false);
  }

  const script = document.createElement('script');
  script.src = MODEL_CONTROL_API + '?' + params;
  script.onerror = function() {
    showError('Failed to connect to API');
    delete window[callbackName];
  };
  document.body.appendChild(script);
}

/**
 * Check if user can load chat with specific model
 */
function canLoadChatModel(modelId) {
  const availability = isModelAvailable(modelId);
  
  if (availability === false) {
    return false;
  }
  
  if (availability === 'staff-warning') {
    return 'warning';
  }
  
  return true;
}
function showBlockerOverlay(message = 'This model is disabled for you.') {
  let ov = document.getElementById('blockerOverlay');
  if (!ov) {
    ov = document.createElement('div');
    ov.id = 'blockerOverlay';
    ov.className = 'blocker-overlay';
    ov.innerHTML = `<div class="msg">${message}</div>`;
    
    // *** CRITICAL: Block ALL events from passing through ***
    ov.addEventListener('click', function(e){
      e.stopPropagation();
      e.preventDefault();
      return false;
    }, {capture: true});
    
    ov.addEventListener('mousedown', function(e){
      e.stopPropagation();
      e.preventDefault();
      return false;
    }, {capture: true});
    
    ov.addEventListener('keydown', function(e){
      e.stopPropagation();
      e.preventDefault();
      return false;
    }, {capture: true});
    
    document.body.appendChild(ov);
  } else {
    ov.querySelector('.msg').textContent = message;
  }
  ov.classList.add('show');
}

function hideBlockerOverlay() {
  const ov = document.getElementById('blockerOverlay');
  if (ov) ov.classList.remove('show');
}

/* Helper to find first allowed model option */
/**
 * Find first allowed model for user
 */
function findFirstAllowedModel() {
  const select = document.getElementById('aiModel');
  if (!select) return 'cerebra'; // fallback
  
  const options = select.querySelectorAll('option');
  
  for (let i = 0; i < options.length; i++) {
    const modelId = options[i].value;
    const availability = isModelAvailable(modelId);
    
    // Accept enabled models or staff-warning models (if user is staff)
    if (availability === true || (availability === 'staff-warning' && userRole === 'staff')) {
      return modelId;
    }
  }
  
  return null;
}

/* Improve updateModelSelectUI: ensure selected disabled models are reverted */
const original_updateModelSelectUI = updateModelSelectUI;
updateModelSelectUI = function() {
  original_updateModelSelectUI();

  // extra enforcement: if currentModel is disabled for this user, revert and warn
  const select = document.getElementById('aiModel');
  if (!select) return;
  const currentOpt = select.querySelector(`option[value="${select.value}"]`);
  if (currentOpt) {
    const availability = isModelAvailable(select.value);
    if (availability === false) {
      // revert to a safe model
      const fallback = findFirstAllowedModel();
      if (fallback) {
        select.value = fallback;
        currentModel = fallback;
      }
      showError('That model is disabled for your account.');
      showBlockerOverlay('Model disabled â€” you cannot interact with this model.');
      setTimeout(hideBlockerOverlay, 1500); // short visual block
    } else {
      hideBlockerOverlay();
    }
  }
};

/* Add onchange handler that blocks normal users and prompts staff immediately.
   This reduces the chance of a user selecting and using a disabled model before send. */
document.addEventListener('DOMContentLoaded', () => {
  const sel = document.getElementById('aiModel');
  if (!sel) return;

  // keep track of last known good value
  let lastGood = sel.value;

  sel.addEventListener('change', function(e) {
    const newModel = this.value;
    const availability = isModelAvailable(newModel);

   if (availability === false) {
  showDisabledOnlyModal(() => {
    this.value = lastGood;
  });
  return;
}

    if (availability === 'staff-warning') {
      // staff-only behavior: show a modal confirm before switching
      if (userRole === 'staff') {
        showModal(
          'Model Restricted',
          'This model is currently disabled. As staff, you can still select it. Continue?',
          [
            { text: 'Cancel', type: 'cancel', action: () => { hideModal(); sel.value = lastGood; } },
            { text: 'Continue', type: 'confirm', action: () => {
                hideModal();
                lastGood = newModel;
                currentModel = newModel;
                updatePlaceholder && updatePlaceholder();
              }
            }
          ]
        );
        return;
      } else {
        // non-staff shouldn't reach here, but if they do, revert
        showError('This model is restricted.');
        this.value = lastGood;
        return;
      }
    }

    // allowed model
    lastGood = newModel;
    currentModel = newModel;
    hideBlockerOverlay();
    updatePlaceholder && updatePlaceholder();
  });

  // also intercept clicks/keyboard that might trigger sending (extra safety)
  const sendBtn = document.querySelector('.send-button-enhanced, #sendBtn');
  if (sendBtn) {
    sendBtn.addEventListener('click', async (ev) => {
      const availability = isModelAvailable(currentModel);
     if (availability === false) {
  ev.preventDefault();
  ev.stopPropagation();
  showDisabledOnlyModal();
  return;
}

      if (availability === 'staff-warning' && userRole === 'staff') {
        // double-check confirmation at send time (defense in depth)
        const confirmed = await new Promise(resolve => {
          showModal(
            'Model Restricted',
            'This model is currently disabled. As staff, you can still use it. Continue?',
            [
              { text: 'Cancel', type: 'cancel', action: () => { hideModal(); resolve(false); } },
              { text: 'Continue', type: 'confirm', action: () => { hideModal(); resolve(true); } }
            ]
          );
        });
        if (!confirmed) {
          ev.preventDefault(); ev.stopPropagation();
          return;
        }
      }
    }, {capture: true});
  }
});
function showDisabledOnlyModal(onClose) {
  showModal(
    'Model Disabled',
    'This model is currently disabled.',
    [
      {
        text: 'Cancel',
        type: 'cancel',
        action: () => {
          hideModal();
          if (typeof onClose === 'function') onClose();
        }
      }
    ]
  );
}

/**
 * Apply restriction state to UI - IMPROVED VERSION
 */
/**
 * Apply restriction state to UI - IMPROVED VERSION
 */
/**
 * Apply restriction state to UI - DEBUG VERSION
 */
/**
 * Apply restriction state to UI - CLEAN VERSION
 */
function applyRestrictionState() {
  const availability = isModelAvailable(currentModel);
  const shouldBlock = (availability === false);
  
  if (shouldBlock) {
    blockChatInteraction();
    
    const modelStatus = modelAvailability[currentModel];
    if (staffLockEnabled && modelStatus?.staffLocked) {
      showBlockerOverlay('ðŸ”’ STAFF LOCK ACTIVE - This model is locked for everyone');
      debugConsole.log('Chat BLOCKED by staff lock', 'error');
    } else {
      showBlockerOverlay('This model is disabled for your account');
      debugConsole.log('Chat BLOCKED - model disabled', 'warn');
    }
  } else {
    unblockChatInteraction();
    debugConsole.log('Chat interaction ALLOWED', 'success');
  }
}
/**
 * HARD BLOCK - Disable all interaction with chat
 */
function blockChatInteraction() {
  const chatInput = document.getElementById('chatInput');
  const sendButton = document.querySelector('.send-button-enhanced');
  const fileUploadBtn = document.getElementById('fileUploadBtn');
  const voiceInputBtn = document.getElementById('voiceInputBtn');
  const chatContainer = document.querySelector('.chat-container');
  
  // Disable input
  if (chatInput) {
    chatInput.setAttribute('contenteditable', 'false');
    chatInput.style.pointerEvents = 'none';
    chatInput.style.opacity = '0.3';
  }
  
  // Disable send button
  if (sendButton) {
    sendButton.disabled = true;
    sendButton.style.pointerEvents = 'none';
    sendButton.style.opacity = '0.3';
  }
  
  // Disable all toolbar buttons
  if (fileUploadBtn) fileUploadBtn.disabled = true;
  if (voiceInputBtn) voiceInputBtn.disabled = true;
  
  // Apply blur
  if (chatContainer) {
    chatContainer.classList.add('restricted-blur');
  }
  
  // Show blocker
  showBlockerOverlay('This model is disabled.');
}

/**
 * UNBLOCK - Enable interaction
 */
function unblockChatInteraction() {
  const chatInput = document.getElementById('chatInput');
  const sendButton = document.querySelector('.send-button-enhanced');
  const fileUploadBtn = document.getElementById('fileUploadBtn');
  const voiceInputBtn = document.getElementById('voiceInputBtn');
  const chatContainer = document.querySelector('.chat-container');
  
  // Enable input
  if (chatInput) {
    chatInput.setAttribute('contenteditable', 'true');
    chatInput.style.pointerEvents = 'auto';
    chatInput.style.opacity = '1';
  }
  
  // Enable send button
  if (sendButton) {
    sendButton.disabled = false;
    sendButton.style.pointerEvents = 'auto';
    sendButton.style.opacity = '1';
  }
  
  // Enable toolbar buttons
  if (fileUploadBtn) fileUploadBtn.disabled = false;
  if (voiceInputBtn) voiceInputBtn.disabled = false;
  
  // Remove blur
  if (chatContainer) {
    chatContainer.classList.remove('restricted-blur');
  }
  
  // Hide blocker
  hideBlockerOverlay();
}
</script>

<script src="../config.js"></script>
</body>

</html>

